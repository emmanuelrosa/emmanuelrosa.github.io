


<!DOCTYPE html>
<html class="no-js" lang="en" prefix="og: http://ogp.me/ns#>
<head>
  <meta charset="utf-8">
  <title>The State of Things - EmmanuelRosa.com</title>
  <meta property="author" content="Emmanuel Rosa">

  
    <meta name="description" content="Remaking the software state machine for dynamic programming languages.">
  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="canonical" href="http://emmanuelrosa.com/articles/the-state-of-things/">
  <link href="http://emmanuelrosa.com/images/favicon-04b8a331dc172dc2876810a77fddf8b0.png" type="image/png" rel="icon">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="article">
  <meta property="og:url" content="http://emmanuelrosa.com/articles/the-state-of-things/">
  <meta property="og:title" content="The State of Things - EmmanuelRosa.com">
  <meta property="og:description" content="Remaking the software state machine for dynamic programming languages.">
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="EmmanuelRosa.com" />
  <meta property="og:updated_time" content="2015-12-22T10:31:21-05:00" />
  <meta property="og:image" content="http://emmanuelrosa.comhttp://emmanuelrosa.com/images/logo-56fc9f8a57dedecb5c6d1e59cd1c8c20.png" />

  <script src="http://emmanuelrosa.com/javascripts/libs/jquery/jquery-2.1.3.min-32015dd42e9582a80a84736f5d9a44d7.js"></script>
<script src="http://emmanuelrosa.com/javascripts/libs/jquery/jquery.cookie-d5528dde0006c78be04817327c2f9b6f.js"></script>

<link href="http://emmanuelrosa.com/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="http://emmanuelrosa.com/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="http://emmanuelrosa.com/assets/font-awesome/css/font-awesome.min.css">


  
  <link href="http://emmanuelrosa.com/stylesheets/screen-e4fc71c55515b4737f869e41df2c9bec.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69493301-1', 'auto');
    ga('send', 'pageview');

  </script>


  <!-- Begin Cookie Consent plugin by Silktide - http://silktide.com/cookieconsent -->
<script type="text/javascript">
    window.cookieconsent_options = {"message":"Of course this website uses cookies. It would be so bland without them.","dismiss":"I'm so baked","learnMore":"What the frack?","link":"https://www.google.com/policies/privacy/partners/","theme":"dark-bottom"};
</script>

<script type="text/javascript" src="http://emmanuelrosa.com/javascripts/cookieconsent.min-b4176fc70afe0c55107683f38e47d71b.js"></script>
<!-- End Cookie Consent plugin -->

</head>


  
  <body 
     >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://emmanuelrosa.com/">EmmanuelRosa.com</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li >
                    <a href="http://emmanuelrosa.com/archives/"><span class="fa fa-archive hidden-sm hidden-md hidden-lg"></span> Articles</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
            <div class="row">
                <div class="page-content col-md-12">
                    
<article class="hentry" role="article" itemscope itemtype="http://schema.org/BlogPosting">
  <!-- http://schema.org meta-data -->
  <meta itemscope itemprop="mainEntityOfPage" itemType="https://schema.org/WebPage" itemid="http://emmanuelrosa.com/articles/the-state-of-things/"/>
  <meta itemprop="name" content="The State of Things" />
  <meta itemprop="author" content="Emmanuel Rosa" />
  <meta itemprop="publisher" content="Emmanuel Rosa" />
  <meta itemprop="datePublished" content="Mon Dec 14 16:14:00 EST 2015" />
  <meta itemprop="dateModified" content="Tue Dec 22 10:31:21 EST 2015" />
  <meta itemprop="description" content="Remaking the software state machine for dynamic programming languages." />
  <meta itemprop="url" content="http://emmanuelrosa.com/articles/the-state-of-things/" />
  <meta itemprop="image" content="http://emmanuelrosa.com/images/logo-56fc9f8a57dedecb5c6d1e59cd1c8c20.png" />

  
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    <h1 class="entry-title" itemprop="name headline">The State of Things
        
    </h1>
  </header>

<div class="entry-content clearfix" itemprop="articleBody description"><p>As a programmer you've either yet to, or have already, coded a state machine; for the remainder of this article, I'll assume the latter. First, a little bit of history.</p>
<h2>The monkey-patch</h2>
<p>In its most simplistic implementation, a state machine is coded as a series of <em>flags</em>: variables whose combination of values <em>mean</em> something.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">double</span> <span class="n">currency</span>
</span><span class='line'><span class="kt">int</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Take action based on current state.</span>
</span><span class='line'><span class="k">if</span><span class="o">(</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// No currency state</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">currency</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Has currency state</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Sold out state</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h2>The proverbial wheel</h2>
<p>A step above this crude monkey-patched state machine is initializing and maintaining the current state in a variable.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SOLD_OUT</span><span class="o">,</span>
</span><span class='line'>    <span class="n">NO_CURRENCY</span><span class="o">,</span>
</span><span class='line'>    <span class="n">HAS_CURRENCY</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">State</span> <span class="n">state</span>
</span><span class='line'><span class="kt">double</span> <span class="n">currency</span>
</span><span class='line'><span class="kt">int</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Set initial state.</span>
</span><span class='line'><span class="k">if</span><span class="o">(</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">NO_CURRENCY</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">currency</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Take action based on current state.</span>
</span><span class='line'><span class="k">switch</span><span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOLD_OUT:</span>
</span><span class='line'>        <span class="c1">// Do something.</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Then came along the state machine design pattern, which for the purpose of this article I'll refer to as a compile-time state machine.</p>
<h1>The compile-time state machine</h1>
<p>You may be onto me. I've hinted at my yet-to-be-revealed hypothesis. But, as I was saying, the state machine design pattern suggests representing each state as a class and having a mechanism to maintain the current state and context.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="yes"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="320px" style="width:437px;height:320px;" version="1.1" viewBox="0 0 437 320" width="437px"><defs><filter height="300%" id="f1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><rect fill="#FEFECE" filter="url(#f1)" height="73.9102" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="6" y="129" /><ellipse cx="21" cy="145" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M23.9731,150.6431 Q23.3921,150.9419 22.7529,151.0913 Q22.1138,151.2407 21.4082,151.2407 Q18.9014,151.2407 17.5815,149.5889 Q16.2617,147.937 16.2617,144.8159 Q16.2617,141.6865 17.5815,140.0347 Q18.9014,138.3828 21.4082,138.3828 Q22.1138,138.3828 22.7612,138.5322 Q23.4087,138.6816 23.9731,138.9805 L23.9731,141.7031 Q23.3423,141.1221 22.7488,140.8523 Q22.1553,140.5825 21.5244,140.5825 Q20.1797,140.5825 19.4949,141.6492 Q18.8101,142.7158 18.8101,144.8159 Q18.8101,146.9077 19.4949,147.9744 Q20.1797,149.041 21.5244,149.041 Q22.1553,149.041 22.7488,148.7712 Q23.3423,148.5015 23.9731,147.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="44" x="35" y="149.5352">Context</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="81" y1="161" y2="161" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="81" y1="169" y2="169" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="12" y="183.6348">handle()</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="50" x="12" y="196.5898">setState()</text><rect fill="#FEFECE" filter="url(#f1)" height="48" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="12" y="263" /><ellipse cx="27" cy="279" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M29.9731,284.6431 Q29.3921,284.9419 28.7529,285.0913 Q28.1138,285.2407 27.4082,285.2407 Q24.9014,285.2407 23.5815,283.5889 Q22.2617,281.937 22.2617,278.8159 Q22.2617,275.6865 23.5815,274.0347 Q24.9014,272.3828 27.4082,272.3828 Q28.1138,272.3828 28.7612,272.5322 Q29.4087,272.6816 29.9731,272.9805 L29.9731,275.7031 Q29.3423,275.1221 28.7488,274.8523 Q28.1553,274.5825 27.5244,274.5825 Q26.1797,274.5825 25.4949,275.6492 Q24.8101,276.7158 24.8101,278.8159 Q24.8101,280.9077 25.4949,281.9744 Q26.1797,283.041 27.5244,283.041 Q28.1553,283.041 28.7488,282.7712 Q29.3423,282.5015 29.9731,281.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="32" x="41" y="283.5352">Client</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="13" x2="75" y1="295" y2="295" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="13" x2="75" y1="303" y2="303" /><rect fill="#FEFECE" filter="url(#f1)" height="60.9551" style="stroke: #A80036; stroke-width: 1.5;" width="60" x="121" y="8" /><ellipse cx="136" cy="24" fill="#B4A7E5" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M131.9277,19.7651 L131.9277,17.6069 L139.3071,17.6069 L139.3071,19.7651 L136.8418,19.7651 L136.8418,27.8418 L139.3071,27.8418 L139.3071,30 L131.9277,30 L131.9277,27.8418 L134.3931,27.8418 L134.3931,19.7651 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="28" x="150" y="28.5352">State</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="122" x2="180" y1="40" y2="40" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="122" x2="180" y1="48" y2="48" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="127" y="62.6348">handle()</text><polygon fill="#FBFB77" filter="url(#f1)" points="216,26,216,51.3105,428,51.3105,428,36,418,26,216,26" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="#FBFB77" points="216,26,216,34.5,181.059,38.5,216,42.5,216,51.3105,428,51.3105,428,36,418,26,216,26" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="418" x2="418" y1="26" y2="36" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="428" x2="418" y1="36" y2="36" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="222" y="43.5684">handle() has access to context</text><rect fill="#FEFECE" filter="url(#f1)" height="60.9551" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="117" y="135.5" /><ellipse cx="132" cy="151.5" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M134.9731,157.1431 Q134.3921,157.4419 133.7529,157.5913 Q133.1138,157.7407 132.4082,157.7407 Q129.9014,157.7407 128.5815,156.0889 Q127.2617,154.437 127.2617,151.3159 Q127.2617,148.1865 128.5815,146.5347 Q129.9014,144.8828 132.4082,144.8828 Q133.1138,144.8828 133.7612,145.0322 Q134.4087,145.1816 134.9731,145.4805 L134.9731,148.2031 Q134.3423,147.6221 133.7488,147.3523 Q133.1553,147.0825 132.5244,147.0825 Q131.1797,147.0825 130.4949,148.1492 Q129.8101,149.2158 129.8101,151.3159 Q129.8101,153.4077 130.4949,154.4744 Q131.1797,155.541 132.5244,155.541 Q133.1553,155.541 133.7488,155.2712 Q134.3423,155.0015 134.9731,154.4204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="36" x="146" y="156.0352">StateA</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="118" x2="184" y1="167.5" y2="167.5" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="118" x2="184" y1="175.5" y2="175.5" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="123" y="190.1348">handle()</text><rect fill="#FEFECE" filter="url(#f1)" height="60.9551" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="220.5" y="135.5" /><ellipse cx="235.5" cy="151.5" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M238.4731,157.1431 Q237.8921,157.4419 237.2529,157.5913 Q236.6138,157.7407 235.9082,157.7407 Q233.4014,157.7407 232.0815,156.0889 Q230.7617,154.437 230.7617,151.3159 Q230.7617,148.1865 232.0815,146.5347 Q233.4014,144.8828 235.9082,144.8828 Q236.6138,144.8828 237.2612,145.0322 Q237.9087,145.1816 238.4731,145.4805 L238.4731,148.2031 Q237.8423,147.6221 237.2488,147.3523 Q236.6553,147.0825 236.0244,147.0825 Q234.6797,147.0825 233.9949,148.1492 Q233.3101,149.2158 233.3101,151.3159 Q233.3101,153.4077 233.9949,154.4744 Q234.6797,155.541 236.0244,155.541 Q236.6553,155.541 237.2488,155.2712 Q237.8423,155.0015 238.4731,154.4204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="35" x="249.5" y="156.0352">StateB</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="221.5" x2="286.5" y1="167.5" y2="167.5" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="221.5" x2="286.5" y1="175.5" y2="175.5" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="226.5" y="190.1348">handle()</text><path d="M44,203.027 C44,222.4547 44,245.8588 44,262.8505 " fill="none" style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 7.0,7.0;" /><path d="M117.081,79.284 C106.413,91.796 94.5402,105.722 83.5188,118.648 " fill="none" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="#A80036" points="74.9017,128.755,81.8383,126.7844,82.6872,119.6234,75.7506,121.594,74.9017,128.755" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="#A80036" points="125.642,69.242,116.7591,73.4957,122.3981,73.0469,122.8469,78.6859,125.642,69.242" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="122.3981" x2="117.2085" y1="73.0469" y2="79.134" /><path d="M151,89.447 C151,105.047 151,121.749 151,135.472 " fill="none" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="none" points="144,89.242,151,69.242,158,89.242,144,89.242" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M188.311,84.961 C202.124,101.792 217.415,120.423 229.766,135.472 " fill="none" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="none" points="182.687,89.143,175.41,69.242,193.509,80.261,182.687,89.143" style="stroke: #A80036; stroke-width: 1.0;" /></g></svg></p>
<p>When the state machine is used, it delegates work to the current state.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="yes"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="184px" style="width:225px;height:184px;" version="1.1" viewBox="0 0 225 184" width="225px"><defs><filter height="300%" id="f1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="37" x2="37" y1="38.4883" y2="146.4199" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="112" x2="112" y1="38.4883" y2="146.4199" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="194.5" x2="194.5" y1="38.4883" y2="146.4199" /><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="23.5352">Client</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="145.4199" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="165.9551">Client</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="76" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="83" y="23.5352">Context</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="76" y="145.4199" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="83" y="165.9551">Context</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="48" x="168.5" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="175.5" y="23.5352">State</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="48" x="168.5" y="145.4199" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="175.5" y="165.9551">State</text><polygon fill="#A80036" points="100.5,65.4883,110.5,69.4883,100.5,73.4883,104.5,69.4883" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="37" x2="106.5" y1="69.4883" y2="69.4883" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="44" y="65.0566">handle()</text><polygon fill="#A80036" points="182.5,94.7988,192.5,98.7988,182.5,102.7988,186.5,98.7988" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="112.5" x2="188.5" y1="98.7988" y2="98.7988" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="119.5" y="94.3672">handle()</text><polygon fill="#A80036" points="123.5,124.1094,113.5,128.1094,123.5,132.1094,119.5,128.1094" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="117.5" x2="193.5" y1="128.1094" y2="128.1094" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="129.5" y="123.6777">setState()</text></g></svg></p>
<p>Here is an implementation of a compile-time state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">interface</span> <span class="nc">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> 
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">StateImpl</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;fill&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;insertCurrency&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;purchase&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;eject&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">Exception</span> <span class="nf">createException</span><span class="o">(</span><span class="n">String</span> <span class="n">actionName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&quot;&#39;$actionName&#39; is an invalid action for state &#39;${getClass().name}&#39;.&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@groovy.transform.TupleConstructor</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">SoldOut</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span> <span class="n">sm</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">+</span> <span class="n">count</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span> <span class="o">:</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">NoCurrency</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@groovy.transform.TupleConstructor</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">HasCurrency</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span> <span class="n">sm</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">--</span><span class="n">sm</span><span class="o">.</span><span class="na">inventory</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span> <span class="o">:</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">inventory</span> 
</span><span class='line'>    <span class="n">State</span> <span class="n">state</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">soldOut</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">noCurrency</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">hasCurrency</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">StateEnum</span><span class="o">,</span> <span class="n">State</span><span class="o">&gt;</span> <span class="n">stateMap</span>    
</span><span class='line'>
</span><span class='line'>    <span class="kd">enum</span> <span class="n">StateEnum</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">SOLD_OUT</span><span class="o">,</span>
</span><span class='line'>        <span class="n">NO_CURRENCY</span><span class="o">,</span>
</span><span class='line'>        <span class="n">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">(</span><span class="kt">int</span> <span class="n">inventory</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">soldOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SoldOut</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</span><span class='line'>        <span class="n">noCurrency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NoCurrency</span><span class="o">()</span>
</span><span class='line'>        <span class="n">hasCurrency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HasCurrency</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</span><span class='line'>        
</span><span class='line'>        <span class="n">stateMap</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span><span class="o">):</span> <span class="n">soldOut</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span><span class="o">):</span> <span class="n">noCurrency</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">HAS_CURRENCY</span><span class="o">):</span> <span class="n">hasCurrency</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">state</span> <span class="o">=</span> <span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">noCurrency</span> <span class="o">:</span> <span class="n">soldOut</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">count</span><span class="o">))</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">purchase</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">eject</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">StateEnum</span> <span class="nf">changeState</span><span class="o">(</span><span class="n">StateEnum</span> <span class="n">newState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="n">state</span> <span class="o">=</span> <span class="n">stateMap</span><span class="o">[</span><span class="n">newState</span><span class="o">]</span>
</span><span class='line'>         
</span><span class='line'>         <span class="k">return</span> <span class="n">newState</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;SoldOut&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The <code>State</code> interface defines the available actions/transitions. But since each state only needs to implement a subset of those actions, I added <code>StateImpl</code> to provide default implementations. In comparison to previous approaches, the state's business logic is spread out across multiple classes. Finally, construction of the state machine is handled by <code>StateMachine</code>'s constructor.</p>
<p>We can learn a few things from compile-time state machines:</p>
<ul>
<li>Each state may only need to implement a subset of the available actions.</li>
<li>A state machine is assembled from various components: states, context, and a supervisor (the state machine itself).</li>
<li>State machines are quite similar in functionality, yet each needs a concrete implementation.</li>
</ul>
<p>And it is this last point that I want to emphasize. Even though state machines do the same thing, a complete compile-time state machine must be coded for each implementation. This is due to the static dispatching that's used when calling methods. Consider the following example:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="o">{</span> <span class="cm">/* I don&#39;t declare any methods. Ha ha! */</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">doSomething</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-danger" role="alert">groovy.lang.MissingMethodException: No signature of method: StateMachine.doSomething() is applicable for argument types: () values: []
Possible solutions: toString(), toString()</div>
</p>
<p>It results in an exception because the <code>StateMachine.doSomething()</code> method was not found. But languages with multiple/dynamic dispatching, such as Groovy, allow us to intercept these missing methods as they are called and do something useful. This is the basis for what I call a run-time state machine.</p>
<h2>The run-time state machine</h2>
<p>Simply put, a state machine consists of:</p>
<ul>
<li>a list of possible states</li>
<li>the ability to delegate work to the current state</li>
<li>the ability to change states</li>
<li>and maybe some context to maintain data across state changes</li>
</ul>
<p>That's really it.</p>
<p>With languages which use dynamic dispatching to execute methods, it's possible to create a <em>run-time state machine</em>. By this I mean a single set of classes which can be used to create various state machine implementations.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="yes"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="359px" style="width:172px;height:359px;" version="1.1" viewBox="0 0 172 359" width="172px"><defs><filter height="300%" id="f1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><rect fill="#FEFECE" filter="url(#f1)" height="99.8203" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="6" y="142" /><ellipse cx="43.5" cy="158" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M46.4731,163.6431 Q45.8921,163.9419 45.2529,164.0913 Q44.6138,164.2407 43.9082,164.2407 Q41.4014,164.2407 40.0815,162.5889 Q38.7617,160.937 38.7617,157.8159 Q38.7617,154.6865 40.0815,153.0347 Q41.4014,151.3828 43.9082,151.3828 Q44.6138,151.3828 45.2612,151.5322 Q45.9087,151.6816 46.4731,151.9805 L46.4731,154.7031 Q45.8423,154.1221 45.2488,153.8523 Q44.6553,153.5825 44.0244,153.5825 Q42.6797,153.5825 41.9949,154.6492 Q41.3101,155.7158 41.3101,157.8159 Q41.3101,159.9077 41.9949,160.9744 Q42.6797,162.041 44.0244,162.041 Q44.6553,162.041 45.2488,161.7712 Q45.8423,161.5015 46.4731,160.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="75" x="62.5" y="162.5352">StateMachine</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="162" y1="174" y2="174" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="72" x="12" y="188.6348">Map : context</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="145" x="12" y="201.5898">Map&lt;String, State&gt; : states</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="101" x="12" y="214.5449">State : currentState</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="162" y1="220.8652" y2="220.8652" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="90" x="12" y="235.5">methodMissing()</text><rect fill="#FEFECE" filter="url(#f1)" height="73.9102" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="42" y="8" /><ellipse cx="68.25" cy="24" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M71.2231,29.6431 Q70.6421,29.9419 70.0029,30.0913 Q69.3638,30.2407 68.6582,30.2407 Q66.1514,30.2407 64.8315,28.5889 Q63.5117,26.937 63.5117,23.8159 Q63.5117,20.6865 64.8315,19.0347 Q66.1514,17.3828 68.6582,17.3828 Q69.3638,17.3828 70.0112,17.5322 Q70.6587,17.6816 71.2231,17.9805 L71.2231,20.7031 Q70.5923,20.1221 69.9988,19.8523 Q69.4053,19.5825 68.7744,19.5825 Q67.4297,19.5825 66.7449,20.6492 Q66.0601,21.7158 66.0601,23.8159 Q66.0601,25.9077 66.7449,26.9744 Q67.4297,28.041 68.7744,28.041 Q69.4053,28.041 69.9988,27.7712 Q70.5923,27.5015 71.2231,26.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="28" x="84.75" y="28.5352">State</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="43" x2="126" y1="40" y2="40" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="70" x="48" y="54.6348">String : name</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="70" x="48" y="67.5898">Map : actions</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="43" x2="126" y1="73.9102" y2="73.9102" /><rect fill="#FEFECE" filter="url(#f1)" height="48" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="52.5" y="302" /><ellipse cx="67.5" cy="318" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M70.4731,323.6431 Q69.8921,323.9419 69.2529,324.0913 Q68.6138,324.2407 67.9082,324.2407 Q65.4014,324.2407 64.0815,322.5889 Q62.7617,320.937 62.7617,317.8159 Q62.7617,314.6865 64.0815,313.0347 Q65.4014,311.3828 67.9082,311.3828 Q68.6138,311.3828 69.2612,311.5322 Q69.9087,311.6816 70.4731,311.9805 L70.4731,314.7031 Q69.8423,314.1221 69.2488,313.8523 Q68.6553,313.5825 68.0244,313.5825 Q66.6797,313.5825 65.9949,314.6492 Q65.3101,315.7158 65.3101,317.8159 Q65.3101,319.9077 65.9949,320.9744 Q66.6797,322.041 68.0244,322.041 Q68.6553,322.041 69.2488,321.7712 Q69.8423,321.5015 70.4731,320.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="32" x="81.5" y="322.5352">Client</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="53.5" x2="115.5" y1="334" y2="334" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="53.5" x2="115.5" y1="342" y2="342" /><path d="M84.5,242.152 C84.5,262.5293 84.5,285.2029 84.5,301.6717 " fill="none" style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 7.0,7.0;" /><path d="M84.5,82.216 C84.5,100.25 84.5,122.321 84.5,141.858 " fill="none" style="stroke: #A80036; stroke-width: 1.0;" /></g></svg></p>
<p>When an action is executed against the state machine and it delegates to the current state, the state looks up the action in its <code>Map</code> of actions and executes it.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="yes"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="272px" style="width:479px;height:272px;" version="1.1" viewBox="0 0 479 272" width="479px"><defs><filter height="300%" id="f1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="37" x2="37" y1="38.4883" y2="234.3516" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="130" x2="130" y1="38.4883" y2="234.3516" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="255.5" x2="255.5" y1="38.4883" y2="234.3516" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="369" x2="369" y1="38.4883" y2="234.3516" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="438" x2="438" y1="38.4883" y2="234.3516" /><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="23.5352">Client</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="253.8867">Client</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="76" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="83" y="23.5352">StateMachine</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="76" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="83" y="253.8867">StateMachine</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="48" x="229.5" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="236.5" y="23.5352">State</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="48" x="229.5" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="236.5" y="253.8867">State</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="43" x="346" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="353" y="23.5352">Map</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="43" x="346" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="353" y="253.8867">Map</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="403" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="410" y="23.5352">Closure</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="403" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="410" y="253.8867">Closure</text><polygon fill="#A80036" points="118.5,65.4883,128.5,69.4883,118.5,73.4883,122.5,69.4883" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="37" x2="124.5" y1="69.4883" y2="69.4883" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="44" y="65.0566">handle()</text><polygon fill="#A80036" points="243.5,94.7988,253.5,98.7988,243.5,102.7988,247.5,98.7988" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="130.5" x2="249.5" y1="98.7988" y2="98.7988" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="137.5" y="94.3672">handle()</text><polygon fill="#A80036" points="357.5,124.1094,367.5,128.1094,357.5,132.1094,361.5,128.1094" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="255.5" x2="363.5" y1="128.1094" y2="128.1094" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="262.5" y="123.6777">getAt('handle')</text><polygon fill="#A80036" points="266.5,153.4199,256.5,157.4199,266.5,161.4199,262.5,157.4199" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="260.5" x2="368.5" y1="157.4199" y2="157.4199" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="272.5" y="152.9883">Closure</text><polygon fill="#A80036" points="426.5,182.7305,436.5,186.7305,426.5,190.7305,430.5,186.7305" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="255.5" x2="432.5" y1="186.7305" y2="186.7305" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="262.5" y="182.2988">call()</text><polygon fill="#A80036" points="141.5,212.041,131.5,216.041,141.5,220.041,137.5,216.041" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="135.5" x2="254.5" y1="216.041" y2="216.041" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="147.5" y="211.6094">next state name</text></g></svg></p>
<p>I went a different route with the state changes: the current <code>State</code> returns the name of the next state to the <code>StateMachine</code>, which then changes the current <code>State</code>. Here's an implementation:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Map</span> <span class="n">context</span>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">State</span><span class="o">&gt;</span> <span class="n">states</span>
</span><span class='line'>    <span class="n">State</span> <span class="n">state</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kt">def</span> <span class="nf">methodMissing</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">def</span> <span class="n">action</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="na">actions</span><span class="o">[</span><span class="n">name</span><span class="o">]</span>
</span><span class='line'>        
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">action</span> <span class="k">instanceof</span> <span class="n">GroovyCallable</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">action</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">context</span>
</span><span class='line'>            <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="o">[</span><span class="n">action</span><span class="o">(*</span><span class="n">args</span><span class="o">)]</span> <span class="o">?:</span> <span class="n">state</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">action</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="o">[</span><span class="n">action</span><span class="o">]</span> <span class="o">?:</span> <span class="n">state</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&quot;&#39;$name&#39; is an invalid action for state &#39;$state.name&#39;.&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>        
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>    <span class="n">Map</span> <span class="n">actions</span> <span class="o">=</span> <span class="o">[:]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>The example above consists of just two classes: <code>StateMachine</code> and <code>State</code>. <code>StateMachine</code> attempts to delegate method calls to the current <code>State</code>, and then changes the current state based on the method's output. <code>State.actions</code> is a list of supported actions/transitions. A <em>context</em> object is made the delegate of each action so that information can be maintained across state changes. Being generic, this state machine does not have state implementations; It doesn't have any business logic. Lets see what it's like to construct an implementation using this generic state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">(</span>
</span><span class='line'>    <span class="nl">context:</span> <span class="o">[</span><span class="nl">inventory:</span> <span class="mi">0</span><span class="o">],</span>
</span><span class='line'>    <span class="nl">states:</span> <span class="o">[</span>
</span><span class='line'>        <span class="nl">SoldOut:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">fill:</span> <span class="o">{</span> <span class="n">count</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">+</span> <span class="n">count</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;NoCurrency&#39;</span> <span class="o">:</span> <span class="s1">&#39;SoldOut&#39;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">],</span>
</span><span class='line'>        <span class="nl">NoCurrency:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">insertCurrency:</span> <span class="s1">&#39;HasCurrency&#39;</span>
</span><span class='line'>        <span class="o">],</span>
</span><span class='line'>        <span class="nl">HasCurrency:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">purchase:</span> <span class="o">{</span>
</span><span class='line'>                <span class="o">--</span><span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;NoCurrency&#39;</span> <span class="o">:</span> <span class="s1">&#39;SoldOut&#39;</span>
</span><span class='line'>            <span class="o">},</span>
</span><span class='line'>            <span class="nl">eject:</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>    <span class="o">].</span><span class="na">collectEntries</span> <span class="o">{</span> <span class="n">name</span><span class="o">,</span> <span class="n">actions</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">name</span><span class="o">,</span> <span class="k">new</span> <span class="n">State</span><span class="o">(</span><span class="nl">name:</span> <span class="n">name</span><span class="o">,</span> <span class="nl">actions:</span> <span class="n">actions</span><span class="o">)]</span> <span class="o">}</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>The example above uses the generic state machine to <em>build</em> a concrete implementation. The <code>State</code> instances are build from a <code>Map</code>. Each <code>Map</code> entry represents a state, with the value being a <code>Map</code> of <code>Closure</code>s (or <code>String</code>s). Each <code>Closure</code> implements a state action.</p>
<p>As a bonus, if the action merely changes to another state, then a <code>String</code> with the state's name can be used instead of a <code>Closure</code>.</p>
<p>Notice how unlike the compile-time state machine, here each state only needs to implement the actions that pertain to the state. No dummy method implementations are needed whatsoever.</p>
<p><div class="alert alert-info" role="alert"><p>Actually, the <em>dummy</em> implementation is provided by the state machine.</p>
</div>
</p>
<p>Here's what it's like to use the state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">sm</span><span class="o">.</span><span class="na">states</span><span class="o">.</span><span class="na">NoCurrency</span> <span class="o">:</span> <span class="n">sm</span><span class="o">.</span><span class="na">states</span><span class="o">.</span><span class="na">SoldOut</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;SoldOut&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>It works just like a compile-time state machine, and uses 44% less code. The most glaring difference being that the initial state must be set. Since we're dealing with a generic state machine, it has no idea which state to start with.</p>
<h1>Making it better</h1>
<p>I think the run-time state machine is rather neat. Particularly the fact that it can easily be reused to implement any number of state machines. However, there's one thing that bugs me about it: building one is rather yucky. Tune in next week  to see a better way to <em>build</em> run-time state machines.</p>
</div>

  <footer>
    <div class="text-center">
        <p>Get more articles like this. <em>Weekly.</em></p>
        <!-- Begin MailChimp Signup Form -->
<div id="mc_embed_signup">
<form action="//emmanuelrosa.us12.list-manage.com/subscribe/post?u=4b1cb5850b8311c1f0bbb7198&amp;id=05cd5c1d15" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate form-inline" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    
    <div class="form-group">
        <input type="email" value="" name="EMAIL" class="email form-control" id="mce-EMAIL" placeholder="email address" required>
    </div>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;"><input type="text" name="b_4b1cb5850b8311c1f0bbb7198_05cd5c1d15" tabindex="-1" value=""></div>
    <input type="submit" value="Sign up" name="subscribe" id="mc-embedded-subscribe" class="btn btn-primary">
    </div>
</form>
</div>

<!--End mc_embed_signup-->

    </div>
    <br /><br />
    
      <div class="sharing text-center">
<p>Useful? Tell a friend.</p>

    <a style="font-size: 25px;" href="#"><span class="fa fa fa-twitter">&nbsp;&nbsp;&nbsp;</span></a>

    <a style="font-size: 25px;" href="#"><span class="fa fa fa-google-plus">&nbsp;&nbsp;&nbsp;</span></a>

    <a style="font-size: 25px;" href="#"><span class="fa fa fa-facebook">&nbsp;&nbsp;&nbsp;</span></a>

    
    <a style="font-size: 25px;" href="mailto:?to=&subject=Remaking the software state machine for dynamic programming languages.&body=Your personalized message goes here. http://emmanuelrosa.com/articles/the-state-of-things/"><span class="fa fa-envelope"></span></a>
</div>

<script type="text/javascript">
$(function() {
    $(".sharing .fa-twitter").click(function(e) {
        e.preventDefault();
        
        var url = "https://twitter.com/share?url=http://emmanuelrosa.com/articles/the-state-of-things/&text=Remaking+the+software+state+machine+for+dynamic+programming+languages."
        window.open(url, "popupWindow", "width=600,height=600,scrollbars=yes");
    });

    $(".sharing .fa-facebook").click(function(e) {
        e.preventDefault();

        var url = "https://www.facebook.com/sharer/sharer.php?u=http://emmanuelrosa.com/articles/the-state-of-things/";
        window.open(url, "popupWindow", "width=600,height=600,scrollbars=yes");
    });

    $(".sharing .fa-google-plus").click(function(e) {
        e.preventDefault();

        var url = "https://plus.google.com/share?url=http://emmanuelrosa.com/articles/the-state-of-things/"
        window.open(url, "popupWindow", "width=600,height=600,scrollbars=yes");
    });
});
</script>

    
  </footer>
</article>


                </div>
            <div>
            
        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <!-- Nothing to see here -->

</div>
</footer>
    




<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="http://emmanuelrosa.com/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="http://emmanuelrosa.com/javascripts/modernizr-14450bf93252c8e5cc9ff5944c8ff121.js"></script>



       <nav class="navbar navbar-default navbar-fixed-bottom">
        <div class="container">
            <p class="navbar-text navbar-left">
                Copyright &copy; 2015 - Emmanuel Rosa
            </p>
            <p class="navbar-text navbar-right">
                
            </p>
        </div>
       </nav>
  </body>
</html>
