


<!DOCTYPE html>
<html class="no-js" lang="en" prefix="og: http://ogp.me/ns#>
<head>
  <meta charset="utf-8">
  <title>The State of Things - EmmanuelRosa.com</title>
  <meta property="author" content="Emmanuel Rosa">

  
    <meta name="description" content="Remaking the software state machine for dynamic programming languages.">
  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="canonical" href="http://emmanuelrosa.com/articles/the-state-of-things/">
  <link href="http://emmanuelrosa.com/images/favicon-04b8a331dc172dc2876810a77fddf8b0.png" type="image/png" rel="icon">
  <link href="http://emmanuelrosa.com/atom.xml" rel="alternate" title="EmmanuelRosa.com" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="article">
  <meta property="og:url" content="http://emmanuelrosa.com/articles/the-state-of-things/">
  <meta property="og:title" content="The State of Things - EmmanuelRosa.com">
  <meta property="og:description" content="Remaking the software state machine for dynamic programming languages.">
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="EmmanuelRosa.com" />
  <meta property="og:updated_time" content="2016-01-08T15:23:36-05:00" />
  <meta property="og:image" content="http://emmanuelrosa.comhttp://emmanuelrosa.com/images/logo-56fc9f8a57dedecb5c6d1e59cd1c8c20.png" />

  <script src="http://emmanuelrosa.com/javascripts/libs/jquery/jquery-2.1.3.min-32015dd42e9582a80a84736f5d9a44d7.js"></script>
<script src="http://emmanuelrosa.com/javascripts/libs/jquery/jquery.cookie-d5528dde0006c78be04817327c2f9b6f.js"></script>

<link href="http://emmanuelrosa.com/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="http://emmanuelrosa.com/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="http://emmanuelrosa.com/assets/font-awesome/css/font-awesome.min.css">


  
  <link href="http://emmanuelrosa.com/stylesheets/screen-e4fc71c55515b4737f869e41df2c9bec.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69493301-1', 'auto');
    ga('send', 'pageview');

  </script>


  <!-- Begin Cookie Consent plugin by Silktide - http://silktide.com/cookieconsent -->
<script type="text/javascript">
    window.cookieconsent_options = {"message":"Of course this website uses cookies. It would be so bland without them.","dismiss":"I'm so baked","learnMore":"What the frack?","link":"https://www.google.com/policies/privacy/partners/","theme":"dark-bottom"};
</script>

<script type="text/javascript" src="http://emmanuelrosa.com/javascripts/cookieconsent.min-b4176fc70afe0c55107683f38e47d71b.js"></script>
<!-- End Cookie Consent plugin -->

</head>


  
  <body 
     >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://emmanuelrosa.com/">EmmanuelRosa.com</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li >
                    <a href="http://emmanuelrosa.com/archives/"><span class="fa fa-archive hidden-sm hidden-md hidden-lg"></span> Articles</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
            <div class="row">
                <div class="page-content col-md-12">
                    
<article class="hentry" role="article" itemscope itemtype="http://schema.org/BlogPosting">
  <!-- http://schema.org meta-data -->
  <meta itemscope itemprop="mainEntityOfPage" itemType="https://schema.org/WebPage" itemid="http://emmanuelrosa.com/articles/the-state-of-things/"/>
  <meta itemprop="name" content="The State of Things" />
  <meta itemprop="author" content="Emmanuel Rosa" />
  <meta itemprop="publisher" content="Emmanuel Rosa" />
  <meta itemprop="datePublished" content="Mon Dec 14 16:14:00 EST 2015" />
  <meta itemprop="dateModified" content="Fri Jan 08 15:23:36 EST 2016" />
  <meta itemprop="description" content="Remaking the software state machine for dynamic programming languages." />
  <meta itemprop="url" content="http://emmanuelrosa.com/articles/the-state-of-things/" />
  <meta itemprop="image" content="http://emmanuelrosa.com/images/logo-56fc9f8a57dedecb5c6d1e59cd1c8c20.png" />

  
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        
      </p>
    
    <h1 class="entry-title" itemprop="name headline">The State of Things
        
    </h1>
  </header>

<div class="entry-content clearfix" itemprop="articleBody description"><p>As a programmer you've either yet to, or have already, coded a state machine; for the remainder of this article, I'll assume the latter. First, a little bit of history.</p>
<h2>The monkey-patch</h2>
<p>In its most simplistic implementation, a state machine is coded as a series of <em>flags</em>: variables whose combination of values <em>mean</em> something.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">double</span> <span class="n">currency</span>
</span><span class='line'><span class="kt">int</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Take action based on current state.</span>
</span><span class='line'><span class="k">if</span><span class="o">(</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// No currency state</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">currency</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Has currency state</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Sold out state</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h2>The proverbial wheel</h2>
<p>A step above this crude monkey-patched state machine is initializing and maintaining the current state in a variable.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SOLD_OUT</span><span class="o">,</span>
</span><span class='line'>    <span class="n">NO_CURRENCY</span><span class="o">,</span>
</span><span class='line'>    <span class="n">HAS_CURRENCY</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">State</span> <span class="n">state</span>
</span><span class='line'><span class="kt">double</span> <span class="n">currency</span>
</span><span class='line'><span class="kt">int</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Set initial state.</span>
</span><span class='line'><span class="k">if</span><span class="o">(</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">NO_CURRENCY</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">currency</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Take action based on current state.</span>
</span><span class='line'><span class="k">switch</span><span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOLD_OUT:</span>
</span><span class='line'>        <span class="c1">// Do something.</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Then came along the state machine design pattern, which for the purpose of this article I'll refer to as a compile-time state machine.</p>
<h1>The compile-time state machine</h1>
<p>You may be onto me. I've hinted at my yet-to-be-revealed hypothesis. But, as I was saying, the state machine design pattern suggests representing each state as a class and having a mechanism to maintain the current state and context.</p>
<p><img src="http://emmanuelrosa.com/images/staticClass-bc146b0b008ea44a9b881f8513474269-970842fc11a329cf7112edd3b1128b72.png" alt="Static class diagram" /></p>
<p>When the state machine is used, it delegates work to the current state.</p>
<p><img src="http://emmanuelrosa.com/images/staticSequence-35a7f01f481f77db1abf46e05bd3999f-9f207da96d082ab7223dafe7460fb30d.png" alt="Static sequence diagram" /></p>
<p>Here is an implementation of a compile-time state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">interface</span> <span class="nc">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> 
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">StateImpl</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;fill&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;insertCurrency&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;purchase&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;eject&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">Exception</span> <span class="nf">createException</span><span class="o">(</span><span class="n">String</span> <span class="n">actionName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&quot;&#39;$actionName&#39; is an invalid action for state &#39;${getClass().name}&#39;.&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@groovy.transform.TupleConstructor</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">SoldOut</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span> <span class="n">sm</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">+</span> <span class="n">count</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span> <span class="o">:</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">NoCurrency</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@groovy.transform.TupleConstructor</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">HasCurrency</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span> <span class="n">sm</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">--</span><span class="n">sm</span><span class="o">.</span><span class="na">inventory</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span> <span class="o">:</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">inventory</span> 
</span><span class='line'>    <span class="n">State</span> <span class="n">state</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">soldOut</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">noCurrency</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">hasCurrency</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">StateEnum</span><span class="o">,</span> <span class="n">State</span><span class="o">&gt;</span> <span class="n">stateMap</span>    
</span><span class='line'>
</span><span class='line'>    <span class="kd">enum</span> <span class="n">StateEnum</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">SOLD_OUT</span><span class="o">,</span>
</span><span class='line'>        <span class="n">NO_CURRENCY</span><span class="o">,</span>
</span><span class='line'>        <span class="n">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">(</span><span class="kt">int</span> <span class="n">inventory</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">soldOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SoldOut</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</span><span class='line'>        <span class="n">noCurrency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NoCurrency</span><span class="o">()</span>
</span><span class='line'>        <span class="n">hasCurrency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HasCurrency</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</span><span class='line'>        
</span><span class='line'>        <span class="n">stateMap</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span><span class="o">):</span> <span class="n">soldOut</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span><span class="o">):</span> <span class="n">noCurrency</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">HAS_CURRENCY</span><span class="o">):</span> <span class="n">hasCurrency</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">state</span> <span class="o">=</span> <span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">noCurrency</span> <span class="o">:</span> <span class="n">soldOut</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">count</span><span class="o">))</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">purchase</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">eject</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">StateEnum</span> <span class="nf">changeState</span><span class="o">(</span><span class="n">StateEnum</span> <span class="n">newState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="n">state</span> <span class="o">=</span> <span class="n">stateMap</span><span class="o">[</span><span class="n">newState</span><span class="o">]</span>
</span><span class='line'>         
</span><span class='line'>         <span class="k">return</span> <span class="n">newState</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;SoldOut&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The <code>State</code> interface defines the available actions/transitions. But since each state only needs to implement a subset of those actions, I added <code>StateImpl</code> to provide default implementations. In comparison to previous approaches, the state's business logic is spread out across multiple classes. Finally, construction of the state machine is handled by <code>StateMachine</code>'s constructor.</p>
<p>We can learn a few things from compile-time state machines:</p>
<ul>
<li>Each state may only need to implement a subset of the available actions.</li>
<li>A state machine is assembled from various components: states, context, and a supervisor (the state machine itself).</li>
<li>State machines are quite similar in functionality, yet each needs a concrete implementation.</li>
</ul>
<p>And it is this last point that I want to emphasize. Even though state machines do the same thing, a complete compile-time state machine must be coded for each implementation. This is due to the static dispatching that's used when calling methods. Consider the following example:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="o">{</span> <span class="cm">/* I don&#39;t declare any methods. Ha ha! */</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">doSomething</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-danger" role="alert">groovy.lang.MissingMethodException: No signature of method: StateMachine.doSomething() is applicable for argument types: () values: []
Possible solutions: toString(), toString()</div>
</p>
<p>It results in an exception because the <code>StateMachine.doSomething()</code> method was not found. But languages with multiple/dynamic dispatching, such as Groovy, allow us to intercept these missing methods as they are called and do something useful. This is the basis for what I call a run-time state machine.</p>
<h2>The run-time state machine</h2>
<p>Simply put, a state machine consists of:</p>
<ul>
<li>a list of possible states</li>
<li>the ability to delegate work to the current state</li>
<li>the ability to change states</li>
<li>and maybe some context to maintain data across state changes</li>
</ul>
<p>That's really it.</p>
<p>With languages which use dynamic dispatching to execute methods, it's possible to create a <em>run-time state machine</em>. By this I mean a single set of classes which can be used to create various state machine implementations.</p>
<p><img src="http://emmanuelrosa.com/images/runtimeClass-b0f6b3507cfd086b5eba01aab3fd6f60-c3574925a9f45d01725ea16055379935.png" alt="Run-time class diagram" /></p>
<p>When an action is executed against the state machine and it delegates to the current state, the state looks up the action in its <code>Map</code> of actions and executes it.</p>
<p><img src="http://emmanuelrosa.com/images/runtimeSequence-a61b2d9dcf6926cb43f5abf7733cfe32-c67f3bc2e59609a801d55cba319873b5.png" alt="Run-time sequence diagram" /></p>
<p>I went a different route with the state changes: the current <code>State</code> returns the name of the next state to the <code>StateMachine</code>, which then changes the current <code>State</code>. Here's an implementation:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Map</span> <span class="n">context</span>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">State</span><span class="o">&gt;</span> <span class="n">states</span>
</span><span class='line'>    <span class="n">State</span> <span class="n">state</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kt">def</span> <span class="nf">methodMissing</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">def</span> <span class="n">action</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="na">actions</span><span class="o">[</span><span class="n">name</span><span class="o">]</span>
</span><span class='line'>        
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">action</span> <span class="k">instanceof</span> <span class="n">GroovyCallable</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">action</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">context</span>
</span><span class='line'>            <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="o">[</span><span class="n">action</span><span class="o">(*</span><span class="n">args</span><span class="o">)]</span> <span class="o">?:</span> <span class="n">state</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">action</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="o">[</span><span class="n">action</span><span class="o">]</span> <span class="o">?:</span> <span class="n">state</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&quot;&#39;$name&#39; is an invalid action for state &#39;$state.name&#39;.&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>        
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>    <span class="n">Map</span> <span class="n">actions</span> <span class="o">=</span> <span class="o">[:]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>The example above consists of just two classes: <code>StateMachine</code> and <code>State</code>. <code>StateMachine</code> attempts to delegate method calls to the current <code>State</code>, and then changes the current state based on the method's output. <code>State.actions</code> is a list of supported actions/transitions. A <em>context</em> object is made the delegate of each action so that information can be maintained across state changes. Being generic, this state machine does not have state implementations; It doesn't have any business logic. Lets see what it's like to construct an implementation using this generic state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">(</span>
</span><span class='line'>    <span class="nl">context:</span> <span class="o">[</span><span class="nl">inventory:</span> <span class="mi">0</span><span class="o">],</span>
</span><span class='line'>    <span class="nl">states:</span> <span class="o">[</span>
</span><span class='line'>        <span class="nl">SoldOut:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">fill:</span> <span class="o">{</span> <span class="n">count</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">+</span> <span class="n">count</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;NoCurrency&#39;</span> <span class="o">:</span> <span class="s1">&#39;SoldOut&#39;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">],</span>
</span><span class='line'>        <span class="nl">NoCurrency:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">insertCurrency:</span> <span class="s1">&#39;HasCurrency&#39;</span>
</span><span class='line'>        <span class="o">],</span>
</span><span class='line'>        <span class="nl">HasCurrency:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">purchase:</span> <span class="o">{</span>
</span><span class='line'>                <span class="o">--</span><span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;NoCurrency&#39;</span> <span class="o">:</span> <span class="s1">&#39;SoldOut&#39;</span>
</span><span class='line'>            <span class="o">},</span>
</span><span class='line'>            <span class="nl">eject:</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>    <span class="o">].</span><span class="na">collectEntries</span> <span class="o">{</span> <span class="n">name</span><span class="o">,</span> <span class="n">actions</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">name</span><span class="o">,</span> <span class="k">new</span> <span class="n">State</span><span class="o">(</span><span class="nl">name:</span> <span class="n">name</span><span class="o">,</span> <span class="nl">actions:</span> <span class="n">actions</span><span class="o">)]</span> <span class="o">}</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>The example above uses the generic state machine to <em>build</em> a concrete implementation. The <code>State</code> instances are build from a <code>Map</code>. Each <code>Map</code> entry represents a state, with the value being a <code>Map</code> of <code>Closure</code>s (or <code>String</code>s). Each <code>Closure</code> implements a state action.</p>
<p>As a bonus, if the action merely changes to another state, then a <code>String</code> with the state's name can be used instead of a <code>Closure</code>.</p>
<p>Notice how unlike the compile-time state machine, here each state only needs to implement the actions that pertain to the state. No dummy method implementations are needed whatsoever.</p>
<p><div class="alert alert-info" role="alert"><p>Actually, the <em>dummy</em> implementation is provided by the state machine.</p>
</div>
</p>
<p>Here's what it's like to use the state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">sm</span><span class="o">.</span><span class="na">states</span><span class="o">.</span><span class="na">NoCurrency</span> <span class="o">:</span> <span class="n">sm</span><span class="o">.</span><span class="na">states</span><span class="o">.</span><span class="na">SoldOut</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;SoldOut&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>It works just like a compile-time state machine, and uses 44% less code. The most glaring difference being that the initial state must be set. Since we're dealing with a generic state machine, it has no idea which state to start with, <em>yet</em>.</p>
<h1>Making it better</h1>
<p>I think the run-time state machine is rather neat. Particularly the fact that it can easily be reused to implement any number of state machines. However, there's one thing that bugs me about it: building one is rather yucky. Check out <a href="http://emmanuelrosa.com/articles/builder-of-the-state/">part 2</a>  to see a better way to <em>build</em> run-time state machines.</p>
</div>

  <div id="article-read-detector"></div>
  <footer>
    <div class="text-center">
        <p>Get more articles like this. <em>Weekly.</em></p>
        

<!-- Begin MailChimp Signup Form -->
<div id="mc_embed_signup">
<form action="//emmanuelrosa.us12.list-manage.com/subscribe/post?u=4b1cb5850b8311c1f0bbb7198&amp;id=05cd5c1d15" method="post" class="validate form-inline mc-embedded-subscribe-form" target="_blank" novalidate id="mc-article-footer">
    <div>
    
    <div class="form-group">
        <input type="email" value="" name="EMAIL" class="email form-control" placeholder="email address" required>
    </div>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;"><input type="text" name="b_4b1cb5850b8311c1f0bbb7198_05cd5c1d15" tabindex="-1" value=""></div>
    <input type="submit" value="Sign up" name="subscribe" class="btn btn-primary" id="mc-article-footer-submit">
    </div>
</form>
</div>


<script type="text/javascript">
    $(function() {
        $('#mc-article-footer-submit').click(function() {
            ga('send', 'event', 'newsletter', 'start-signup', 'mc-article-footer');
        });
    });
</script>

<!--End mc_embed_signup-->

    </div>
    <br /><br />
    
      <div class="sharing text-center">
<p>Useful? Tell a friend.</p>

    <a style="font-size: 25px;" href="#"><span class="fa fa fa-twitter">&nbsp;&nbsp;&nbsp;</span></a>

    <a style="font-size: 25px;" href="#"><span class="fa fa fa-google-plus">&nbsp;&nbsp;&nbsp;</span></a>

    <a style="font-size: 25px;" href="#"><span class="fa fa fa-facebook">&nbsp;&nbsp;&nbsp;</span></a>

    
    <a style="font-size: 25px;" href="mailto:?to=&subject=Remaking the software state machine for dynamic programming languages.&body=Your personalized message goes here. http://emmanuelrosa.com/articles/the-state-of-things/"><span class="fa fa-envelope"></span></a>
</div>

<script type="text/javascript">
$(function() {
    $(".sharing .fa-twitter").click(function(e) {
        e.preventDefault();
        
        var url = "https://twitter.com/share?url=http://emmanuelrosa.com/articles/the-state-of-things/&text=Remaking+the+software+state+machine+for+dynamic+programming+languages."
        window.open(url, "popupWindow", "width=600,height=600,scrollbars=yes");
    });

    $(".sharing .fa-facebook").click(function(e) {
        e.preventDefault();

        var url = "https://www.facebook.com/sharer/sharer.php?u=http://emmanuelrosa.com/articles/the-state-of-things/";
        window.open(url, "popupWindow", "width=600,height=600,scrollbars=yes");
    });

    $(".sharing .fa-google-plus").click(function(e) {
        e.preventDefault();

        var url = "https://plus.google.com/share?url=http://emmanuelrosa.com/articles/the-state-of-things/"
        window.open(url, "popupWindow", "width=600,height=600,scrollbars=yes");
    });
});
</script>

    
  </footer>
</article>


<div id="ouibounce-modal" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Thank you for reading!</h4>
      </div>
      <div class="modal-body">
        <img class="pull-left visible-md-block visible-lg-block" src="http://emmanuelrosa.com/images/me-aed1cb28a1261a6257b60aa56fab0eae.png" style="margin-right: 30px"/>
        <div>
            <h4>Not everyone bothers to read, you know. Yet you did. I have a weekly newsletter wherein I publish articles like this one.</h4>
            <h3>Care to sign up?</h3>
            

<!-- Begin MailChimp Signup Form -->
<div id="mc_embed_signup">
<form action="//emmanuelrosa.us12.list-manage.com/subscribe/post?u=4b1cb5850b8311c1f0bbb7198&amp;id=05cd5c1d15" method="post" class="validate form-inline mc-embedded-subscribe-form" target="_blank" novalidate id="mc-article-on-exit-modal">
    <div>
    
    <div class="form-group">
        <input type="email" value="" name="EMAIL" class="email form-control" placeholder="email address" required>
    </div>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;"><input type="text" name="b_4b1cb5850b8311c1f0bbb7198_05cd5c1d15" tabindex="-1" value=""></div>
    <input type="submit" value="Sign up" name="subscribe" class="btn btn-primary" id="mc-article-on-exit-modal-submit">
    </div>
</form>
</div>


<script type="text/javascript">
    $(function() {
        $('#mc-article-on-exit-modal-submit').click(function() {
            ga('send', 'event', 'newsletter', 'start-signup', 'mc-article-on-exit-modal');
        });
    });
</script>

<!--End mc_embed_signup-->

            <h5>Hmm... I'd rather <a href="http://emmanuelrosa.com/archives/">read a bit more</a> first.</h5>
        </div>
        <div class="clearfix"></div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
/*
 * jQuery appear plugin
 *
 * Copyright (c) 2012 Andrey Sidorov
 * licensed under MIT license.
 *
 * https://github.com/morr/jquery.appear/
 *
 * Version: 0.3.6
 */
(function($) {
  var selectors = [];

  var check_binded = false;
  var check_lock = false;
  var defaults = {
    interval: 250,
    force_process: false
  };
  var $window = $(window);

  var $prior_appeared = [];

  function process() {
    check_lock = false;
    for (var index = 0, selectorsLength = selectors.length; index < selectorsLength; index++) {
      var $appeared = $(selectors[index]).filter(function() {
        return $(this).is(':appeared');
      });

      $appeared.trigger('appear', [$appeared]);

      if ($prior_appeared[index]) {
        var $disappeared = $prior_appeared[index].not($appeared);
        $disappeared.trigger('disappear', [$disappeared]);
      }
      $prior_appeared[index] = $appeared;
    }
  };

  function add_selector(selector) {
    selectors.push(selector);
    $prior_appeared.push();
  }

  // "appeared" custom filter
  $.expr[':']['appeared'] = function(element) {
    var $element = $(element);
    if (!$element.is(':visible')) {
      return false;
    }

    var window_left = $window.scrollLeft();
    var window_top = $window.scrollTop();
    var offset = $element.offset();
    var left = offset.left;
    var top = offset.top;

    if (top + $element.height() >= window_top &&
        top - ($element.data('appear-top-offset') || 0) <= window_top + $window.height() &&
        left + $element.width() >= window_left &&
        left - ($element.data('appear-left-offset') || 0) <= window_left + $window.width()) {
      return true;
    } else {
      return false;
    }
  };

  $.fn.extend({
    // watching for element's appearance in browser viewport
    appear: function(options) {
      var opts = $.extend({}, defaults, options || {});
      var selector = this.selector || this;
      if (!check_binded) {
        var on_check = function() {
          if (check_lock) {
            return;
          }
          check_lock = true;

          setTimeout(process, opts.interval);
        };

        $(window).scroll(on_check).resize(on_check);
        check_binded = true;
      }

      if (opts.force_process) {
        setTimeout(process, opts.interval);
      }
      add_selector(selector);
      return $(selector);
    }
  });

  $.extend({
    // force elements's appearance check
    force_appear: function() {
      if (check_binded) {
        process();
        return true;
      }
      return false;
    }
  });
})(function() {
  if (typeof module !== 'undefined') {
    // Node
    return require('jquery');
  } else {
    return jQuery;
  }
}());

!function(e,n){"function"==typeof define&&define.amd?define(n):"object"==typeof exports?module.exports=n(require,exports,module):e.ouibounce=n()}(this,function(e,n,o){return function(e,n){"use strict";function o(e,n){return"undefined"==typeof e?n:e}function i(e){var n=24*e*60*60*1e3,o=new Date;return o.setTime(o.getTime()+n),"; expires="+o.toUTCString()}function t(){s()||(L.addEventListener("mouseleave",u),L.addEventListener("mouseenter",r),L.addEventListener("keydown",c))}function u(e){e.clientY>k||(D=setTimeout(m,y))}function r(){D&&(clearTimeout(D),D=null)}function c(e){g||e.metaKey&&76===e.keyCode&&(g=!0,D=setTimeout(m,y))}function d(e,n){return a()[e]===n}function a(){for(var e=document.cookie.split("; "),n={},o=e.length-1;o>=0;o--){var i=e[o].split("=");n[i[0]]=i[1]}return n}function s(){return d(T,"true")&&!v}function m(){s()||(e&&(e.style.display="block"),E(),f())}function f(e){var n=e||{};"undefined"!=typeof n.cookieExpire&&(b=i(n.cookieExpire)),n.sitewide===!0&&(w=";path=/"),"undefined"!=typeof n.cookieDomain&&(x=";domain="+n.cookieDomain),"undefined"!=typeof n.cookieName&&(T=n.cookieName),document.cookie=T+"=true"+b+x+w,L.removeEventListener("mouseleave",u),L.removeEventListener("mouseenter",r),L.removeEventListener("keydown",c)}var l=n||{},v=l.aggressive||!1,k=o(l.sensitivity,20),p=o(l.timer,1e3),y=o(l.delay,0),E=l.callback||function(){},b=i(l.cookieExpire)||"",x=l.cookieDomain?";domain="+l.cookieDomain:"",T=l.cookieName?l.cookieName:"viewedOuibounceModal",w=l.sitewide===!0?";path=/":"",D=null,L=document.documentElement;setTimeout(t,p);var g=!1;return{fire:m,disable:f,isDisabled:s}}});


(function() {
    var articleReadDetector = $('#article-read-detector');

    articleReadDetector.appear();
    articleReadDetector.on('appear', function(event, elements) {
        ouibounce(false,
            {
                delay: 500,
                sitewide: true,
                callback: function() { 
                    $('#ouibounce-modal').modal('show');
                }
            });

        articleReadDetector.off('appear'); 
        
        ga('send', 'event', 'article', 'read', 'The State of Things');
        
    });
})();
</script>


                </div>
            <div>
            
        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <!-- Nothing to see here -->

</div>
</footer>
    




<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="http://emmanuelrosa.com/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="http://emmanuelrosa.com/javascripts/modernizr-14450bf93252c8e5cc9ff5944c8ff121.js"></script>



       <nav class="navbar navbar-default navbar-fixed-bottom">
        <div class="container">
            <p class="navbar-text navbar-left">
                Copyright &copy; 2016 - Emmanuel Rosa
            </p>
            <p class="navbar-text navbar-right">
                
            </p>
        </div>
       </nav>
  </body>
</html>
