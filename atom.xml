<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom"><title><![CDATA[EmmanuelRosa.com]]></title><link href="http://emmanuelrosa.com/atom.xml" rel="self"/><link href="http://emmanuelrosa.com/"/><updated>2015-12-22T10:31:21-05:00</updated><id>http://emmanuelrosa.com/</id><author><name><![CDATA[Emmanuel Rosa]]></name></author><generator uri="http://sysgears.com/grain/">Grain</generator><entry><title type="html"><![CDATA[The State of Things]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/the-state-of-things/"/><updated>2015-12-22T10:31:21-05:00</updated><id>eb801b50c35fc4a8dc47254d390d1f04</id><content type="html"><![CDATA[<p>As a programmer you've either yet to, or have already, coded a state machine; for the remainder of this article, I'll assume the latter. First, a little bit of history.</p>
<h2>The monkey-patch</h2>
<p>In its most simplistic implementation, a state machine is coded as a series of <em>flags</em>: variables whose combination of values <em>mean</em> something.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">double</span> <span class="n">currency</span>
</span><span class='line'><span class="kt">int</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Take action based on current state.</span>
</span><span class='line'><span class="k">if</span><span class="o">(</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// No currency state</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">currency</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Has currency state</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Sold out state</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h2>The proverbial wheel</h2>
<p>A step above this crude monkey-patched state machine is initializing and maintaining the current state in a variable.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SOLD_OUT</span><span class="o">,</span>
</span><span class='line'>    <span class="n">NO_CURRENCY</span><span class="o">,</span>
</span><span class='line'>    <span class="n">HAS_CURRENCY</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">State</span> <span class="n">state</span>
</span><span class='line'><span class="kt">double</span> <span class="n">currency</span>
</span><span class='line'><span class="kt">int</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Set initial state.</span>
</span><span class='line'><span class="k">if</span><span class="o">(</span><span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">NO_CURRENCY</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">currency</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Take action based on current state.</span>
</span><span class='line'><span class="k">switch</span><span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nl">SOLD_OUT:</span>
</span><span class='line'>        <span class="c1">// Do something.</span>
</span><span class='line'>        <span class="k">break</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Then came along the state machine design pattern, which for the purpose of this article I'll refer to as a compile-time state machine.</p>
<h1>The compile-time state machine</h1>
<p>You may be onto me. I've hinted at my yet-to-be-revealed hypothesis. But, as I was saying, the state machine design pattern suggests representing each state as a class and having a mechanism to maintain the current state and context.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="yes"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="320px" style="width:437px;height:320px;" version="1.1" viewBox="0 0 437 320" width="437px"><defs><filter height="300%" id="f1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><rect fill="#FEFECE" filter="url(#f1)" height="73.9102" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="6" y="129" /><ellipse cx="21" cy="145" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M23.9731,150.6431 Q23.3921,150.9419 22.7529,151.0913 Q22.1138,151.2407 21.4082,151.2407 Q18.9014,151.2407 17.5815,149.5889 Q16.2617,147.937 16.2617,144.8159 Q16.2617,141.6865 17.5815,140.0347 Q18.9014,138.3828 21.4082,138.3828 Q22.1138,138.3828 22.7612,138.5322 Q23.4087,138.6816 23.9731,138.9805 L23.9731,141.7031 Q23.3423,141.1221 22.7488,140.8523 Q22.1553,140.5825 21.5244,140.5825 Q20.1797,140.5825 19.4949,141.6492 Q18.8101,142.7158 18.8101,144.8159 Q18.8101,146.9077 19.4949,147.9744 Q20.1797,149.041 21.5244,149.041 Q22.1553,149.041 22.7488,148.7712 Q23.3423,148.5015 23.9731,147.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="44" x="35" y="149.5352">Context</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="81" y1="161" y2="161" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="81" y1="169" y2="169" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="12" y="183.6348">handle()</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="50" x="12" y="196.5898">setState()</text><rect fill="#FEFECE" filter="url(#f1)" height="48" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="12" y="263" /><ellipse cx="27" cy="279" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M29.9731,284.6431 Q29.3921,284.9419 28.7529,285.0913 Q28.1138,285.2407 27.4082,285.2407 Q24.9014,285.2407 23.5815,283.5889 Q22.2617,281.937 22.2617,278.8159 Q22.2617,275.6865 23.5815,274.0347 Q24.9014,272.3828 27.4082,272.3828 Q28.1138,272.3828 28.7612,272.5322 Q29.4087,272.6816 29.9731,272.9805 L29.9731,275.7031 Q29.3423,275.1221 28.7488,274.8523 Q28.1553,274.5825 27.5244,274.5825 Q26.1797,274.5825 25.4949,275.6492 Q24.8101,276.7158 24.8101,278.8159 Q24.8101,280.9077 25.4949,281.9744 Q26.1797,283.041 27.5244,283.041 Q28.1553,283.041 28.7488,282.7712 Q29.3423,282.5015 29.9731,281.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="32" x="41" y="283.5352">Client</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="13" x2="75" y1="295" y2="295" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="13" x2="75" y1="303" y2="303" /><rect fill="#FEFECE" filter="url(#f1)" height="60.9551" style="stroke: #A80036; stroke-width: 1.5;" width="60" x="121" y="8" /><ellipse cx="136" cy="24" fill="#B4A7E5" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M131.9277,19.7651 L131.9277,17.6069 L139.3071,17.6069 L139.3071,19.7651 L136.8418,19.7651 L136.8418,27.8418 L139.3071,27.8418 L139.3071,30 L131.9277,30 L131.9277,27.8418 L134.3931,27.8418 L134.3931,19.7651 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="28" x="150" y="28.5352">State</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="122" x2="180" y1="40" y2="40" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="122" x2="180" y1="48" y2="48" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="127" y="62.6348">handle()</text><polygon fill="#FBFB77" filter="url(#f1)" points="216,26,216,51.3105,428,51.3105,428,36,418,26,216,26" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="#FBFB77" points="216,26,216,34.5,181.059,38.5,216,42.5,216,51.3105,428,51.3105,428,36,418,26,216,26" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="418" x2="418" y1="26" y2="36" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="428" x2="418" y1="36" y2="36" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="222" y="43.5684">handle() has access to context</text><rect fill="#FEFECE" filter="url(#f1)" height="60.9551" style="stroke: #A80036; stroke-width: 1.5;" width="68" x="117" y="135.5" /><ellipse cx="132" cy="151.5" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M134.9731,157.1431 Q134.3921,157.4419 133.7529,157.5913 Q133.1138,157.7407 132.4082,157.7407 Q129.9014,157.7407 128.5815,156.0889 Q127.2617,154.437 127.2617,151.3159 Q127.2617,148.1865 128.5815,146.5347 Q129.9014,144.8828 132.4082,144.8828 Q133.1138,144.8828 133.7612,145.0322 Q134.4087,145.1816 134.9731,145.4805 L134.9731,148.2031 Q134.3423,147.6221 133.7488,147.3523 Q133.1553,147.0825 132.5244,147.0825 Q131.1797,147.0825 130.4949,148.1492 Q129.8101,149.2158 129.8101,151.3159 Q129.8101,153.4077 130.4949,154.4744 Q131.1797,155.541 132.5244,155.541 Q133.1553,155.541 133.7488,155.2712 Q134.3423,155.0015 134.9731,154.4204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="36" x="146" y="156.0352">StateA</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="118" x2="184" y1="167.5" y2="167.5" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="118" x2="184" y1="175.5" y2="175.5" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="123" y="190.1348">handle()</text><rect fill="#FEFECE" filter="url(#f1)" height="60.9551" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="220.5" y="135.5" /><ellipse cx="235.5" cy="151.5" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M238.4731,157.1431 Q237.8921,157.4419 237.2529,157.5913 Q236.6138,157.7407 235.9082,157.7407 Q233.4014,157.7407 232.0815,156.0889 Q230.7617,154.437 230.7617,151.3159 Q230.7617,148.1865 232.0815,146.5347 Q233.4014,144.8828 235.9082,144.8828 Q236.6138,144.8828 237.2612,145.0322 Q237.9087,145.1816 238.4731,145.4805 L238.4731,148.2031 Q237.8423,147.6221 237.2488,147.3523 Q236.6553,147.0825 236.0244,147.0825 Q234.6797,147.0825 233.9949,148.1492 Q233.3101,149.2158 233.3101,151.3159 Q233.3101,153.4077 233.9949,154.4744 Q234.6797,155.541 236.0244,155.541 Q236.6553,155.541 237.2488,155.2712 Q237.8423,155.0015 238.4731,154.4204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="35" x="249.5" y="156.0352">StateB</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="221.5" x2="286.5" y1="167.5" y2="167.5" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="221.5" x2="286.5" y1="175.5" y2="175.5" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="44" x="226.5" y="190.1348">handle()</text><path d="M44,203.027 C44,222.4547 44,245.8588 44,262.8505 " fill="none" style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 7.0,7.0;" /><path d="M117.081,79.284 C106.413,91.796 94.5402,105.722 83.5188,118.648 " fill="none" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="#A80036" points="74.9017,128.755,81.8383,126.7844,82.6872,119.6234,75.7506,121.594,74.9017,128.755" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="#A80036" points="125.642,69.242,116.7591,73.4957,122.3981,73.0469,122.8469,78.6859,125.642,69.242" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="122.3981" x2="117.2085" y1="73.0469" y2="79.134" /><path d="M151,89.447 C151,105.047 151,121.749 151,135.472 " fill="none" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="none" points="144,89.242,151,69.242,158,89.242,144,89.242" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M188.311,84.961 C202.124,101.792 217.415,120.423 229.766,135.472 " fill="none" style="stroke: #A80036; stroke-width: 1.0;" /><polygon fill="none" points="182.687,89.143,175.41,69.242,193.509,80.261,182.687,89.143" style="stroke: #A80036; stroke-width: 1.0;" /></g></svg></p>
<p>When the state machine is used, it delegates work to the current state.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="yes"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="184px" style="width:225px;height:184px;" version="1.1" viewBox="0 0 225 184" width="225px"><defs><filter height="300%" id="f1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="37" x2="37" y1="38.4883" y2="146.4199" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="112" x2="112" y1="38.4883" y2="146.4199" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="194.5" x2="194.5" y1="38.4883" y2="146.4199" /><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="23.5352">Client</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="145.4199" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="165.9551">Client</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="76" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="83" y="23.5352">Context</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="69" x="76" y="145.4199" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="55" x="83" y="165.9551">Context</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="48" x="168.5" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="175.5" y="23.5352">State</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="48" x="168.5" y="145.4199" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="175.5" y="165.9551">State</text><polygon fill="#A80036" points="100.5,65.4883,110.5,69.4883,100.5,73.4883,104.5,69.4883" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="37" x2="106.5" y1="69.4883" y2="69.4883" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="44" y="65.0566">handle()</text><polygon fill="#A80036" points="182.5,94.7988,192.5,98.7988,182.5,102.7988,186.5,98.7988" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="112.5" x2="188.5" y1="98.7988" y2="98.7988" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="119.5" y="94.3672">handle()</text><polygon fill="#A80036" points="123.5,124.1094,113.5,128.1094,123.5,132.1094,119.5,128.1094" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="117.5" x2="193.5" y1="128.1094" y2="128.1094" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="129.5" y="123.6777">setState()</text></g></svg></p>
<p>Here is an implementation of a compile-time state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">interface</span> <span class="nc">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> 
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">StateImpl</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;fill&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;insertCurrency&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;purchase&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="nf">createException</span><span class="o">(</span><span class="s1">&#39;eject&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">Exception</span> <span class="nf">createException</span><span class="o">(</span><span class="n">String</span> <span class="n">actionName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&quot;&#39;$actionName&#39; is an invalid action for state &#39;${getClass().name}&#39;.&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@groovy.transform.TupleConstructor</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">SoldOut</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span> <span class="n">sm</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">+</span> <span class="n">count</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span> <span class="o">:</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">NoCurrency</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@groovy.transform.TupleConstructor</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">HasCurrency</span> <span class="kd">extends</span> <span class="n">StateImpl</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StateMachine</span> <span class="n">sm</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">--</span><span class="n">sm</span><span class="o">.</span><span class="na">inventory</span>
</span><span class='line'>        <span class="n">sm</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span> <span class="o">:</span> <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="kd">implements</span> <span class="n">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">inventory</span> 
</span><span class='line'>    <span class="n">State</span> <span class="n">state</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">soldOut</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">noCurrency</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">State</span> <span class="n">hasCurrency</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">StateEnum</span><span class="o">,</span> <span class="n">State</span><span class="o">&gt;</span> <span class="n">stateMap</span>    
</span><span class='line'>
</span><span class='line'>    <span class="kd">enum</span> <span class="n">StateEnum</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">SOLD_OUT</span><span class="o">,</span>
</span><span class='line'>        <span class="n">NO_CURRENCY</span><span class="o">,</span>
</span><span class='line'>        <span class="n">HAS_CURRENCY</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">(</span><span class="kt">int</span> <span class="n">inventory</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">inventory</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">soldOut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SoldOut</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</span><span class='line'>        <span class="n">noCurrency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NoCurrency</span><span class="o">()</span>
</span><span class='line'>        <span class="n">hasCurrency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HasCurrency</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</span><span class='line'>        
</span><span class='line'>        <span class="n">stateMap</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">SOLD_OUT</span><span class="o">):</span> <span class="n">soldOut</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">NO_CURRENCY</span><span class="o">):</span> <span class="n">noCurrency</span><span class="o">,</span>
</span><span class='line'>            <span class="o">(</span><span class="n">StateEnum</span><span class="o">.</span><span class="na">HAS_CURRENCY</span><span class="o">):</span> <span class="n">hasCurrency</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">state</span> <span class="o">=</span> <span class="n">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">noCurrency</span> <span class="o">:</span> <span class="n">soldOut</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">fill</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="n">count</span><span class="o">))</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">insertCurrency</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">purchase</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">purchase</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">StateMachine</span><span class="o">.</span><span class="na">StateEnum</span> <span class="nf">eject</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">changeState</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">eject</span><span class="o">())</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kd">private</span> <span class="n">StateEnum</span> <span class="nf">changeState</span><span class="o">(</span><span class="n">StateEnum</span> <span class="n">newState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="n">state</span> <span class="o">=</span> <span class="n">stateMap</span><span class="o">[</span><span class="n">newState</span><span class="o">]</span>
</span><span class='line'>         
</span><span class='line'>         <span class="k">return</span> <span class="n">newState</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;SoldOut&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The <code>State</code> interface defines the available actions/transitions. But since each state only needs to implement a subset of those actions, I added <code>StateImpl</code> to provide default implementations. In comparison to previous approaches, the state's business logic is spread out across multiple classes. Finally, construction of the state machine is handled by <code>StateMachine</code>'s constructor.</p>
<p>We can learn a few things from compile-time state machines:</p>
<ul>
<li>Each state may only need to implement a subset of the available actions.</li>
<li>A state machine is assembled from various components: states, context, and a supervisor (the state machine itself).</li>
<li>State machines are quite similar in functionality, yet each needs a concrete implementation.</li>
</ul>
<p>And it is this last point that I want to emphasize. Even though state machines do the same thing, a complete compile-time state machine must be coded for each implementation. This is due to the static dispatching that's used when calling methods. Consider the following example:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="o">{</span> <span class="cm">/* I don&#39;t declare any methods. Ha ha! */</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">doSomething</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-danger" role="alert">groovy.lang.MissingMethodException: No signature of method: StateMachine.doSomething() is applicable for argument types: () values: []
Possible solutions: toString(), toString()</div>
</p>
<p>It results in an exception because the <code>StateMachine.doSomething()</code> method was not found. But languages with multiple/dynamic dispatching, such as Groovy, allow us to intercept these missing methods as they are called and do something useful. This is the basis for what I call a run-time state machine.</p>
<h2>The run-time state machine</h2>
<p>Simply put, a state machine consists of:</p>
<ul>
<li>a list of possible states</li>
<li>the ability to delegate work to the current state</li>
<li>the ability to change states</li>
<li>and maybe some context to maintain data across state changes</li>
</ul>
<p>That's really it.</p>
<p>With languages which use dynamic dispatching to execute methods, it's possible to create a <em>run-time state machine</em>. By this I mean a single set of classes which can be used to create various state machine implementations.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="yes"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="359px" style="width:172px;height:359px;" version="1.1" viewBox="0 0 172 359" width="172px"><defs><filter height="300%" id="f1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><rect fill="#FEFECE" filter="url(#f1)" height="99.8203" style="stroke: #A80036; stroke-width: 1.5;" width="157" x="6" y="142" /><ellipse cx="43.5" cy="158" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M46.4731,163.6431 Q45.8921,163.9419 45.2529,164.0913 Q44.6138,164.2407 43.9082,164.2407 Q41.4014,164.2407 40.0815,162.5889 Q38.7617,160.937 38.7617,157.8159 Q38.7617,154.6865 40.0815,153.0347 Q41.4014,151.3828 43.9082,151.3828 Q44.6138,151.3828 45.2612,151.5322 Q45.9087,151.6816 46.4731,151.9805 L46.4731,154.7031 Q45.8423,154.1221 45.2488,153.8523 Q44.6553,153.5825 44.0244,153.5825 Q42.6797,153.5825 41.9949,154.6492 Q41.3101,155.7158 41.3101,157.8159 Q41.3101,159.9077 41.9949,160.9744 Q42.6797,162.041 44.0244,162.041 Q44.6553,162.041 45.2488,161.7712 Q45.8423,161.5015 46.4731,160.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="75" x="62.5" y="162.5352">StateMachine</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="162" y1="174" y2="174" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="72" x="12" y="188.6348">Map : context</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="145" x="12" y="201.5898">Map&lt;String, State&gt; : states</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="101" x="12" y="214.5449">State : currentState</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="162" y1="220.8652" y2="220.8652" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="90" x="12" y="235.5">methodMissing()</text><rect fill="#FEFECE" filter="url(#f1)" height="73.9102" style="stroke: #A80036; stroke-width: 1.5;" width="85" x="42" y="8" /><ellipse cx="68.25" cy="24" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M71.2231,29.6431 Q70.6421,29.9419 70.0029,30.0913 Q69.3638,30.2407 68.6582,30.2407 Q66.1514,30.2407 64.8315,28.5889 Q63.5117,26.937 63.5117,23.8159 Q63.5117,20.6865 64.8315,19.0347 Q66.1514,17.3828 68.6582,17.3828 Q69.3638,17.3828 70.0112,17.5322 Q70.6587,17.6816 71.2231,17.9805 L71.2231,20.7031 Q70.5923,20.1221 69.9988,19.8523 Q69.4053,19.5825 68.7744,19.5825 Q67.4297,19.5825 66.7449,20.6492 Q66.0601,21.7158 66.0601,23.8159 Q66.0601,25.9077 66.7449,26.9744 Q67.4297,28.041 68.7744,28.041 Q69.4053,28.041 69.9988,27.7712 Q70.5923,27.5015 71.2231,26.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="28" x="84.75" y="28.5352">State</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="43" x2="126" y1="40" y2="40" /><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="70" x="48" y="54.6348">String : name</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="70" x="48" y="67.5898">Map : actions</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="43" x2="126" y1="73.9102" y2="73.9102" /><rect fill="#FEFECE" filter="url(#f1)" height="48" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="52.5" y="302" /><ellipse cx="67.5" cy="318" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;" /><path d="M70.4731,323.6431 Q69.8921,323.9419 69.2529,324.0913 Q68.6138,324.2407 67.9082,324.2407 Q65.4014,324.2407 64.0815,322.5889 Q62.7617,320.937 62.7617,317.8159 Q62.7617,314.6865 64.0815,313.0347 Q65.4014,311.3828 67.9082,311.3828 Q68.6138,311.3828 69.2612,311.5322 Q69.9087,311.6816 70.4731,311.9805 L70.4731,314.7031 Q69.8423,314.1221 69.2488,313.8523 Q68.6553,313.5825 68.0244,313.5825 Q66.6797,313.5825 65.9949,314.6492 Q65.3101,315.7158 65.3101,317.8159 Q65.3101,319.9077 65.9949,320.9744 Q66.6797,322.041 68.0244,322.041 Q68.6553,322.041 69.2488,321.7712 Q69.8423,321.5015 70.4731,320.9204 Z " /><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="32" x="81.5" y="322.5352">Client</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="53.5" x2="115.5" y1="334" y2="334" /><line style="stroke: #A80036; stroke-width: 1.5;" x1="53.5" x2="115.5" y1="342" y2="342" /><path d="M84.5,242.152 C84.5,262.5293 84.5,285.2029 84.5,301.6717 " fill="none" style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 7.0,7.0;" /><path d="M84.5,82.216 C84.5,100.25 84.5,122.321 84.5,141.858 " fill="none" style="stroke: #A80036; stroke-width: 1.0;" /></g></svg></p>
<p>When an action is executed against the state machine and it delegates to the current state, the state looks up the action in its <code>Map</code> of actions and executes it.</p>
<p><?xml version="1.0" encoding="UTF-8" standalone="yes"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="272px" style="width:479px;height:272px;" version="1.1" viewBox="0 0 479 272" width="479px"><defs><filter height="300%" id="f1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="37" x2="37" y1="38.4883" y2="234.3516" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="130" x2="130" y1="38.4883" y2="234.3516" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="255.5" x2="255.5" y1="38.4883" y2="234.3516" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="369" x2="369" y1="38.4883" y2="234.3516" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="438" x2="438" y1="38.4883" y2="234.3516" /><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="23.5352">Client</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="54" x="8" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="15" y="253.8867">Client</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="76" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="83" y="23.5352">StateMachine</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="105" x="76" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="91" x="83" y="253.8867">StateMachine</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="48" x="229.5" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="236.5" y="23.5352">State</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="48" x="229.5" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="34" x="236.5" y="253.8867">State</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="43" x="346" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="353" y="23.5352">Map</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="43" x="346" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="353" y="253.8867">Map</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="403" y="3" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="410" y="23.5352">Closure</text><rect fill="#FEFECE" filter="url(#f1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="67" x="403" y="233.3516" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="53" x="410" y="253.8867">Closure</text><polygon fill="#A80036" points="118.5,65.4883,128.5,69.4883,118.5,73.4883,122.5,69.4883" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="37" x2="124.5" y1="69.4883" y2="69.4883" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="44" y="65.0566">handle()</text><polygon fill="#A80036" points="243.5,94.7988,253.5,98.7988,243.5,102.7988,247.5,98.7988" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="130.5" x2="249.5" y1="98.7988" y2="98.7988" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="137.5" y="94.3672">handle()</text><polygon fill="#A80036" points="357.5,124.1094,367.5,128.1094,357.5,132.1094,361.5,128.1094" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="255.5" x2="363.5" y1="128.1094" y2="128.1094" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="262.5" y="123.6777">getAt('handle')</text><polygon fill="#A80036" points="266.5,153.4199,256.5,157.4199,266.5,161.4199,262.5,157.4199" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="260.5" x2="368.5" y1="157.4199" y2="157.4199" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="272.5" y="152.9883">Closure</text><polygon fill="#A80036" points="426.5,182.7305,436.5,186.7305,426.5,190.7305,430.5,186.7305" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0;" x1="255.5" x2="432.5" y1="186.7305" y2="186.7305" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="262.5" y="182.2988">call()</text><polygon fill="#A80036" points="141.5,212.041,131.5,216.041,141.5,220.041,137.5,216.041" style="stroke: #A80036; stroke-width: 1.0;" /><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="135.5" x2="254.5" y1="216.041" y2="216.041" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="147.5" y="211.6094">next state name</text></g></svg></p>
<p>I went a different route with the state changes: the current <code>State</code> returns the name of the next state to the <code>StateMachine</code>, which then changes the current <code>State</code>. Here's an implementation:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">StateMachine</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Map</span> <span class="n">context</span>
</span><span class='line'>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">State</span><span class="o">&gt;</span> <span class="n">states</span>
</span><span class='line'>    <span class="n">State</span> <span class="n">state</span>
</span><span class='line'>    
</span><span class='line'>    <span class="kt">def</span> <span class="nf">methodMissing</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">def</span> <span class="n">action</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="na">actions</span><span class="o">[</span><span class="n">name</span><span class="o">]</span>
</span><span class='line'>        
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">action</span> <span class="k">instanceof</span> <span class="n">GroovyCallable</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">action</span><span class="o">.</span><span class="na">delegate</span> <span class="o">=</span> <span class="n">context</span>
</span><span class='line'>            <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="o">[</span><span class="n">action</span><span class="o">(*</span><span class="n">args</span><span class="o">)]</span> <span class="o">?:</span> <span class="n">state</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">null</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">action</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="o">[</span><span class="n">action</span><span class="o">]</span> <span class="o">?:</span> <span class="n">state</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s2">&quot;&#39;$name&#39; is an invalid action for state &#39;$state.name&#39;.&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>        
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">State</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>    <span class="n">Map</span> <span class="n">actions</span> <span class="o">=</span> <span class="o">[:]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>The example above consists of just two classes: <code>StateMachine</code> and <code>State</code>. <code>StateMachine</code> attempts to delegate method calls to the current <code>State</code>, and then changes the current state based on the method's output. <code>State.actions</code> is a list of supported actions/transitions. A <em>context</em> object is made the delegate of each action so that information can be maintained across state changes. Being generic, this state machine does not have state implementations; It doesn't have any business logic. Lets see what it's like to construct an implementation using this generic state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">sm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StateMachine</span><span class="o">(</span>
</span><span class='line'>    <span class="nl">context:</span> <span class="o">[</span><span class="nl">inventory:</span> <span class="mi">0</span><span class="o">],</span>
</span><span class='line'>    <span class="nl">states:</span> <span class="o">[</span>
</span><span class='line'>        <span class="nl">SoldOut:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">fill:</span> <span class="o">{</span> <span class="n">count</span> <span class="o">-&gt;</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">=</span> <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">+</span> <span class="n">count</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;NoCurrency&#39;</span> <span class="o">:</span> <span class="s1">&#39;SoldOut&#39;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">],</span>
</span><span class='line'>        <span class="nl">NoCurrency:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">insertCurrency:</span> <span class="s1">&#39;HasCurrency&#39;</span>
</span><span class='line'>        <span class="o">],</span>
</span><span class='line'>        <span class="nl">HasCurrency:</span> <span class="o">[</span>
</span><span class='line'>            <span class="nl">purchase:</span> <span class="o">{</span>
</span><span class='line'>                <span class="o">--</span><span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span>
</span><span class='line'>                <span class="n">delegate</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;NoCurrency&#39;</span> <span class="o">:</span> <span class="s1">&#39;SoldOut&#39;</span>
</span><span class='line'>            <span class="o">},</span>
</span><span class='line'>            <span class="nl">eject:</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>    <span class="o">].</span><span class="na">collectEntries</span> <span class="o">{</span> <span class="n">name</span><span class="o">,</span> <span class="n">actions</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">name</span><span class="o">,</span> <span class="k">new</span> <span class="n">State</span><span class="o">(</span><span class="nl">name:</span> <span class="n">name</span><span class="o">,</span> <span class="nl">actions:</span> <span class="n">actions</span><span class="o">)]</span> <span class="o">}</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>The example above uses the generic state machine to <em>build</em> a concrete implementation. The <code>State</code> instances are build from a <code>Map</code>. Each <code>Map</code> entry represents a state, with the value being a <code>Map</code> of <code>Closure</code>s (or <code>String</code>s). Each <code>Closure</code> implements a state action.</p>
<p>As a bonus, if the action merely changes to another state, then a <code>String</code> with the state's name can be used instead of a <code>Closure</code>.</p>
<p>Notice how unlike the compile-time state machine, here each state only needs to implement the actions that pertain to the state. No dummy method implementations are needed whatsoever.</p>
<p><div class="alert alert-info" role="alert"><p>Actually, the <em>dummy</em> implementation is provided by the state machine.</p>
</div>
</p>
<p>Here's what it's like to use the state machine.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">state</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">inventory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">sm</span><span class="o">.</span><span class="na">states</span><span class="o">.</span><span class="na">NoCurrency</span> <span class="o">:</span> <span class="n">sm</span><span class="o">.</span><span class="na">states</span><span class="o">.</span><span class="na">SoldOut</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">fill</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;NoCurrency&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">insertCurrency</span><span class="o">()</span>
</span><span class='line'><span class="n">sm</span><span class="o">.</span><span class="na">purchase</span><span class="o">()</span>
</span><span class='line'><span class="k">assert</span> <span class="n">sm</span><span class="o">.</span><span class="na">state</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;SoldOut&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>It works just like a compile-time state machine, and uses 44% less code. The most glaring difference being that the initial state must be set. Since we're dealing with a generic state machine, it has no idea which state to start with.</p>
<h1>Making it better</h1>
<p>I think the run-time state machine is rather neat. Particularly the fact that it can easily be reused to implement any number of state machines. However, there's one thing that bugs me about it: building one is rather yucky. Tune in next week  to see a better way to <em>build</em> run-time state machines.</p>
]]></content></entry><entry><title type="html"><![CDATA[Grails domain class associations]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/grails-domain-class-associations/"/><updated>2015-12-22T10:31:21-05:00</updated><id>f2d6a065bb3b8db98641f90c390a8823</id><content type="html"><![CDATA[<p>When working with Grails domain models I often find myself wondering: <em>How is this modeled in the database?</em></p>
<p>The combinations of <code>hasMany</code>, <code>belongsTo</code>, (and the occasional <code>hasOne</code>) lead to the <a href="#onetomany">one-to-many</a>, <a href="#manytomany">many-to-many</a>, <a href="#manytoone">many-to-one</a>, and <a href="#onetoone">one-to-one</a> associations. But how? What are these combinations? <!--more-->Well, feast your eyes on some Groovy and relational database porn.</p>
<h1><a name="onetomany"></a>One-to-many</h1>
<p>In the first example, an <code>Author</code> has many <code>Book</code>s, producing a one-to-many uni-directional relationship. Uni-directional meaning that an <code>Author</code> has a reference to its <code>Book</code>s, however, a <code>Book</code> has no clue about its <code>Author</code>. The association is created with the <code>hasMany</code> static property in the <code>Author</code> domain class.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">books:</span> <span class="n">Book</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/one-to-many-c2eba0c1097bf6df3fa1cdf1c5eac252.png' alt='One-to-many' >
</p>
<p>As shown in the database diagram, Grails creates a <em>join table</em> to represent the one-to-many association. The join table has two foreign key columns: the <code>Author</code>'s ID, and the <code>Book</code>'s ID.</p>
<p>It's worth nothing, since the <code>Book</code> does not have a reference to its <code>Author</code>, it's possible for multiple <code>Author</code>s to have the same <code>Book</code>. Notice how the <code>author_book</code> table makes this possible. To have Grails enforce that you want a <code>Book</code> to have a single <code>Author</code>, you'll need a bi-directional one-to-many association.</p>
<h2>Bi-directional</h2>
<p>With a bi-directional association, a <code>Book</code> is given a property which references its <code>Author</code>. This is done by adding a <code>belongsTo</code> static property to the <code>Book</code> class.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">books:</span> <span class="n">Book</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="o">[</span><span class="nl">author:</span> <span class="n">Author</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/one-to-many-bi-dfbc551ac9b7bfed5c9447447dbbea14.png' alt='One-to-many bi-directional' >
</p>
<p>Now, a foreign key is added to the <code>Book</code> containing the <code>Author</code>'s ID. The join table is simply not used anymore. This implies that without an <code>Author</code> there can be no <code>Book</code>. Put differently, an <code>Author</code> <em>owns</em> its <code>Book</code>s.</p>
<h1><a name="manytomany"></a>Many-to-many</h1>
<p>A many-to-many association is created by using a <code>hasMany</code> static property in both domain classes. <strong>And</strong>, by using a <code>belongsTo</code> static property lacking a back-reference in the <code>Book</code> domain class.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">books:</span> <span class="n">Book</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">authors:</span> <span class="n">Author</span><span class="o">]</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="n">Author</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/many-to-many-3331d20a67053e0bfa999b3b56daa314.png' alt='Many-to-many' >
</p>
<p>Like a uni-directional one-to-many, a many-to-many association uses a join table. In fact, at the database level it looks identical to a uni-directional one-to-many.</p>
<h1><a name="manytoone"></a>Many-to-one</h1>
<p>Creating a uni-directional many-to-one association doesn't require <code>hasMany</code> or the like. It's just a matter of adding an instance property.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'>    <span class="n">Publisher</span> <span class="n">publisher</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Publisher</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/many-to-one-cccf0306a07ab1574ae646f8db21e9ce.png' alt='Many-to-one' >
</p>
<h2>Bi-directional</h2>
<p>A bi-directional many-to-one is created using the static <code>belongsTo</code> property. Surprisingly, this doesn't affect the database.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'>    <span class="n">Publisher</span> <span class="n">publisher</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Publisher</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="o">[</span><span class="nl">book:</span> <span class="n">Book</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h1><a name="onetoone"></a>One-to-one</h1>
<p>Finally, you get to see the static <code>hasOne</code> property in action!</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasOne</span> <span class="o">=</span> <span class="o">[</span><span class="nl">user:</span> <span class="n">User</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">username</span>
</span><span class='line'>    <span class="n">Author</span> <span class="n">author</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/one-to-one-c016839141ca5622bd8b36c28f5a359b.png' alt='One-to-one' >
</p>
<p>In the database, it looks just like a bi-directional one-to-many.</p>
<h1>Enlightenment</h1>
<p>As you've just read, it takes a precise combination of the <code>hasMany</code>, <code>belongsTo</code> and <code>hasOne</code> static properties, and sometimes an instance property, to assemble the various Grails domain class associations. Some are <em>self-explanatory</em>, others not so much. Either way, you may reference this guide when you need it.</p>
]]></content></entry><entry><title type="html"><![CDATA[Design Failure: A reflection of a mistaken Grails app domain model design]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/design-failure-a-reflection-of-a-mistaken-grails-app-domain-model-design/"/><updated>2015-12-22T10:31:21-05:00</updated><id>1f9110f0a04e368520552fa394207196</id><content type="html"><![CDATA[<p>Back in April of this year I took over the development of a client's Grails application. The app is simple:</p>
<ol>
<li>Business ideas flow into it</li>
<li>The ideas are displayed for people to vote on.</li>
<li>The top 3 voted ideas during a given week are deemed the winners. <em>(Still working on this one)</em></li>
</ol>
<p>Initially, once the weekly competition completed, the winning ideas became inaccessible because the view was designed to render only the ideas for the <em>current</em> competition. Yeah, talk about a brain fart.</p>
<!--more-->
<p>My solution was to simply keep track of all winning ideas using a new domain model. Besides, the <em>previous</em> and <em>current</em> competition stats were kept in two properties of the same domain class. It was a putrid situation in need of venting.</p>
<p><em>Great!</em>, I thought. <em>I know exactly what to do</em>. And so I proceeded with a new model similar to this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Competition</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Date</span> <span class="n">startDate</span>
</span><span class='line'>    <span class="n">Idea</span> <span class="n">idea</span>
</span><span class='line'>    <span class="n">Integer</span> <span class="n">votes</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">mapping</span> <span class="o">{</span>
</span><span class='line'>        <span class="nl">id:</span> <span class="nl">composite:</span> <span class="o">[</span><span class="s1">&#39;startDate&#39;</span><span class="o">,</span> <span class="s1">&#39;idea&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * The hashCode() and equals() dance.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Yeah... the problem should have been obvious to me, but it wasn't. Since each competition is identified by its start date, and each idea can be in a competition only once, I figured this was a logical solution.</p>
<p>And in fact, it works just fine. Recording a vote in a competition is simple:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">example</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Competition</span><span class="o">(</span><span class="nl">idea:</span> <span class="n">idea</span><span class="o">,</span> <span class="nl">startDate:</span> <span class="n">startDate</span><span class="o">)</span>
</span><span class='line'><span class="kt">def</span> <span class="n">competition</span> <span class="o">=</span> <span class="n">Competition</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">example</span><span class="o">)</span> <span class="o">?:</span> <span class="n">competition</span> 
</span><span class='line'>
</span><span class='line'><span class="n">competition</span><span class="o">.</span><span class="na">votes</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1">// or -= 1 for a down-vote</span>
</span><span class='line'><span class="n">competition</span><span class="o">.</span><span class="na">save</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>An existing <code>Competition</code> is used if possible, otherwise a new instance is created. No problem. Except... that a competition is supposed to be able to have multiple ideas. And while the <code>Competition</code> model does <em>work</em>, it's design doesn't reflect its purpose. If my design was by intention for performance or anoother technical reason, I would be content. But the fact remains that I blatantly overlooked the <em>concept</em> of a competition and instead fixated on the <em>implementation</em>. I'm not even going to discuss what I did with the services. I'd clear the room.</p>
<p>The code-smell remained elusive until the day I began working on a new feature and needed a list of the competitions; meaning a list of competition dates.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">competitionDates</span> <span class="o">=</span> <span class="n">Competition</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">projections</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">distinct</span><span class="o">(</span><span class="s1">&#39;startDate&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span> 
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>I had to use <em>DISTINCT</em>.</p>
<p>My days supporting horrid Microsoft Access databases taught me that having to use <em>DISTINCT</em> can be a sign of a... <em>ignorantly de-normalized</em> database. (I resisted the urge to use a more descriptive four-letter word)</p>
<h2>Redemption</h2>
<p>If you're like me, software architecture just rocks your socks off. When a particular problem enters my mind, there's no shutting it up until I solve it. It doesn't care that I go hungry, or that my eyes itch, or that I <em>really</em> need to visit the toilet. It demands my full attention; Emmanuel be damned.</p>
<p>OK, maybe I exaggerated a bit. In this case the solution is rather simple:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Competition</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Date</span> <span class="n">startDate</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">ideas:</span> <span class="n">CompetitionIdea</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">mapping</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">id</span> <span class="nl">generator:</span> <span class="s1">&#39;assigned&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;startDate&#39;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">CompetitionIdea</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Idea</span> <span class="n">idea</span>
</span><span class='line'>    <span class="n">Integer</span> <span class="n">votes</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="o">[</span><span class="nl">competition:</span> <span class="n">Competition</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">idea</span> <span class="nl">unique:</span> <span class="s1">&#39;competition&#39;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now a competition can indeed have multiple ideas.</p>
<p>Aaaahhhhh. Now I can relieve myself in peace <span class="fa fa-smile-o"></span></p>
<h2>Lesson learned</h2>
<p>I don't recall my thought the process when developing the <code>Competition</code> domain model. But because I'm a SQL aficionado, I can only assume that my thinking was too data-centric, too early. By focusing on how to store the data I didn't give enough attention to the concepts the data represents. That's something for me to watch out for in the future.</p>
<p>Speaking of software architecture, have you read any of <a href="http://aosabook.org/en/index.html">The Architecture of Open Source Applications</a> books? As of now there are three books and a fourth is on the way. Written by the developers themselves, the books cover the design of various open source applications. They make for a good read.</p>
]]></content></entry><entry><title type="html"><![CDATA[Grails Domain Class Inheritance]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/grails-domain-class-inheritance/"/><updated>2015-12-22T10:31:21-05:00</updated><id>2e55fc1b4b76223bff36c890792b077d</id><content type="html"><![CDATA[<p>Ever wonder what happens at the database level when you use GORM's domain class inheritance? What's the difference between <em>table-per-hierarchy</em> and <em>table-per-subclass</em> inheritance? That's what this article is all about.</p>
<!--more-->
<p>Grails' database mapping layer GORM provides two ways to achieve domain class inheritance with polymorphic GORM queries. Let me introduce you to the first method, the default in Grails and the right choice for most use cases. Let's give a round of applause to... <em>table-per-hierarchy</em> inheritance!</p>
<h1>Table-per-hierarchy</h1>
<p>Table-per-hierarchy inheritance means that the super-class class and all its sub-classes share the same database table. Take a look at these domain classes:</p>
<figure class='code'><figcaption><span>Employee.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">String</span> <span class="n">firstName</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">lastName</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>Supervisor.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Supervisor</span> <span class="kd">extends</span> <span class="n">Employee</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">subordinates:</span> <span class="n">Employee</span><span class="o">]</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>An <code>Employee</code> contains <code>firstName</code> and <code>lastName</code> properties. A <code>Supervisor</code> is a subclass of <code>Employee</code> and only adds the ability to have subordinates; simply a collection of <code>Employee</code>s. To get a good understanding of how this works in practice, lets take a peak at the database.</p>
<h2>The database tables</h2>
<p>GORM implements the two domain classes as one database table.</p>
<p><div class="panel panel-default">
    
        <div class="panel-heading">
            <h3 class="panel-title">EMPLOYEE table</h3>
        </div>
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>ID</th>
                    
                        <th>VERSION</th>
                    
                        <th>FIRST_NAME</th>
                    
                        <th>LAST_NAME</th>
                    
                        <th>CLASS</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>1</td>
                    
                        <td>0</td>
                    
                        <td>Dagny</td>
                    
                        <td>Taggart</td>
                    
                        <td>Supervisor</td>
                    
                <tr>
            
                <tr>
                    
                        <td>2</td>
                    
                        <td>0</td>
                    
                        <td>Eddie</td>
                    
                        <td>Willers</td>
                    
                        <td>Employee</td>
                    
                <tr>
            
                <tr>
                    
                        <td>3</td>
                    
                        <td>0</td>
                    
                        <td>James</td>
                    
                        <td>Taggart</td>
                    
                        <td>Supervisor</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><div class="alert alert-info" role="alert"><p>The <em>class</em> column in the table actually contains the full class name; package name plus class name. I excluded the package name from the above listing.</p>
</div>
</p>
<p>In addition to the <code>EMPLOYEE</code> table, GORM creates the <code>SUPERVISOR_EMPLOYEE</code> table for the <em>one-to-many</em> <code>subordinates</code> association. This table is not critical to inheritance, so I won't discuss it any further. For details on associations read <a href="http://emmanuelrosa.com/articles/grails-domain-class-associations/">this</a> article.</p>
<h2>The queries</h2>
<p>The <code>EMPLOYEE</code> table has a <code>CLASS</code> column which distinguishes which domain class corresponds to the record. This makes it possible to list all employees...</p>
<figure class='code'><figcaption><span>SQL</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">ID</span><span class="p">,</span> <span class="n">FIRST_NAME</span><span class="p">,</span> <span class="n">LAST_NAME</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">EMPLOYEE</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>GORM</span></figcaption><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>... or to list only <code>Supervisors</code>...</p>
<figure class='code'><figcaption><span>SQL</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">ID</span><span class="p">,</span> <span class="n">FIRST_NAME</span><span class="p">,</span> <span class="n">LAST_NAME</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">EMPLOYEE</span>
</span><span class='line'><span class="k">WHERE</span>  <span class="k">CLASS</span> <span class="o">=</span> <span class="s1">&#39;emmanuel.rosa.grailsinheritanceexample.Supervisor&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>GORM</span></figcaption><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">supervisors</span> <span class="o">=</span> <span class="n">Supervisor</span><span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>So far, except for the <code>subordinates</code> association, the <code>Supervisor</code> domain class contains the same properties as the <code>Employee</code> domain class. Lets add an <code>office</code> property. Only supervisors have offices right?</p>
<figure class='code'><figcaption><span>Supervisor.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Supervisor</span> <span class="kd">extends</span> <span class="n">Employee</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">office</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now the <code>EMPLOYEE</code> table has an <code>OFFICE</code> column.</p>
<p><div class="panel panel-default">
    
        <div class="panel-heading">
            <h3 class="panel-title">EMPLOYEE table</h3>
        </div>
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>ID</th>
                    
                        <th>VERSION</th>
                    
                        <th>FIRST_NAME</th>
                    
                        <th>LAST_NAME</th>
                    
                        <th>CLASS</th>
                    
                        <th>OFFICE</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>1</td>
                    
                        <td>0</td>
                    
                        <td>Dagny</td>
                    
                        <td>Taggart</td>
                    
                        <td>Supervisor</td>
                    
                        <td>Operations Suite</td>
                    
                <tr>
            
                <tr>
                    
                        <td>2</td>
                    
                        <td>0</td>
                    
                        <td>Eddie</td>
                    
                        <td>Willers</td>
                    
                        <td>Employee</td>
                    
                        <td>null</td>
                    
                <tr>
            
                <tr>
                    
                        <td>3</td>
                    
                        <td>0</td>
                    
                        <td>James</td>
                    
                        <td>Taggart</td>
                    
                        <td>Supervisor</td>
                    
                        <td>Basement</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><div class="alert alert-warning" role="alert"><p>By default domain class properties are not null-able (NOT NULL in SQL speak). I'm using an H2 database for this demonstration and apparently the office field is not being set to NOT NULL. If I were to use my favorite DBMS PostgreSQL, it would reject the Eddie Willers record. So I'm going to pretend that NOT NULL is working properly and that the <code>office</code> field should be as-is; not null-able.</p>
</div>
</p>
<p>What this means in practice is that it's now impossible to create instances of the <code>Employee</code> domain class because <code>Employee</code>s don't have an office, yet the office field cannot be NULL. Don't worry, GORM offers a way out: <em>table-per-subclass</em> inheritance.</p>
<h1>Table-per-subclass</h1>
<p>Table-per-subclass means that a subclass is represented in the database as a table consisting of <strong>the <em>difference</em> between itself and its super-class</strong>. First, the default inheritance stragety must be changed.</p>
<figure class='code'><figcaption><span>Employee.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">mapping</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">tablePerHierarchy</span> <span class="kc">false</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>With the change described above applied, the <code>OFFICE</code> column is moved to a separate table.</p>
<p><div class="panel panel-default">
    
        <div class="panel-heading">
            <h3 class="panel-title">EMPLOYEE table</h3>
        </div>
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>ID</th>
                    
                        <th>VERSION</th>
                    
                        <th>FIRST_NAME</th>
                    
                        <th>LAST_NAME</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>1</td>
                    
                        <td>0</td>
                    
                        <td>Dagny</td>
                    
                        <td>Taggart</td>
                    
                <tr>
            
                <tr>
                    
                        <td>2</td>
                    
                        <td>0</td>
                    
                        <td>Eddie</td>
                    
                        <td>Willers</td>
                    
                <tr>
            
                <tr>
                    
                        <td>3</td>
                    
                        <td>0</td>
                    
                        <td>James</td>
                    
                        <td>Taggart</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><div class="panel panel-default">
    
        <div class="panel-heading">
            <h3 class="panel-title">SUPERVISOR table</h3>
        </div>
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>ID</th>
                    
                        <th>OFFICE</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>1</td>
                    
                        <td>Operations Suite</td>
                    
                <tr>
            
                <tr>
                    
                        <td>3</td>
                    
                        <td>Basement</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Notice that <code>Supervisors</code> have a record in the <code>SUPERVISOR</code> table <em>and</em> in the <code>EMPLOYEE</code> table. In addition, the record IDs are shared between both tables. The relationship at the database level is a <em>one-to-one</em>.  This means querying for <code>Supervisor</code>s in SQL requires a table join.</p>
<figure class='code'><figcaption><span>SQL</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">EMPLOYEE</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">FIRST_NAME</span><span class="p">,</span> <span class="n">LAST_NAME</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">SUPERVISOR</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">EMPLOYEE</span> 
</span><span class='line'>       <span class="k">ON</span> <span class="n">SUPERVISOR</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">EMPLOYEE</span><span class="p">.</span><span class="n">ID</span>
</span></code></pre></td></tr></table></div></figure>
<h1>The end</h1>
<p>Well, this wraps up this discussion on Grails polymorphic sub-classing. You just learned about the differences between GORM'S two methods of inheritance and what they look like at the database level. Want to play around with the code? Just clone the Mercurial repository as shown below:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>hg clone ssh://hg@bitbucket.org/erosa/grails-inheritance-example
</span></code></pre></td></tr></table></div></figure>
]]></content></entry><entry><title type="html"><![CDATA[GORM for SQLaddicts: SELECT clause]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/"/><updated>2015-12-18T17:01:48-05:00</updated><id>3e21f9c92e61ee0feac7ce7da1942ba3</id><content type="html"><![CDATA[<p>This article in the GORM for SQLaddicts series describes how to choose which domain class properties to return in your GORM query. It's the equivalent of the SQL <em>select</em> clause.</p>
<!--more-->
<p><h1>GORM for SQLaddicts</h1>
<p>Welcome to the GORM for SQLaddicts series. A collection of articles dedicated to experienced SQL programmers who want to learn how to query GORM, the Grails object-relational mapper.</p>
<p>Throughout this series you will learn how to</p>
<ol>
<li><a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/">WHERE - Add restrictions to a query</a></li>
<li><a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/">FROM - Work with associations and joins</a></li>
<li><strong>SELECT - Return multiple properties and/or domain classes</strong></li>
</ol>
<h2>Getting started</h2>
<p>To follow along you'll need <a href="https://grails.org/">Grails</a> 3.0.5 and <a href="https://www.mercurial-scm.org/">Mercurial</a>. With Grails and Mercurial installed you can download the source code and run the Grails console.</p>
<h3>Setup</h3>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>hg clone ssh://hg@bitbucket.org/erosa/gormtut
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>gormtut 
</span><span class='line'><span class="nv">$ </span>grails console
</span></code></pre></td></tr></table></div></figure>
<p>Once the Grails console window appears, copy &amp; paste the following code into the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">com.emmanuelrosa.gormtut.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withNewSession</span> <span class="o">{</span> <span class="n">session</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1">// Run GORM queries within this Closure.</span>
</span><span class='line'>    
</span><span class='line'>    
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now you're set up to execute GORM queries. All you need to do is write the query within the <code>Closure</code> and run the code (Script->Run or Command-R).</p>
<h3>Domain classes</h3>
<p>The examples in this article reference the <code>Vendor</code>, <code>Address</code>, and <code>Product</code> domain classes. See the diagram below to see how the domain classes are related to each other.</p>
<p><img src="http://emmanuelrosa.com/images/sqladdicts-domains-dd608e6240ea469473399853225b6c94.svg" alt="Domain class diagram" /></p>
</p>
<p>Throughout this series I've dedicated each article to a single SQL clause: (see the
<a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/"><em>where</em></a> and <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/"><em>from</em></a> articles).
And as you may have noticed, it's impossible to use only one of these SQL clauses in isolation. The same applies to GORM. Both previous articles utilize the <em>select</em> clause in some way. Lets learn about the details.</p>
<h1>SELECTing properties</h1>
<p>In the <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/"><em>where</em></a> clause article I said not to be concerned with the <em>select</em> clause just yet. Now the time has come to figure this thing out. Say you want to get a list of all the <code>Vendor</code> names. In SQL you can accomplish this with the following query:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">vendor</span>
</span></code></pre></td></tr></table></div></figure>
<p>Thus far, your queries return domain class instances. As an example, you <em>could</em> list all of the <code>Vendor</code> names by getting all of the <code>Vendor</code> instances and then using Groovy to grab the <code>name</code> properties:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">findAll</span><span class="o">()*.</span><span class="na">name</span>
</span></code></pre></td></tr></table></div></figure>
<p>But lets face it, you can do better. Enough with the suspense. Here's the HQL:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">Vendor</span>
</span></code></pre></td></tr></table></div></figure>
<p>The HQL is straight-forward: it returns the <code>name</code> property of all the <code>Vendor</code> domain class instances. The output looks like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="s1">&#39;Bears Emporium&#39;</span><span class="o">,</span> <span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="s1">&#39;Furball Inc.&#39;</span><span class="o">,</span> <span class="s1">&#39;Fun and Games&#39;</span><span class="o">,</span> <span class="s1">&#39;Jouets et ours&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>Lets add another property:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span> <span class="k">FROM</span> <span class="n">Vendor</span>
</span></code></pre></td></tr></table></div></figure>
<p>The output looks like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">1</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears Emporium&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">2</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">3</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Furball Inc.&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">4</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Fun and Games&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">5</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Jouets et ours&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">6</span><span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>The output is rows of <code>List</code>s, with each <code>List</code> containing two elements: the <code>Vendor</code> <code>name</code> and <code>Address</code>. Interesting huh? How about returning an <code>Address</code> property, such as <code>country</code>, instead?</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">country</span> <span class="k">FROM</span> <span class="n">Vendor</span>
</span></code></pre></td></tr></table></div></figure>
<p>The output of which is:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="s1">&#39;USA&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears Emporium&#39;</span><span class="o">,</span> <span class="s1">&#39;USA&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="s1">&#39;USA&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Furball Inc.&#39;</span><span class="o">,</span> <span class="s1">&#39;USA&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Fun and Games&#39;</span><span class="o">,</span> <span class="s1">&#39;England&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Jouets et ours&#39;</span><span class="o">,</span> <span class="s1">&#39;France&#39;</span><span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>Cool! Look how easy that was! Lets try one more thing: add the <code>Vendor.products</code> property.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">products</span> <span class="k">FROM</span> <span class="n">Vendor</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-danger" role="alert">org.springframework.jdbc.BadSqlGrammarException: Hibernate operation: could not prepare statement; bad SQL grammar</div>
</p>
<p>That didn't go so well. The issue is that <code>Vendor</code> has a one-to-many relationship to <code>Product</code> through the <code>products</code> association. This means the <code>products</code> property is a collection and thus requires a different approach. I'll come back to this. Lets do some criteria and where queries.</p>
<h2>Criteria</h2>
<p>The equivalent of a <em>select</em> clause in criteria (and where) queries is called a projection. Yea! Yes, I'm talking about those mysterious projections you've seen plastered all over Stack Overflow.</p>
<p>Once you see a projection in action, it will click.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">println</span> <span class="n">Vendor</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">projections</span> <span class="o">{</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;address&#39;</span><span class="o">)</span>           
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Notice how each <em>selected</em> property corresponds to a call to <code>HibernateCriteriaBuilder.property(String propertyName)</code>. Mystery solved <span class="fa fa-smile-o"< /span></p>
<p>What's with the <code>println</code>? The problem is this: The <code>Address</code> instances are lazy-loaded when the query executes: you get a proxy rather than actual <code>Address</code> instances. The proxy then retrieves the data when you try to access it, as will happen when the Grails console attempts to print the result. The <code>println</code> forces the proxy to <em>resolve</em> within the <code>withNewSession(Closure)</code> Closure preventing this:</p>
<p><div class="alert alert-danger" role="alert">org.hibernate.LazyInitializationException: could not initialize proxy - no Session</div>
</p>
<p>For clarity, I'll exclude the <code>println</code> from the remaining examples. Lets replicate the HQL which returns the <code>Vendor.name</code> and <code>Vendor.address.country</code> properties.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">projections</span> <span class="o">{</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
</span><span class='line'>       
</span><span class='line'>       <span class="n">address</span> <span class="o">{</span>
</span><span class='line'>           <span class="n">property</span><span class="o">(</span><span class="s1">&#39;country&#39;</span><span class="o">)</span>
</span><span class='line'>       <span class="o">}</span>          
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Ah, this is different. To access a nested property:</p>
<ol>
<li>call a method named like the first property (ex. <code>address(Closure)</code>).</li>
<li>Within the <code>Closure</code> call <code>property(String)</code> with a property name (ex. <code>country</code>) relative to the property represented by the method call (ex. <code>address</code>).</li>
</ol>
<p>It takes some getting used to, but it's not so bad. So, what can a where query do for you?</p>
<h2>Where query</h2>
<p>Projections work differently in where queries. Up first are the <code>name</code> and <code>address</code> properties.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span>
</span><span class='line'>    <span class="o">.</span><span class="na">where</span> <span class="o">{}</span>
</span><span class='line'>   <span class="o">.</span><span class="na">projections</span> <span class="o">{</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;address&#39;</span><span class="o">)</span>
</span><span class='line'>   <span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>I modified the where query syntax I normally use to clarify the fact that in where queries the projections are specified <em>outside</em> of the <code>GormEntity.where(Closure)</code> <code>Closure</code>. Otherwise, the projections <code>Closure</code> is the same as the one used in the equivalent criteria query. But, there's a caveat. Lets see what happens when you try to project <code>address.country</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span>
</span><span class='line'>    <span class="o">.</span><span class="na">where</span> <span class="o">{}</span>
</span><span class='line'>   <span class="o">.</span><span class="na">projections</span> <span class="o">{</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
</span><span class='line'>       
</span><span class='line'>       <span class="n">address</span> <span class="o">{</span>
</span><span class='line'>           <span class="n">property</span><span class="o">(</span><span class="s1">&#39;country&#39;</span><span class="o">)</span>
</span><span class='line'>       <span class="o">}</span>          
</span><span class='line'>   <span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>It doesn't work. What a downer. In short, projections are just better supported by criteria queries.</p>
<p>Earlier on you tried selecting/projecting the <code>Vendor.products</code> property and got a nasty error. Lets discover what you can do to handle such <code>Collection</code> properties.</p>
<h1>SELECTing collections</h1>
<p>Since you know SQL, the easiest way to learn how to deal with <code>Collections</code> is to look at what the output looks like:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">1</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">2</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">3</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">4</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">5</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">6</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">7</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Fun and Games&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">8</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Fun and Games&#39;</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">9</span><span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>Keeping in mind that a <code>Vendor</code> has a one-to-many relationship with <code>Product</code>, you can see in the table-like output above what looks like an... <em>inner join</em>! Do you see it? OK, let me show you the query that produced that output.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">vnd</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">product</span> <span class="k">FROM</span> <span class="n">Vendor</span> <span class="k">AS</span> <span class="n">vnd</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">vnd</span><span class="p">.</span><span class="n">products</span> <span class="k">AS</span> <span class="n">product</span>
</span></code></pre></td></tr></table></div></figure>
<p>By joining the <code>Product</code> domain class through the existing <code>Vendor.products</code> association each related <code>Product</code> becomes available in the query. Note that to select the <code>Vendor.name</code> the domain class alias (ex <code>vnd</code>) must be used. Joining is covered thoroughly in the <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/"><em>from clause</em></a> article.</p>
<p>Lets build on this and select a <code>Product</code> property.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">vnd</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">product</span><span class="p">.</span><span class="n">name</span> <span class="k">FROM</span> <span class="n">Vendor</span> <span class="k">AS</span> <span class="n">vnd</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">vnd</span><span class="p">.</span><span class="n">products</span> <span class="k">AS</span> <span class="n">product</span>
</span></code></pre></td></tr></table></div></figure>
<p>Complimentary output:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="s1">&#39;8 inch teddy bear&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Bears R Us&#39;</span><span class="o">,</span> <span class="s1">&#39;18 inch teddy bear&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="s1">&#39;Fish bean bag toy&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="s1">&#39;Bird bean bag toy&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="s1">&#39;Rabbit bean bag toy&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Doll House Inc.&#39;</span><span class="o">,</span> <span class="s1">&#39;Raggedy Ann&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Fun and Games&#39;</span><span class="o">,</span> <span class="s1">&#39;King doll&#39;</span><span class="o">],</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;Fun and Games&#39;</span><span class="o">,</span> <span class="s1">&#39;Queen doll&#39;</span><span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>Yep, it's that easy. Moving on...</p>
<h2>Criteria query</h2>
<p>I'll tell you right off the bat that you cannot project the associated domain classes like you can with HQL. For instance, neither one of these queries will work:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="c1">// This won&#39;t work.</span>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">projections</span> <span class="o">{</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;products&#39;</span><span class="o">)</span>           
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Neither will this.</span>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">createAlias</span><span class="o">(</span><span class="s1">&#39;products&#39;</span><span class="o">,</span> <span class="s1">&#39;product&#39;</span><span class="o">)</span>
</span><span class='line'>   
</span><span class='line'>   <span class="n">projections</span> <span class="o">{</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;product&#39;</span><span class="o">)</span>           
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>But, you can project an association's property. This works beautifully:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>   <span class="n">projections</span> <span class="o">{</span>
</span><span class='line'>       <span class="n">property</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
</span><span class='line'>       
</span><span class='line'>       <span class="n">products</span> <span class="o">{</span>
</span><span class='line'>           <span class="n">property</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">)</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Since where query projections do not support nested properties, I'm closing the curtain.</p>
<h1>Conclusion</h1>
<p>I hope you've enjoyed the GORM for SQLaddicts series so far. In this article you learned how to select properties, and association properties using HQL's <em>select</em> clause and criteria and where query projections. I hope you've enjoyed this series of articles.</p>
]]></content></entry><entry><title type="html"><![CDATA[GORM for SQLAddicts: FROM Clause]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/"/><updated>2015-12-11T12:40:21-05:00</updated><id>dacc9dc3c1a40ddca21c242c74cbb0ab</id><content type="html"><![CDATA[<p>When you learned how to specify GORM query restrictions, the equivalent of the SQL WHERE clause, we only queried a single domain class. In this article you'll learn how to join multiple domain classes into your queries.</p>
<!--more-->
<p><h1>GORM for SQLaddicts</h1>
<p>Welcome to the GORM for SQLaddicts series. A collection of articles dedicated to experienced SQL programmers who want to learn how to query GORM, the Grails object-relational mapper.</p>
<p>Throughout this series you will learn how to</p>
<ol>
<li><a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/">WHERE - Add restrictions to a query</a></li>
<li><strong>FROM - Work with associations and joins</strong></li>
<li><a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/">SELECT - Return multiple properties and/or domain classes</a></li>
</ol>
<h2>Getting started</h2>
<p>To follow along you'll need <a href="https://grails.org/">Grails</a> 3.0.5 and <a href="https://www.mercurial-scm.org/">Mercurial</a>. With Grails and Mercurial installed you can download the source code and run the Grails console.</p>
<h3>Setup</h3>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>hg clone ssh://hg@bitbucket.org/erosa/gormtut
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>gormtut 
</span><span class='line'><span class="nv">$ </span>grails console
</span></code></pre></td></tr></table></div></figure>
<p>Once the Grails console window appears, copy &amp; paste the following code into the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">com.emmanuelrosa.gormtut.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withNewSession</span> <span class="o">{</span> <span class="n">session</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1">// Run GORM queries within this Closure.</span>
</span><span class='line'>    
</span><span class='line'>    
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now you're set up to execute GORM queries. All you need to do is write the query within the <code>Closure</code> and run the code (Script->Run or Command-R).</p>
<h3>Domain classes</h3>
<p>The examples in this article reference the <code>Vendor</code>, <code>Address</code>, <code>Customer</code>, <code>PurchaseOrder</code>, and <code>Product</code> domain classes. See the diagram below to see how the domain classes are related to each other.</p>
<p><img src="http://emmanuelrosa.com/images/sqladdicts-domains-dd608e6240ea469473399853225b6c94.svg" alt="Domain class diagram" /></p>
</p>
<p>The GORM for SQLAddicts series is not for the lazy. You gotta get your fingers cramped to get the best out of it. If your behind is not tingling, fast asleep, you've been getting too much exercise. Sit back down, get the Grails console back up, and lets get to it.</p>
<h1>SQL vs GORM joins</h1>
<p>In SQL, when you need to reference more that one table, you specify the other table(s) and  how they are to be joined.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span> 
</span><span class='line'><span class="k">FROM</span>   <span class="n">TABLE_A</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">TABLE_B</span>
</span><span class='line'>       <span class="k">ON</span> <span class="n">TABLE_A</span><span class="p">.</span><span class="n">FOREIGN_KEY</span> <span class="o">=</span> <span class="n">TABLE_B</span><span class="p">.</span><span class="n">ID</span>
</span></code></pre></td></tr></table></div></figure>
<p>GORM is different.</p>
<p>GORM automatically <em>inner</em> joins domain classes according to their associations. A GORM query can alter the join <em>type</em> (left, right, or Cartesian) but cannot join un-associated domain classes. Lets explore this with an <em>inner join</em> using HQL.</p>
<h2>An example</h2>
<p>Let's say you want to get all the <code>Vendor</code>s in the state of Michigan. The first step is to check which associations you have available in the domain classes involved. Here's the source code.</p>
<figure class='code'><figcaption><span>Vendor.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Vendor</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>    <span class="n">Address</span> <span class="n">address</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">products:</span> <span class="n">Product</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>Address.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">street</span> 
</span><span class='line'>    <span class="n">String</span> <span class="n">city</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">state</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">zip</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">country</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">state</span> <span class="nl">nullable:</span> <span class="kc">true</span> 
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>The <code>Vendor.address</code> association provides a many-to-one association from <code>Vendor</code> to <code>Address</code>. This means you can join <code>Address</code> and <code>Vendor</code> and then get to the <code>state</code> property via the <code>Address</code>. But before you can create the join you need to create an alias.</p>
<h3>Create an alias</h3>
<p>The <em>inner join</em> syntax is:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">domainClassAlias</span><span class="p">.</span><span class="n">associationProperty</span> <span class="k">AS</span> <span class="k">alias</span>
</span></code></pre></td></tr></table></div></figure>
<p>So the first thing you need is a domain class alias: an alias for the domain class containing the association property. The <code>Vendor</code> domain class contains the <code>address</code> association property, so you need an alias for <code>Vendor</code>. Just like SQL, in HQL an alias is created with <em>AS</em>.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">FROM</span> <span class="n">Vendor</span> <span class="k">AS</span> <span class="n">vnd</span>
</span></code></pre></td></tr></table></div></figure>
<p>

<blockquote>
    <p>That was easy.</p>
    <footer>
        
            <strong>Staples, Inc</strong>
        
        
    </footer>
</blockquote></p>
<p>Now that you have the <code>vnd</code> alias for <code>Vendor</code> you're ready to create the join.</p>
<h3>Create the join</h3>
<p>Using the <code>vnd</code> alias let's create an <em>inner join</em>.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">FROM</span> <span class="n">Vendor</span> <span class="k">AS</span> <span class="n">vnd</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">vnd</span><span class="p">.</span><span class="n">address</span> <span class="k">AS</span> <span class="n">addr</span>
</span></code></pre></td></tr></table></div></figure>
<p>Go ahead and run the query in the Grails console. The output looks like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">1</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">1</span><span class="o">],</span> 
</span><span class='line'>    <span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">2</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">2</span><span class="o">],</span> 
</span><span class='line'>    <span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">3</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">3</span><span class="o">],</span> 
</span><span class='line'>    <span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">4</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">4</span><span class="o">],</span> 
</span><span class='line'>    <span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">5</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">5</span><span class="o">],</span> 
</span><span class='line'>    <span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">6</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Address</span> <span class="o">:</span> <span class="mi">6</span><span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-info" role="alert"><p>To learn how to run an HQL query, see the SQLaddicts <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/"><em>where</em> clause</a> article.</p>
</div>
</p>
<p>Interestingly, the query returns a list of lists containing the <code>Vendor</code> and <code>Address</code>. You may have expected a list of <code>Vendor</code>s. The remedy is the topic of another article but I'll go ahead and introduce it since I'd be helpful right now: You need to add a <em>select</em> clause.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">vnd</span> <span class="k">FROM</span> <span class="n">Vendor</span> <span class="k">AS</span> <span class="n">vnd</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">vnd</span><span class="p">.</span><span class="n">address</span> <span class="k">AS</span> <span class="n">addr</span>
</span></code></pre></td></tr></table></div></figure>
<p>Just <em>select</em> the <code>vnd</code> alias and you'll get a list of <code>Vendor</code>s.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">1</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">2</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">3</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">4</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">5</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Vendor</span> <span class="o">:</span> <span class="mi">6</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>Because it makes sense to do so, although it's beyond the scope of this article I'll go ahead and continue using the <em>select</em> clause in the simplest way possible for the remainder of this article.</p>
<p>Unlike SQL, there's no need to specify which fields to join on. In fact, HQL doesn't support the <em>ON</em> clause. Instead, you simply specify which association to use for the join. GORM does the rest. The domain class joined by the association is then given an alias. In this example, <code>addr</code>. Now that you have the join created you can finally add the restriction with a <em>where</em> clause.</p>
<h3>Create the restriction</h3>
<p>To create the restriction on the state of Michigan, use the <code>addr</code> alias to access the <code>state</code> property.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">vnd</span> <span class="k">FROM</span> <span class="n">Vendor</span> <span class="k">AS</span> <span class="n">vnd</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">vnd</span><span class="p">.</span><span class="n">address</span> <span class="k">AS</span> <span class="n">addr</span> <span class="k">WHERE</span> <span class="n">addr</span><span class="p">.</span><span class="k">state</span> <span class="o">=</span> <span class="s1">&#39;MI&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-info" role="alert"><p>Unfamiliar with GORM restrictions? See the article <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/">GORM for SQLaddicts: WHERE Clause</a>.</p>
</div>
</p>
<p>Where and criteria queries perform the join implicitly, but in HQL you need to explicitly join the domain classes to create aliases. Speaking of where and criteria queries...</p>
<h1>Inner join</h1>
<p>Now that you know how to create an <em>inner join</em> in HQL, let's do the same with where and criteria queries. Dynamic finders don’t support joins so they're not discussed in this article. Where queries are up first.</p>
<h2>Where query</h2>
<p>To create a restriction on a property of an association, simply use Groovy's property access.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">address</span><span class="o">.</span><span class="na">state</span> <span class="o">==</span> <span class="s1">&#39;MI&#39;</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>In the query above, the <code>state</code> property of the <code>address</code> association is used in a restriction. And of course, the <code>address</code> association is in the <code>Vendor</code> domain class. Notice that unlike HQL, there's no need to create an alias. You simply use the association's property name. Let's see the equivalent criteria query.</p>
<h2>Criteria query</h2>
<p>To create a restriction on a property of an association, you need to...</p>
<ol>
<li>Call a method with the same name as the association.</li>
<li>Provide a <code>Closure</code> as method's argument.</li>
<li>Within the <code>Closure</code> use any of the association's properties.</li>
</ol>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withCriteria</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">address</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;state&#39;</span><span class="o">,</span> <span class="s1">&#39;MI&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>In the query shown above, the <code>address(Closure)</code> method informs the <code>HibernateCriteriaBuilder</code> that properties accessed within the <code>Closure</code> should be looked up in the <code>Vendor</code>'s <code>Address</code>. The <code>HibernateCriteriaBuilder.eq(String, Object)</code> method called within the <code>Closure</code> will use the <code>state</code> property of the <code>Address</code> when creating the restriction.</p>
<p>The where and criteria queries you just learned about don't show any indication of joins, unlike the HQL query. That's about to change. Left outer join is next.</p>
<h1>Left outer join</h1>
<p>To demonstrate a left outer join lets query for <code>Customer</code>s lacking a <code>PurchaseOrder</code>. Here are the domain classes involved.</p>
<figure class='code'><figcaption><span>Customer.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Customer</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>    <span class="n">Address</span> <span class="n">address</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">contact</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">email</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">orders:</span> <span class="n">PurchaseOrder</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>PurchaseOrder.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">PurchaseOrder</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Date</span> <span class="n">orderDate</span>
</span><span class='line'>    <span class="n">Customer</span> <span class="n">customer</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">items:</span> <span class="n">Item</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>To find the <code>Customer</code>s without a <code>PurchaseOrder</code> you'll use the <code>Customer.orders</code> association. Lets do this in HQL first.</p>
<h2>HQL query</h2>
<p>The HQL query will likely bore you.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">cust</span> <span class="k">FROM</span> <span class="n">Customer</span> <span class="k">AS</span> <span class="n">cust</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">cust</span><span class="p">.</span><span class="n">orders</span> <span class="k">AS</span> <span class="n">ord</span> <span class="k">WHERE</span> <span class="n">ord</span> <span class="o">=</span> <span class="k">null</span>
</span></code></pre></td></tr></table></div></figure>
<p>When you run the query you'll see there's only one qualifying <code>Customer</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Customer</span> <span class="o">:</span> <span class="mi">2</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>By default, where and criteria queries use an inner join. However, the join type of a criteria query can be changed to a left outer join. Unfortunately, the join type of a where query cannot be changed, so this is as far as we can get with where queries.</p>
<h2>Criteria query</h2>
<p>First, import the Hibernate join type you intend to use. I'm going to import all of them with the following statement:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">JoinType</span><span class="o">.*</span>
</span></code></pre></td></tr></table></div></figure>
<p>Next, create an alias for the <code>orders</code> association while specifying the join type.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">JoinType</span><span class="o">.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Customer</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">createAlias</span><span class="o">(</span><span class="s1">&#39;orders&#39;</span><span class="o">,</span> <span class="s1">&#39;ord&#39;</span><span class="o">,</span> <span class="n">LEFT_OUTER_JOIN</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>An alias is created with <code>HibernateCriteriaBuilder.createAlias(String associationPath, String alias, int joinType)</code>. And finally, use the <code>ord</code> alias with `HibernateCriteriaBuilder.isNull(String) to create the <em>is null</em> restriction.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">JoinType</span><span class="o">.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Customer</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">createAlias</span><span class="o">(</span><span class="s1">&#39;orders&#39;</span><span class="o">,</span> <span class="s1">&#39;ord&#39;</span><span class="o">,</span> <span class="n">LEFT_OUTER_JOIN</span><span class="o">)</span>
</span><span class='line'>    <span class="n">isNull</span><span class="o">(</span><span class="s1">&#39;ord.id&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Bonus: Lets cheat</h2>
<p>The <em>null check</em> type of query used in the example is quite common in SQL. GORM offers another way to achieve the same thing. By looking for <code>Customer</code>s with an <code>orders</code> collection of size 0, you can get the same result without the left outer join.</p>
<figure class='code'><figcaption><span>HQL</span></figcaption><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">FROM</span> <span class="n">Customer</span> <span class="k">WHERE</span> <span class="k">size</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>Where</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Customer</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">orders</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>Criteria</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Customer</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sizeEq</span><span class="o">(</span><span class="s1">&#39;orders&#39;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Up next is the uncommon but sometimes useful Cartesian product/cross join.</p>
<h2>Cartesian/cross join</h2>
<p>For a cross join (Cartesian product) you’re down to HQL. It's unsupported by where and criteria queries. Similar to SQL, you simply need to list the domain classes separated by a comma:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">FROM</span> <span class="n">Vendor</span> <span class="n">AS</span> <span class="n">vnd</span><span class="o">,</span> <span class="n">Product</span> <span class="n">AS</span> <span class="n">prd</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>It's that simple.</p>
<h1>Association direction</h1>
<p>Because GORM joins domain classes based on their associations, the associations impact how you can write your queries. Something to consider is the direction of your associations. Lets say there’s a unidirectional many-to-one association from <code>Product</code> to <code>Vendor</code>.</p>
<figure class='code'><figcaption><span>Product.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">description</span>
</span><span class='line'>    <span class="n">BigDecimal</span> <span class="n">price</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="o">[</span><span class="nl">vendor:</span> <span class="n">Vendor</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>Vendor.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Vendor</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>    <span class="n">Address</span> <span class="n">address</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>To get a list of <code>Vendor</code>s who don’t have <code>Product</code>s, you’d have to use a right outer join like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">vnd</span> 
</span><span class='line'><span class="k">FROM</span> <span class="n">Product</span> <span class="k">AS</span> <span class="n">prd</span> <span class="k">RIGHT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">prd</span><span class="p">.</span><span class="n">vendor</span> <span class="k">AS</span> <span class="n">vnd</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="n">prd</span><span class="p">.</span><span class="n">id</span> <span class="k">is</span> <span class="k">null</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>It’s possible to do a right outer join with a criteria query, but you’d have to use a <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/">projection</a> to return a <code>Vendor</code> property, such as its <code>id</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">JoinType</span><span class="o">.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">createAlias</span> <span class="s1">&#39;vendor&#39;</span><span class="o">,</span> <span class="s1">&#39;vnd&#39;</span><span class="o">,</span> <span class="n">RIGHT_OUTER_JOIN</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">projections</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">property</span> <span class="s1">&#39;vnd.id&#39;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">isNull</span> <span class="s1">&#39;id&#39;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Alternatively, a bidirectional association simplifies the queries. For instance, with a <em>one-to-many</em> association from <code>Vendor</code> to <code>Product</code>...</p>
<figure class='code'><figcaption><span>Vendor.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Vendor</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">products:</span> <span class="n">Product</span><span class="o">]</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>You get the option of using a where query.</p>
<figure class='code'><figcaption><span>HQL</span></figcaption><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">FROM</span> <span class="n">Vendor</span> <span class="k">WHERE</span> <span class="k">size</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>Where</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">products</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>Criteria</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sizeEq</span><span class="o">(</span><span class="s1">&#39;products&#39;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h1>Conclusion</h1>
<p>In this article you learned about joining domain classes in GORM queries, and you even learned a tiny little bit about the HQL <em>select</em> clause.
Need a refresher on the <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/"><em>where</em> clause</a>?
Want to learn about <em>select</em>'ing with GORM queries? There's an <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/">article</a> for that.</p>
]]></content></entry><entry><title type="html"><![CDATA[GORM for SQLaddicts: WHERE Clause]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/"/><updated>2015-12-10T18:48:51-05:00</updated><id>3c50af512f1f96b65c4c96102a2696c1</id><content type="html"><![CDATA[<p>Learn how to implement the equivalent of a SQL WHERE clause using an HQL query, criteria query, where query, and dynamic finder. <!--more-->You'll save time by learning GORM using the SQL concepts you already know.</p>
<p><h1>GORM for SQLaddicts</h1>
<p>Welcome to the GORM for SQLaddicts series. A collection of articles dedicated to experienced SQL programmers who want to learn how to query GORM, the Grails object-relational mapper.</p>
<p>Throughout this series you will learn how to</p>
<ol>
<li><strong>WHERE - Add restrictions to a query</strong></li>
<li><a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/">FROM - Work with associations and joins</a></li>
<li><a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/">SELECT - Return multiple properties and/or domain classes</a></li>
</ol>
<h2>Getting started</h2>
<p>To follow along you'll need <a href="https://grails.org/">Grails</a> 3.0.5 and <a href="https://www.mercurial-scm.org/">Mercurial</a>. With Grails and Mercurial installed you can download the source code and run the Grails console.</p>
<h3>Setup</h3>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>hg clone ssh://hg@bitbucket.org/erosa/gormtut
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>gormtut 
</span><span class='line'><span class="nv">$ </span>grails console
</span></code></pre></td></tr></table></div></figure>
<p>Once the Grails console window appears, copy &amp; paste the following code into the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">com.emmanuelrosa.gormtut.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withNewSession</span> <span class="o">{</span> <span class="n">session</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1">// Run GORM queries within this Closure.</span>
</span><span class='line'>    
</span><span class='line'>    
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now you're set up to execute GORM queries. All you need to do is write the query within the <code>Closure</code> and run the code (Script->Run or Command-R).</p>
<h3>Domain classes</h3>
<p>The examples in this article reference the <code>Product</code>, <code>Vendor</code>, and <code>Address</code> domain classes. See the diagram below to see how the domain classes are related to each other.</p>
<p><img src="http://emmanuelrosa.com/images/sqladdicts-domains-dd608e6240ea469473399853225b6c94.svg" alt="Domain class diagram" /></p>
</p>
<p>You'll begin with HQL due to it's similarity to SQL. From there, you'll learn about criteria queries, where queries, and finally dynamic finders. Let's get started.</p>
<h1>HQL</h1>
<p>HQL is a natural way to begin learning GORM queries simply because it makes the most of the SQL you already know. The significant differences in HQL are noticeable in the <a href="/articles/gorm-for-sqladdicts-select-clause/">GORM for SQLaddicts: SELECT clause</a> and <a href="/articles/gorm-for-sqladdicts-from-clause/">GORM for SQLAddicts: FROM Clause</a> articles, but there are still some worth mentioning now.</p>
<h2>Anatomy</h2>
<p>The table below compares a SQL query to it's HQL equivalent. Take a look and see how many differences you can identify.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>SQL</th>
                    
                        <th>HQL</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td><span style="font-family: monospace">SELECT *</span></td>
                    
                        <td><span style="font-family: monospace"></span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">FROM product</span></td>
                    
                        <td><span style="font-family: monospace">FROM Product</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 in teddy bear'</span></td>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 in teddy bear'</span></td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>There are a whopping 2 differences: the <em>Product</em> in the <em>from</em> clause is case-sensitive and the <em>select</em> clause is missing.</p>
<h3>Case sensitivity</h3>
<p>An important difference between SQL and HQL is that in SQL you select from <em>tables</em> while in HQL you select from <em>domain classes</em>. Because you're dealing with classes names rather than tables names, the names are case-sensitive.</p>
<h3>Columns vs Objects</h3>
<p>

<blockquote>
    <p>So... how do I select properties?</p>
    <footer>
        
            <strong>You</strong>
        
        
    </footer>
</blockquote></p>
<p>The <em>select</em> clause, which is covered in the <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/"><em>select clause</em></a> article, can be used to return rows of domain class properties. The important thing to know for now is that while SQL queries return rows of columns as you're accustomed to, without a <em>select</em> clause HQL queries return domain class instances instead. Allow me to demonstrate.</p>
<h4>SQL</h4>
<p>Take the following SQL query.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="n">SELECT *
FROM product
WHERE name = '12 inch teddy bear' </span>
</span></code></pre></td></tr></table></div></figure>
<p>To run the query, create the following script in the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">com.emmanuelrosa.gormtut.*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.hibernate.transform.AliasToEntityMapResultTransformer</span>
</span><span class='line'>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withNewSession</span> <span class="o">{</span> <span class="n">session</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1">// Run GORM queries within this Closure.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">session</span><span class="o">.</span><span class="na">createSQLQuery</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s2">        SELECT *</span>
</span><span class='line'><span class="s2">        FROM product</span>
</span><span class='line'><span class="s2">        WHERE name = &#39;12 inch teddy bear&#39;</span>
</span><span class='line'><span class="s2">        &quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">setResultTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">AliasToEntityMapResultTransformer</span><span class="o">())</span>
</span><span class='line'>        <span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>You're using Hibernate's <code>Session.createSQLQuery(String)</code> to create a SQL query wthich is represented by a <code>SQLQuery</code> instance. The <code>AliasToEntityMapResultTransformer</code> is used to convert each row from a <code>List</code> into a <code>Map</code>, making it possible to access each column by name. Execute the script to see the output, which when formatted for clarity looks like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;ID&#39;</span><span class="o">:</span><span class="mi">2</span><span class="o">,</span> <span class="s1">&#39;PRICE&#39;</span><span class="o">:</span><span class="mf">8.99</span><span class="o">,</span> <span class="s1">&#39;NAME&#39;</span><span class="o">:</span><span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">,</span> <span class="s1">&#39;VERSION&#39;</span><span class="o">:</span><span class="mi">0</span><span class="o">,</span> <span class="s1">&#39;DESCRIPTION&#39;</span><span class="o">:</span><span class="s1">&#39;12 inch teddy bear, comes with cap and jacket&#39;</span><span class="o">,</span> <span class="s1">&#39;VENDOR_ID&#39;</span><span class="o">:</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>The output is a <code>List</code> of <code>Map</code>s containing each of the selected columns. Without the <code>AliasToEntityMapResultTransformer</code> the output would have been a <code>List</code> of <code>List</code>s. Now lets do the equivalent with a HQL query lacking a <em>select</em> clause.</p>
<h4>HQL</h4>
<p>To see what HQL does without a <em>select</em> clause take the HQL query...</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="n">FROM Product
WHERE name = '12 inch teddy bear' </span>
</span></code></pre></td></tr></table></div></figure>
<p>...and place it in the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">com.emmanuelrosa.gormtut.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withNewSession</span> <span class="o">{</span> <span class="n">session</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1">// Run GORM queries within this Closure.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Product</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s2">    FROM Product</span>
</span><span class='line'><span class="s2">    WHERE name = &#39;12 inch teddy bear&#39; </span>
</span><span class='line'><span class="s2">    &quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Then execute the script. The output looks like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">2</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-warning" role="alert"><p>The output is a <code>List</code> of <code>Product</code>s not a <code>Map&lt;Class, Integer&gt;</code>.</p>
</div>
</p>
<h2>Executing an HQL query</h2>
<p>The <code>GormEntity</code> trait adds a number of methods to domain classes for executing HQL queries. To keep things simple, I'll stick to <code>executeQuery(String query)</code>, <code>executeQuery(String query, Map args)</code>, <code>find(String query)</code> and <code>find(String query, Map params)</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s2">&quot;FROM Product WHERE name = &#39;12 inch teddy bear&#39;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<h3>HQL parameters</h3>
<p>In the example above the HQL query is represented as a <code>String</code>. And within the query there’s the <code>String</code> literal <code>'12 inch teddy bear'</code>. Such nested <code>Strings</code> can become difficult to read, so here’s a way to execute the same query using parameters instead.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s1">&#39;FROM Product WHERE name = :name&#39;</span><span class="o">,</span> <span class="o">[</span><span class="nl">name:</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>
<h3>Get the first (or only) result</h3>
<p>If your query returns a single object as the result, or you only want to use the first result, you can use the <code>GormEntity.find(String)</code> method.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="s1">&#39;FROM Product WHERE name = :name&#39;</span><span class="o">,</span> <span class="o">[</span><span class="nl">name:</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Restrictions</h2>
<p>The example query shown earlier contains a simple equality restriction in the WHERE clause.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;12 inch teddy bear&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The following table lists various SQL and HQL restrictions. As you’ll see, they are identical.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>SQL & HQL</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>name = ‘12 inch teddy bear</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>name <> ‘12 inch teddy bear</td>
                    
                <tr>
            
                <tr>
                    
                        <td>like</td>
                    
                        <td>name like '%teddy bear%'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>case-insensitive like</td>
                    
                        <td>lower(name) like lower('%Teddy Bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>price between 4 and 8</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not between</td>
                    
                        <td>price not between 4 and 8</td>
                    
                <tr>
            
                <tr>
                    
                        <td>in</td>
                    
                        <td>price in (3.49, 9.49)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not in</td>
                    
                        <td>not in (3.49, 9.49)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>price < 4.99</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>price > 4.99</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>price <= 4.99</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>price >= 4.99</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is null</td>
                    
                        <td>state is null</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is not null</td>
                    
                        <td>state is not null</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><div class="alert alert-info" role="alert"><p>Neither SQL or HQL have a case-insensitive like operator, so it's simulated with the <code>lower()</code> function.</p>
</div>
</p>
<p><div class="alert alert-info" role="alert"><p>The <em>is null</em> and <em>is not null</em> restrictions above are from the <code>Address</code> domain class. I chose the <code>Address</code> domain class because the <code>Product</code> domain class doesn’t have null-able properties.</p>
</div>
</p>
<h3>Collection associations</h3>
<p>HQL has a <code>size()</code> function which can be used to count the number of items in a GORM <em>hasMany</em> association, such as the <code>products</code> association in the <code>Vendor</code> class. For example, to query the <code>Vendor</code>s with more than two <code>Product</code>s, you’d likely do something like this in SQL:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">v</span><span class="p">.</span><span class="n">id</span> 
</span><span class='line'><span class="k">FROM</span> <span class="n">vendor</span> <span class="k">as</span> <span class="n">v</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">product</span> <span class="k">as</span> <span class="n">p</span> <span class="k">ON</span> <span class="n">p</span><span class="p">.</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">v</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'><span class="k">HAVING</span> <span class="k">count</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>
<p>Lets try it. Run the query in the Grails console to get the <code>List</code> of <code>Vendor</code> IDs.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">session</span><span class="o">.</span><span class="na">createSQLQuery</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s2">    SELECT v.id </span>
</span><span class='line'><span class="s2">    FROM vendor as v INNER JOIN product as p ON p.vendor_id = v.id</span>
</span><span class='line'><span class="s2">    GROUP BY v.id</span>
</span><span class='line'><span class="s2">    HAVING count(p.id) &gt; 2</span>
</span><span class='line'><span class="s2">        &quot;&quot;&quot;</span><span class="o">).</span><span class="na">list</span><span class="o">()</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>
<p>The output is <code>[1, 3]</code>. With HQL you can accomplish the same thing using <code>size()</code>. Plus, you'll get <code>Vendor</code> instances instead of their IDs. Run the following HQL query and see for yourself.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">FROM</span> <span class="n">Vendor</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="k">size</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>
<p>The <code>size()</code> function does all the heavy lifting! Listed below are examples of restrictions using <code>size()</code>.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>HQL</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>size(products) = 0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>size(products) != 0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>size(products) < 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>size(products) > 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>size(products) >= 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>size(products) <= 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>size(products) between 3 and 5</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Isn’t that cool! In fact, the <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/"><em>from clause</em></a> article in this series shows an example of using the <code>size(someProperty) = 0</code> restriction in place of a left outer join. It's certainly a handy function.</p>
<h2>Conjunctions</h2>
<p>When joining restrictions with <em>and</em> and <em>or</em>, HQL works exactly like the SQL you’re used to. Enough with the trivial, let’s move on to one of the most powerful GORM query methods: criteria queries.</p>
<h1>Criteria query</h1>
<p>Thus far the transition into GORM queries has been straight-forward. The minor differences between SQL and HQL make it so you can leverage what you already know about SQL. Criteria queries provide a more programmer-friendly approach to GORM queries. Instead of <em>declaring</em> queries as <code>String</code>s in your Groovy code, you can <em>build</em> them using Groovy. Take a look at the following comparison of a SQL query and its criteria query equivalent.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>SQL</th>
                    
                        <th>Criteria query</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td><span style="font-family: monospace">SELECT *                         </span></td>
                    
                        <td><span style="font-family: monospace"></span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">FROM product                     </span></td>
                    
                        <td><span style="font-family: monospace">Product.withCriteria {</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 inch teddy bear'</span></td>
                    
                        <td><span style="font-family: monospace">&nbsp;&nbsp;&nbsp;&nbsp;eq('name', '12 inch teddy bear')</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">&nbsp;</span></td>
                    
                        <td><span style="font-family: monospace">}</span></td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>In the listing above I aligned the lines of both queries so that each line's intent matches. Like with HQL, I'll skip over the equivalent of the <em>select</em> clause.</p>
<p>Criteria queries are created with a builder. The criteria query builder features methods used to assemble a query. The methods provide the means to specify restrictions, joins, sorting, etc. In the example above, <code>HibernateCriteriaBuilder.eq(String propertyName, Object value)</code> is used to add an equality restriction to the query.</p>
<h2>The builder</h2>
<p>The builder is actually a facade for a Hibernate <code>Criteria</code>. As such, it expects you to provide a <code>Closure</code> in which the builder methods are called.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">()</span>
</span><span class='line'><span class="kt">def</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">buildCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><code>GormEntity.createCriteria()</code> returns a <code>HibernateCriteriaBuilder</code>. Then, <code>HibernateCriteriaBuilder.buildCriteria(Closure)</code> executes the provided closure to assemble a Hibernate Criteria, which it then returns. To continue building the query after calling <code>buildCriteria(Closure)</code> you'd have to use the Hibernate Criteria methods.</p>
<p><div class="alert alert-info" role="alert"><p>The <code>buildCriteria(Closure)</code> <code>Closure</code>'s delegate is a <code>HibernateCriteriaBuilder</code>.</p>
</div>
</p>
<p>Unlike the traditional builder design pattern, a GORM criteria query does not allow you to call the builder methods directly. For example, the following code does not work:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">()</span>
</span><span class='line'>    
</span><span class='line'><span class="n">builder</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span> <span class="c1">// Throws IllegalArgumentException</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-danger" role="alert">java.lang.IllegalArgumentException: Call to [eq] with propertyName [name] and value [12 inch teddy bear] not allowed here.</div>
</p>
<p><code>buildCriteria(Closure)</code> is seldom used because you're unlikely to use the Hibernate Criteria that it returns. Instead, criteria queries can be built <em>and</em> executed by the builder. Speaking of executing queries, lets do just that.</p>
<h2>Executing a criteria query</h2>
<p>Go ahead and run the following criteria query in the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><code>GormEntity.withCriteria(Closure)</code> does the following:</p>
<ol>
<li>Creates a <code>HibernateCriteriaBuilder</code>.</li>
<li>Uses the builder to assemble a Hibernate <code>Criteria</code>.</li>
<li>Executes the Criteria and returns the results.</li>
</ol>
<p>Lets do each step on its own so you can see what's happening.</p>
<h3>Create the builder</h3>
<p>First, create the <code>HibernateCriteriaBuilder</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now that you have a builder, use it to create a Hibernate <code>Criteria</code>.</p>
<h3>Build the query</h3>
<p>This is the point at which you actually create the query.</p>
<ol>
<li>First, call <code>buildCriteria(Closure)</code> on the builder.</li>
<li>Within the <code>Closure</code> call <code>eq(String propertyName, Object value)</code> to get the <code>Product</code> whose <code>name</code> (the property) is <code>'12 inch teddy bear'</code> (the value).</li>
</ol>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="kt">def</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">buildCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h3>Run the query</h3>
<p>Finally, run the query by calling <code>list()</code> on the <code>Criteria</code> instance.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="kt">def</span> <span class="n">products</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>Like the HQL query, the criteria query doesn’t specify which domain properties to return. Instead it returns domain instances. The domain class on which the <code>withCriteria</code> method is executed determines which domain class instances to return.</p>
<p><div class="alert alert-info" role="alert"><p>A projection can be used to return other domain class instances and/or properties. The <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/"><em>select clause</em></a> article is all about projections.</p>
</div>
</p>
<h3>Get first (or only) result</h3>
<p>Sometimes your query returns a single result. Or you want only the first result. Instead of retrieving the first element in the resulting list, you can...</p>
<ol>
<li>Create the builder with <code>createCriteria()</code>.</li>
<li>Call <code>HibernateCriteria.get(Closure)</code> to construct and execute the query.</li>
</ol>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">().</span><span class="na">get</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Restrictions</h2>
<p>Earlier, I listed various HQL restrictions. Here are their equivalents as criteria queries.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>SQL</th>
                    
                        <th>Criteria</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>name = ‘12 inch teddy bear</td>
                    
                        <td>eq('name', '12 inch teddy bear')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>name <> ‘12 inch teddy bear</td>
                    
                        <td>ne('name', '12 inch teddy bear')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>like</td>
                    
                        <td>name like '%teddy bear%'</td>
                    
                        <td>like('name', '%teddy bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>case-insensitive like</td>
                    
                        <td>lower(name) like lower('%Teddy Bear%')</td>
                    
                        <td>ilike('name', '%Teddy Bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>price between 4 and 8</td>
                    
                        <td>between('price', 4.0, 8.0)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not between</td>
                    
                        <td>price not between 4 and 8</td>
                    
                        <td>not { between('price', 4.0, 8.0) }</td>
                    
                <tr>
            
                <tr>
                    
                        <td>in</td>
                    
                        <td>price in (3.49, 9.49)</td>
                    
                        <td>inList('price', [3.49, 9.49])</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not in</td>
                    
                        <td>not in (3.49, 9.49)</td>
                    
                        <td>not { inList 'price', [3.49, 9.49] }</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>price < 4.99</td>
                    
                        <td>lt('price', 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>price > 4.99</td>
                    
                        <td>gt('price', 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>price <= 4.99</td>
                    
                        <td>le('price', 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>price >= 4.99</td>
                    
                        <td>ge('price', 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is null</td>
                    
                        <td>state is null</td>
                    
                        <td>isNull('state')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is not null</td>
                    
                        <td>state is not null</td>
                    
                        <td>isNotNull('state')</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Unlike HQL which uses expressions to create restrictions, criteria queries use method calls.</p>
<p>Like HQL, criteria queries provide a way to create restrictions based on the size of a collection. The table below compares some size-based HQL restrictions with their equivalents in a criteria query.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>HQL</th>
                    
                        <th>Criteria</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>size(products) = 0</td>
                    
                        <td>sizeEq('products', 0)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>size(products) != 0</td>
                    
                        <td>sizeNe('products', 0)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>size(products) < 3</td>
                    
                        <td>sizeLt('products', 3)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>size(products) > 3</td>
                    
                        <td>sizeGt('products', 3)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>size(products) >= 3</td>
                    
                        <td>sizeGe('products', 3)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>size(products) <= 3</td>
                    
                        <td>sizeLe('products', 3)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>size(products) between 3 and 5</td>
                    
                        <td>N/A</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Like the prior list of restrictions, criteria queries rely on method calls, not expressions. That's why there are multiple <em>size?(String propertyName, int value)</em> criteria methods and only one <code>size()</code> HQL function.</p>
<h3>What about between?</h3>
<p>You may have noticed that criteria queries do not have the equivalent of HQL's expression <code>size(products) between 3 and 5</code>. You can work around this by using <code>sizeGe()</code> along with <code>sizeLe()</code> for an inclusive <em>between</em>, and <code>sizeGt()</code> along with <code>sizeLt()</code> for exclusive <em>between</em>. Either approach requires an <em>and</em> conjunction. So lets look at some conjunctions.</p>
<h2>Conjunctions</h2>
<p>You may be wondering how criteria queries handle <em>and</em> and <em>or</em> conjunctions. For example, examine the where clause in the following SQL query.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span> <span class="k">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>
<p>The <em>like</em> and <em>greater than (>)</em> restrictions must both evaluate to <em>true</em> for a given record to be selected. Lets look at how you can express the same restrictions in a criteria query. Begin with a query with only a single restriction.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">like</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;%bear%&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Next, simply add the appropriate method call for the other restriction.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">like</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;%bear%&#39;</span><span class="o">)</span> <span class="c1">// This is the restriction you had already created. </span>
</span><span class='line'>    <span class="n">gt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">8.0</span><span class="o">)</span>       <span class="c1">// This is the new one. </span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>
<p>That's really all there is to it. By default, when a query contains more than one restriction they are joined by an <em>and</em> conjunction. An <em>and</em> conjunction is created with <code>HibernateCriteriaBuilder.and(Closure)</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">and</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">like</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;%bear%&#39;</span><span class="o">)</span>
</span><span class='line'>        <span class="n">gt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">8.0</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Similarly, an <em>or</em> conjunction is created with <code>HibernateCriteriaBuilder.or(Closure)</code>. Again, starting with SQL…</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent criteria query is...</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">or</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">lt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">4.99</span><span class="o">)</span>
</span><span class='line'>        <span class="n">gt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">8.99</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>As you can see, restrictions built within the <code>or(Closure)</code> closure become the <em>or</em> conjunction. Finally, combining <em>and</em> with <em>or</em>…</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">Product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="k">and</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent criteria query is…</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">or</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">lt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">4.99</span><span class="o">)</span>
</span><span class='line'>        <span class="n">gt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">8.99</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">like</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;%bear%&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Something that deluded me when I first learned about criteria queries is that they are not query definitions. They actually consist of Groovy code. In hindsight, I can't believe I overlooked this. But it means its possible to construct queries dynamically without resorting to the shenanigans you may be accustomed to with <code>String</code>s of SQL statements.  Up next is another builder approach to creating queries.</p>
<h1>Where query</h1>
<p>Like criteria queries, where queries use the builder design pattern. However, restrictions are created with Groovy expressions rather than builder method calls.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>SQL</th>
                    
                        <th>Where query</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td><span style="font-family: monospace">SELECT *</span></td>
                    
                        <td><span style="font-family: monospace"></span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">FROM product                         </span></td>
                    
                        <td><span style="font-family: monospace">Product.where {</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 inch teddy bear'    </span></td>
                    
                        <td><span style="font-family: monospace">&nbsp;&nbsp;&nbsp;&nbsp;name == '12 inch teddy bear'</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">&nbsp;</span></td>
                    
                        <td><span style="font-family: monospace">}.list()</span></td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><code>GormEntity.where(Closure)</code> expects a closure in which Groovy expressions are used to create restrictions. <code>where(Closure)</code> returns a <code>DetachedCriteria</code>. Finally, <code>DetachedCriteria.list()</code> executes the query and returns the results.</p>
<p>In comparison to criteria queries, it's worth pointing out is that with criteria queries you specify the property name as a <code>String</code> (ex. 'name'), while in a where query the property is specified like any other Groovy property.</p>
<p>Now it's your turn to create a where query. In the Grails console, first prepare the <code>Closure</code> that will contain the query. Since you'll be querying the <code>Product</code> domain class, call <code>Product.where(Closure)</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Then, add the equality restriction comparing the <code>name</code> property to the <code>String</code> literal <code>'12 inch teddy bear'</code>. Its just a matter of using Groovy's equality (==) operator.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;12 inch teddy bear&#39;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Finally, execute the query by calling <code>DetachedCriteria.list()</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">builder</span><span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Get first (or only) result</h2>
<p>Sometimes your query returns a single result. Or you want only the first result. Instead of retrieving the first element in the resulting list, you can call <code>DetachedCriteria.get()</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;12 inch teddy bear&#39;</span>
</span><span class='line'><span class="o">}.</span><span class="na">get</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Restrictions</h2>
<p>The following table lists various SQL restrictions and their equivalent where query restrictions.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>SQL</th>
                    
                        <th>Where query</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>name = ‘12 inch teddy bear</td>
                    
                        <td>name == '12 inch teddy bear'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>name <> ‘12 inch teddy bear</td>
                    
                        <td>name != '12 inch teddy bear'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>like</td>
                    
                        <td>name like '%teddy bear%'</td>
                    
                        <td>name ==~ '%teddy bear%'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>case-insensitive like</td>
                    
                        <td>lower(name) like lower('%Teddy Bear%')</td>
                    
                        <td>name =~ '%Teddy Bear%'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>price between 4 and 8</td>
                    
                        <td>price in 4.0..8.0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not between</td>
                    
                        <td>price not between 4 and 8</td>
                    
                        <td>!(price in 4.0..8.0)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>in</td>
                    
                        <td>price in (3.49, 9.49)</td>
                    
                        <td>price in [3.49, 9.49]</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not in</td>
                    
                        <td>not in (3.49, 9.49)</td>
                    
                        <td>!(price in [3.49, 9.49])</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>price < 4.99</td>
                    
                        <td>price < 4.99 </td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>price > 4.99</td>
                    
                        <td>price > 4.99 </td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>price <= 4.99</td>
                    
                        <td>price <= 4.99 </td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>price >= 4.99</td>
                    
                        <td>price >= 4.99 </td>
                    
                <tr>
            
                <tr>
                    
                        <td>is null</td>
                    
                        <td>state is null</td>
                    
                        <td>state == null</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is not null</td>
                    
                        <td>state is not null</td>
                    
                        <td>state != null</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Like HQL, and criteria queries, where queries can perform operations based on the size of a collection association. It's done with the <code>Collection.size()</code> method. The table below compares various size-based HQL restrictions with their where query equivalents.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>HQL</th>
                    
                        <th>Where</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>size(products) = 0</td>
                    
                        <td>products.size() == 0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>size(products) != 0</td>
                    
                        <td>products.size() != 0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>size(products) < 3</td>
                    
                        <td>products.size() < 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>size(products) > 3</td>
                    
                        <td>products.size() > 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>size(products) >= 3</td>
                    
                        <td>products.size() >= 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>size(products) <= 3</td>
                    
                        <td>products.size() <= 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>size(products) between 3 and 5</td>
                    
                        <td>N/A</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<h3>Between is missing here too!</h3>
<p>Where queries also do not have the equivalent of HQL's expression <code>size(products) between 3 and 5</code>. You can work around this by using the <code>&gt;=</code> and <code>&lt;=</code> operators for an inclusive <em>between</em>, or <code>&gt;</code> and <code>&lt;</code> for exclusive <em>between</em>. An example of an inclusive <em>between</em> is: <code>products.size() &gt;= 3 &amp;&amp; products.size() &lt;= 5</code>. Either approach requires an <em>and</em> conjunction.</p>
<h2>Conjunctions</h2>
<p>Where queries handle <em>and</em> and <em>or</em> conjunctions using Groovy logical operators. When a query contains more than one restriction by default they are joined an <em>and</em> conjunction. For example, examine the where clause in the following SQL query.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span> <span class="k">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>
<p>Two conditions must be met to select a given product. The equivalent restriction can be expressed as a where query like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==~</span> <span class="s1">&#39;%bear%&#39;</span>
</span><span class='line'>    <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>Which can also be expressed using the <code>&amp;&amp;</code> operator like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==~</span> <span class="s1">&#39;%bear%&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>An <em>or</em> conjunction is created with the <code>||</code> operator. Again, starting with SQL…</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent where query is as follows:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">price</span> <span class="o">&lt;</span> <span class="mf">4.99</span> <span class="o">||</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mf">8.99</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>As you can see, restrictions built within the <code>||</code> operator become the <em>or</em> conjunction. Finally, combining <em>and</em> with <em>or</em>…</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">Product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="k">and</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent where query is…</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">price</span> <span class="o">&lt;</span> <span class="mf">4.99</span> <span class="o">||</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mf">8.99</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==~</span> <span class="s1">&#39;%bear%&#39;</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<h1>Dynamic finder</h1>
<p>Dynamic finders provide a way to execute very simple queries.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>SQL</th>
                    
                        <th>Dynamic finder</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td><span style="font-family: monospace">SELECT *</span></td>
                    
                        <td><span style="font-family: monospace">&nbsp;</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">FROM product                         </span></td>
                    
                        <td><span style="font-family: monospace">Product.findAllByName('12 inch teddy bear')</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 inch teddy bear'    </span></td>
                    
                        <td><span style="font-family: monospace">&nbsp;</span></td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>A Dynamic finder is a domain class method following a specific naming convention. The term dynamic finder comes from the fact that the method doesn’t actually exist. Thank you, Groovy MOP.</p>
<p>The method naming convention loosely defined is <em>domainClass.findAllByPropertyNameInCamelCaseWithAComparison(and, some, parameters)</em>.</p>
<p>Using the query above as an example...</p>
<ol>
<li><em>findAllBy</em> indicates that you want to execute a dynamic finder which returns one or more <code>Product</code>s.</li>
<li><em>Name</em> specifies the property.</li>
<li>The equals operator is used by default, so it's left unspecified.</li>
<li>'12 inch teddy bear' is the property value to compare against.</li>
</ol>
<p><div class="alert alert-info" role="alert"><p>The <code>findAllBy</code> dynamic finder is implemented by <code>FindAllByFinder</code>. A list of dynamic finders can be found in the property <code>GormEntity.gormDynamicFinders</code>.</p>
</div>
</p>
<p>Lets give a dynamic finder a go. Create a one to return <em>all</em> of the <code>Product</code>s with a <code>price</code> of <code>3.49</code>. In the Grails console, begin with the domain class and <code>findAllBy</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllBy</span>
</span></code></pre></td></tr></table></div></figure>
<p>Next, append the property name in camel case.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllByPrice</span>
</span></code></pre></td></tr></table></div></figure>
<p>That completes the method name. Now you need to add the value <code>3.49</code> as a parameter.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllByPrice</span><span class="o">(</span><span class="mf">3.49</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>Finally, run it to see the three matching <code>Product</code>s.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">4</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">5</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">6</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<h3>Get first (or only) result</h3>
<p>If your query returns a single result, or you only want to use the first result begin the dynamic finder method with <em>findBy</em> rather than <em>findAllBy</em>:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>Like all the GORM queries discussed so far, the dynamic finder query does not specify the equivalent of a SELECT clause. In fact, dynamic finders do not support the notion. They always return a list of domain class instances.</p>
<h2>Restrictions</h2>
<p>The following table lists various SQL restrictions and the equivalent dynamic finder methods.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>SQL</th>
                    
                        <th>Dynamic finder</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>name = ‘12 inch teddy bear</td>
                    
                        <td>Product.findAllByName('12 inch teddy bear')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>name <> ‘12 inch teddy bear</td>
                    
                        <td>Product.findAllByNameNotEqual('12 inch teddy bear')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>like</td>
                    
                        <td>name like '%teddy bear%'</td>
                    
                        <td>Product.findAllByNameLike('%teddy bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>case-insensitive like</td>
                    
                        <td>lower(name) like lower('%Teddy Bear%')</td>
                    
                        <td>Product.findAllByNameIlike('%Teddy Bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>price between 4 and 8</td>
                    
                        <td>Product.findAllByPriceBetween(4, 8)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not between</td>
                    
                        <td>price not between 4 and 8</td>
                    
                        <td>N/A</td>
                    
                <tr>
            
                <tr>
                    
                        <td>in</td>
                    
                        <td>price in (3.49, 9.49)</td>
                    
                        <td>Product.findAllByPriceInList([3.49, 9.49])</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not in</td>
                    
                        <td>not in (3.49, 9.49)</td>
                    
                        <td>N/A</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>price < 4.99</td>
                    
                        <td>Product.findAllByPriceLessThan( 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>price > 4.99</td>
                    
                        <td>Product.findAllByPriceGreaterThan(4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>price <= 4.99</td>
                    
                        <td>Product.findAllByPriceLessThanEquals(4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>price >= 4.99</td>
                    
                        <td>Product.findAllByPriceGreaterThanEquals(4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is null</td>
                    
                        <td>state is null</td>
                    
                        <td>Address.findAllByStateIsNull()</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is not null</td>
                    
                        <td>state is not null</td>
                    
                        <td>Address.findAllByStateIsNotNull()</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<h2>Conjunctions</h2>
<p>Dynamic finders support <em>and</em> and <em>or</em> conjunctions, but without order of precedence. For example, examine the where clause in the following SQL query.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span> <span class="k">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent dynamic finder is…</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllByNameLikeAndPriceGreaterThan</span><span class="o">(</span><span class="s1">&#39;%bear%&#39;</span><span class="o">,</span> <span class="mi">8</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>In the dynamic finder example above, the <em>NameLike</em> and <em>PriceGreaterThan</em> parts of the method are joined by an <em>And</em>. Then, the parameters are specified in the same order as the properties are declared in the method: <em>name</em>, then <em>price</em>.</p>
<p>An <em>or</em> conjunction works the same way:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllByPriceLessThanOrPriceGreaterThan</span><span class="o">(</span><span class="mf">4.99</span><span class="o">,</span> <span class="mf">8.99</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>It’s possible to combine <em>and</em> and <em>or</em> as long as order of precedence is not important. For example, the following SQL query cannot be represented as a dynamic finder:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="k">and</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<h1>Conclusion</h1>
<p>That concludes this article in the GORM for SQLaddicts series. Now that you know how to construct the equivalent of a SQL <em>where</em> clause using a criteria query, where query, and dynamic finder, you're ready to tackle the equivalent of the <em>from</em> clause. <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/">Ready?</a></p>
]]></content></entry></feed>