<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom"><title><![CDATA[EmmanuelRosa.com]]></title><link href="http://emmanuelrosa.com/categories/gorm/atom.xml" rel="self"/><link href="http://emmanuelrosa.com/"/><updated>2015-12-23T19:21:16-05:00</updated><id>http://emmanuelrosa.com/</id><author><name><![CDATA[Emmanuel Rosa]]></name></author><generator uri="http://sysgears.com/grain/">Grain</generator><entry><title type="html"><![CDATA[Grails domain class associations]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/grails-domain-class-associations/"/><updated>2015-12-22T10:31:21-05:00</updated><id>f2d6a065bb3b8db98641f90c390a8823</id><content type="html"><![CDATA[<p>When working with Grails domain models I often find myself wondering: <em>How is this modeled in the database?</em></p>
<p>The combinations of <code>hasMany</code>, <code>belongsTo</code>, (and the occasional <code>hasOne</code>) lead to the <a href="#onetomany">one-to-many</a>, <a href="#manytomany">many-to-many</a>, <a href="#manytoone">many-to-one</a>, and <a href="#onetoone">one-to-one</a> associations. But how? What are these combinations? <!--more-->Well, feast your eyes on some Groovy and relational database porn.</p>
<h1><a name="onetomany"></a>One-to-many</h1>
<p>In the first example, an <code>Author</code> has many <code>Book</code>s, producing a one-to-many uni-directional relationship. Uni-directional meaning that an <code>Author</code> has a reference to its <code>Book</code>s, however, a <code>Book</code> has no clue about its <code>Author</code>. The association is created with the <code>hasMany</code> static property in the <code>Author</code> domain class.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">books:</span> <span class="n">Book</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/one-to-many-c2eba0c1097bf6df3fa1cdf1c5eac252.png' alt='One-to-many' >
</p>
<p>As shown in the database diagram, Grails creates a <em>join table</em> to represent the one-to-many association. The join table has two foreign key columns: the <code>Author</code>'s ID, and the <code>Book</code>'s ID.</p>
<p>It's worth nothing, since the <code>Book</code> does not have a reference to its <code>Author</code>, it's possible for multiple <code>Author</code>s to have the same <code>Book</code>. Notice how the <code>author_book</code> table makes this possible. To have Grails enforce that you want a <code>Book</code> to have a single <code>Author</code>, you'll need a bi-directional one-to-many association.</p>
<h2>Bi-directional</h2>
<p>With a bi-directional association, a <code>Book</code> is given a property which references its <code>Author</code>. This is done by adding a <code>belongsTo</code> static property to the <code>Book</code> class.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">books:</span> <span class="n">Book</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="o">[</span><span class="nl">author:</span> <span class="n">Author</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/one-to-many-bi-dfbc551ac9b7bfed5c9447447dbbea14.png' alt='One-to-many bi-directional' >
</p>
<p>Now, a foreign key is added to the <code>Book</code> containing the <code>Author</code>'s ID. The join table is simply not used anymore. This implies that without an <code>Author</code> there can be no <code>Book</code>. Put differently, an <code>Author</code> <em>owns</em> its <code>Book</code>s.</p>
<h1><a name="manytomany"></a>Many-to-many</h1>
<p>A many-to-many association is created by using a <code>hasMany</code> static property in both domain classes. <strong>And</strong>, by using a <code>belongsTo</code> static property lacking a back-reference in the <code>Book</code> domain class.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">books:</span> <span class="n">Book</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">authors:</span> <span class="n">Author</span><span class="o">]</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="n">Author</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/many-to-many-3331d20a67053e0bfa999b3b56daa314.png' alt='Many-to-many' >
</p>
<p>Like a uni-directional one-to-many, a many-to-many association uses a join table. In fact, at the database level it looks identical to a uni-directional one-to-many.</p>
<h1><a name="manytoone"></a>Many-to-one</h1>
<p>Creating a uni-directional many-to-one association doesn't require <code>hasMany</code> or the like. It's just a matter of adding an instance property.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'>    <span class="n">Publisher</span> <span class="n">publisher</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Publisher</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/many-to-one-cccf0306a07ab1574ae646f8db21e9ce.png' alt='Many-to-one' >
</p>
<h2>Bi-directional</h2>
<p>A bi-directional many-to-one is created using the static <code>belongsTo</code> property. Surprisingly, this doesn't affect the database.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">title</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">year</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">isbn</span>
</span><span class='line'>    <span class="n">Publisher</span> <span class="n">publisher</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">Publisher</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="o">[</span><span class="nl">book:</span> <span class="n">Book</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h1><a name="onetoone"></a>One-to-one</h1>
<p>Finally, you get to see the static <code>hasOne</code> property in action!</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Author</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">name</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasOne</span> <span class="o">=</span> <span class="o">[</span><span class="nl">user:</span> <span class="n">User</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">username</span>
</span><span class='line'>    <span class="n">Author</span> <span class="n">author</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><img src='http://emmanuelrosa.com/images/one-to-one-c016839141ca5622bd8b36c28f5a359b.png' alt='One-to-one' >
</p>
<p>In the database, it looks just like a bi-directional one-to-many.</p>
<h1>Enlightenment</h1>
<p>As you've just read, it takes a precise combination of the <code>hasMany</code>, <code>belongsTo</code> and <code>hasOne</code> static properties, and sometimes an instance property, to assemble the various Grails domain class associations. Some are <em>self-explanatory</em>, others not so much. Either way, you may reference this guide when you need it.</p>
]]></content></entry><entry><title type="html"><![CDATA[Design Failure: A reflection of a mistaken Grails app domain model design]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/design-failure-a-reflection-of-a-mistaken-grails-app-domain-model-design/"/><updated>2015-12-22T10:31:21-05:00</updated><id>1f9110f0a04e368520552fa394207196</id><content type="html"><![CDATA[<p>Back in April of this year I took over the development of a client's Grails application. The app is simple:</p>
<ol>
<li>Business ideas flow into it</li>
<li>The ideas are displayed for people to vote on.</li>
<li>The top 3 voted ideas during a given week are deemed the winners. <em>(Still working on this one)</em></li>
</ol>
<p>Initially, once the weekly competition completed, the winning ideas became inaccessible because the view was designed to render only the ideas for the <em>current</em> competition. Yeah, talk about a brain fart.</p>
<!--more-->
<p>My solution was to simply keep track of all winning ideas using a new domain model. Besides, the <em>previous</em> and <em>current</em> competition stats were kept in two properties of the same domain class. It was a putrid situation in need of venting.</p>
<p><em>Great!</em>, I thought. <em>I know exactly what to do</em>. And so I proceeded with a new model similar to this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Competition</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Date</span> <span class="n">startDate</span>
</span><span class='line'>    <span class="n">Idea</span> <span class="n">idea</span>
</span><span class='line'>    <span class="n">Integer</span> <span class="n">votes</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">mapping</span> <span class="o">{</span>
</span><span class='line'>        <span class="nl">id:</span> <span class="nl">composite:</span> <span class="o">[</span><span class="s1">&#39;startDate&#39;</span><span class="o">,</span> <span class="s1">&#39;idea&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * The hashCode() and equals() dance.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Yeah... the problem should have been obvious to me, but it wasn't. Since each competition is identified by its start date, and each idea can be in a competition only once, I figured this was a logical solution.</p>
<p>And in fact, it works just fine. Recording a vote in a competition is simple:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">example</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Competition</span><span class="o">(</span><span class="nl">idea:</span> <span class="n">idea</span><span class="o">,</span> <span class="nl">startDate:</span> <span class="n">startDate</span><span class="o">)</span>
</span><span class='line'><span class="kt">def</span> <span class="n">competition</span> <span class="o">=</span> <span class="n">Competition</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">example</span><span class="o">)</span> <span class="o">?:</span> <span class="n">competition</span> 
</span><span class='line'>
</span><span class='line'><span class="n">competition</span><span class="o">.</span><span class="na">votes</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1">// or -= 1 for a down-vote</span>
</span><span class='line'><span class="n">competition</span><span class="o">.</span><span class="na">save</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>An existing <code>Competition</code> is used if possible, otherwise a new instance is created. No problem. Except... that a competition is supposed to be able to have multiple ideas. And while the <code>Competition</code> model does <em>work</em>, it's design doesn't reflect its purpose. If my design was by intention for performance or anoother technical reason, I would be content. But the fact remains that I blatantly overlooked the <em>concept</em> of a competition and instead fixated on the <em>implementation</em>. I'm not even going to discuss what I did with the services. I'd clear the room.</p>
<p>The code-smell remained elusive until the day I began working on a new feature and needed a list of the competitions; meaning a list of competition dates.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">competitionDates</span> <span class="o">=</span> <span class="n">Competition</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">projections</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">distinct</span><span class="o">(</span><span class="s1">&#39;startDate&#39;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span> 
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>I had to use <em>DISTINCT</em>.</p>
<p>My days supporting horrid Microsoft Access databases taught me that having to use <em>DISTINCT</em> can be a sign of a... <em>ignorantly de-normalized</em> database. (I resisted the urge to use a more descriptive four-letter word)</p>
<h2>Redemption</h2>
<p>If you're like me, software architecture just rocks your socks off. When a particular problem enters my mind, there's no shutting it up until I solve it. It doesn't care that I go hungry, or that my eyes itch, or that I <em>really</em> need to visit the toilet. It demands my full attention; Emmanuel be damned.</p>
<p>OK, maybe I exaggerated a bit. In this case the solution is rather simple:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Competition</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Date</span> <span class="n">startDate</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">ideas:</span> <span class="n">CompetitionIdea</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">mapping</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">id</span> <span class="nl">generator:</span> <span class="s1">&#39;assigned&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;startDate&#39;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">CompetitionIdea</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Idea</span> <span class="n">idea</span>
</span><span class='line'>    <span class="n">Integer</span> <span class="n">votes</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">belongsTo</span> <span class="o">=</span> <span class="o">[</span><span class="nl">competition:</span> <span class="n">Competition</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">idea</span> <span class="nl">unique:</span> <span class="s1">&#39;competition&#39;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now a competition can indeed have multiple ideas.</p>
<p>Aaaahhhhh. Now I can relieve myself in peace <span class="fa fa-smile-o"></span></p>
<h2>Lesson learned</h2>
<p>I don't recall my thought the process when developing the <code>Competition</code> domain model. But because I'm a SQL aficionado, I can only assume that my thinking was too data-centric, too early. By focusing on how to store the data I didn't give enough attention to the concepts the data represents. That's something for me to watch out for in the future.</p>
<p>Speaking of software architecture, have you read any of <a href="http://aosabook.org/en/index.html">The Architecture of Open Source Applications</a> books? As of now there are three books and a fourth is on the way. Written by the developers themselves, the books cover the design of various open source applications. They make for a good read.</p>
]]></content></entry><entry><title type="html"><![CDATA[Grails Domain Class Inheritance]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/grails-domain-class-inheritance/"/><updated>2015-12-22T10:31:21-05:00</updated><id>2e55fc1b4b76223bff36c890792b077d</id><content type="html"><![CDATA[<p>Ever wonder what happens at the database level when you use GORM's domain class inheritance? What's the difference between <em>table-per-hierarchy</em> and <em>table-per-subclass</em> inheritance? That's what this article is all about.</p>
<!--more-->
<p>Grails' database mapping layer GORM provides two ways to achieve domain class inheritance with polymorphic GORM queries. Let me introduce you to the first method, the default in Grails and the right choice for most use cases. Let's give a round of applause to... <em>table-per-hierarchy</em> inheritance!</p>
<h1>Table-per-hierarchy</h1>
<p>Table-per-hierarchy inheritance means that the super-class class and all its sub-classes share the same database table. Take a look at these domain classes:</p>
<figure class='code'><figcaption><span>Employee.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">String</span> <span class="n">firstName</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">lastName</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>Supervisor.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Supervisor</span> <span class="kd">extends</span> <span class="n">Employee</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">hasMany</span> <span class="o">=</span> <span class="o">[</span><span class="nl">subordinates:</span> <span class="n">Employee</span><span class="o">]</span>
</span><span class='line'>    <span class="kd">static</span> <span class="n">constraints</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>An <code>Employee</code> contains <code>firstName</code> and <code>lastName</code> properties. A <code>Supervisor</code> is a subclass of <code>Employee</code> and only adds the ability to have subordinates; simply a collection of <code>Employee</code>s. To get a good understanding of how this works in practice, lets take a peak at the database.</p>
<h2>The database tables</h2>
<p>GORM implements the two domain classes as one database table.</p>
<p><div class="panel panel-default">
    
        <div class="panel-heading">
            <h3 class="panel-title">EMPLOYEE table</h3>
        </div>
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>ID</th>
                    
                        <th>VERSION</th>
                    
                        <th>FIRST_NAME</th>
                    
                        <th>LAST_NAME</th>
                    
                        <th>CLASS</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>1</td>
                    
                        <td>0</td>
                    
                        <td>Dagny</td>
                    
                        <td>Taggart</td>
                    
                        <td>Supervisor</td>
                    
                <tr>
            
                <tr>
                    
                        <td>2</td>
                    
                        <td>0</td>
                    
                        <td>Eddie</td>
                    
                        <td>Willers</td>
                    
                        <td>Employee</td>
                    
                <tr>
            
                <tr>
                    
                        <td>3</td>
                    
                        <td>0</td>
                    
                        <td>James</td>
                    
                        <td>Taggart</td>
                    
                        <td>Supervisor</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><div class="alert alert-info" role="alert"><p>The <em>class</em> column in the table actually contains the full class name; package name plus class name. I excluded the package name from the above listing.</p>
</div>
</p>
<p>In addition to the <code>EMPLOYEE</code> table, GORM creates the <code>SUPERVISOR_EMPLOYEE</code> table for the <em>one-to-many</em> <code>subordinates</code> association. This table is not critical to inheritance, so I won't discuss it any further. For details on associations read <a href="http://emmanuelrosa.com/articles/grails-domain-class-associations/">this</a> article.</p>
<h2>The queries</h2>
<p>The <code>EMPLOYEE</code> table has a <code>CLASS</code> column which distinguishes which domain class corresponds to the record. This makes it possible to list all employees...</p>
<figure class='code'><figcaption><span>SQL</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">ID</span><span class="p">,</span> <span class="n">FIRST_NAME</span><span class="p">,</span> <span class="n">LAST_NAME</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">EMPLOYEE</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>GORM</span></figcaption><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>... or to list only <code>Supervisors</code>...</p>
<figure class='code'><figcaption><span>SQL</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">ID</span><span class="p">,</span> <span class="n">FIRST_NAME</span><span class="p">,</span> <span class="n">LAST_NAME</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">EMPLOYEE</span>
</span><span class='line'><span class="k">WHERE</span>  <span class="k">CLASS</span> <span class="o">=</span> <span class="s1">&#39;emmanuel.rosa.grailsinheritanceexample.Supervisor&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span>GORM</span></figcaption><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">supervisors</span> <span class="o">=</span> <span class="n">Supervisor</span><span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>So far, except for the <code>subordinates</code> association, the <code>Supervisor</code> domain class contains the same properties as the <code>Employee</code> domain class. Lets add an <code>office</code> property. Only supervisors have offices right?</p>
<figure class='code'><figcaption><span>Supervisor.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Supervisor</span> <span class="kd">extends</span> <span class="n">Employee</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">office</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now the <code>EMPLOYEE</code> table has an <code>OFFICE</code> column.</p>
<p><div class="panel panel-default">
    
        <div class="panel-heading">
            <h3 class="panel-title">EMPLOYEE table</h3>
        </div>
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>ID</th>
                    
                        <th>VERSION</th>
                    
                        <th>FIRST_NAME</th>
                    
                        <th>LAST_NAME</th>
                    
                        <th>CLASS</th>
                    
                        <th>OFFICE</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>1</td>
                    
                        <td>0</td>
                    
                        <td>Dagny</td>
                    
                        <td>Taggart</td>
                    
                        <td>Supervisor</td>
                    
                        <td>Operations Suite</td>
                    
                <tr>
            
                <tr>
                    
                        <td>2</td>
                    
                        <td>0</td>
                    
                        <td>Eddie</td>
                    
                        <td>Willers</td>
                    
                        <td>Employee</td>
                    
                        <td>null</td>
                    
                <tr>
            
                <tr>
                    
                        <td>3</td>
                    
                        <td>0</td>
                    
                        <td>James</td>
                    
                        <td>Taggart</td>
                    
                        <td>Supervisor</td>
                    
                        <td>Basement</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><div class="alert alert-warning" role="alert"><p>By default domain class properties are not null-able (NOT NULL in SQL speak). I'm using an H2 database for this demonstration and apparently the office field is not being set to NOT NULL. If I were to use my favorite DBMS PostgreSQL, it would reject the Eddie Willers record. So I'm going to pretend that NOT NULL is working properly and that the <code>office</code> field should be as-is; not null-able.</p>
</div>
</p>
<p>What this means in practice is that it's now impossible to create instances of the <code>Employee</code> domain class because <code>Employee</code>s don't have an office, yet the office field cannot be NULL. Don't worry, GORM offers a way out: <em>table-per-subclass</em> inheritance.</p>
<h1>Table-per-subclass</h1>
<p>Table-per-subclass means that a subclass is represented in the database as a table consisting of <strong>the <em>difference</em> between itself and its super-class</strong>. First, the default inheritance stragety must be changed.</p>
<figure class='code'><figcaption><span>Employee.groovy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">Employee</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">static</span> <span class="n">mapping</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">tablePerHierarchy</span> <span class="kc">false</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>With the change described above applied, the <code>OFFICE</code> column is moved to a separate table.</p>
<p><div class="panel panel-default">
    
        <div class="panel-heading">
            <h3 class="panel-title">EMPLOYEE table</h3>
        </div>
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>ID</th>
                    
                        <th>VERSION</th>
                    
                        <th>FIRST_NAME</th>
                    
                        <th>LAST_NAME</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>1</td>
                    
                        <td>0</td>
                    
                        <td>Dagny</td>
                    
                        <td>Taggart</td>
                    
                <tr>
            
                <tr>
                    
                        <td>2</td>
                    
                        <td>0</td>
                    
                        <td>Eddie</td>
                    
                        <td>Willers</td>
                    
                <tr>
            
                <tr>
                    
                        <td>3</td>
                    
                        <td>0</td>
                    
                        <td>James</td>
                    
                        <td>Taggart</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><div class="panel panel-default">
    
        <div class="panel-heading">
            <h3 class="panel-title">SUPERVISOR table</h3>
        </div>
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>ID</th>
                    
                        <th>OFFICE</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>1</td>
                    
                        <td>Operations Suite</td>
                    
                <tr>
            
                <tr>
                    
                        <td>3</td>
                    
                        <td>Basement</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Notice that <code>Supervisors</code> have a record in the <code>SUPERVISOR</code> table <em>and</em> in the <code>EMPLOYEE</code> table. In addition, the record IDs are shared between both tables. The relationship at the database level is a <em>one-to-one</em>.  This means querying for <code>Supervisor</code>s in SQL requires a table join.</p>
<figure class='code'><figcaption><span>SQL</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">EMPLOYEE</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">FIRST_NAME</span><span class="p">,</span> <span class="n">LAST_NAME</span>
</span><span class='line'><span class="k">FROM</span>   <span class="n">SUPERVISOR</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">EMPLOYEE</span> 
</span><span class='line'>       <span class="k">ON</span> <span class="n">SUPERVISOR</span><span class="p">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">EMPLOYEE</span><span class="p">.</span><span class="n">ID</span>
</span></code></pre></td></tr></table></div></figure>
<h1>The end</h1>
<p>Well, this wraps up this discussion on Grails polymorphic sub-classing. You just learned about the differences between GORM'S two methods of inheritance and what they look like at the database level. Want to play around with the code? Just clone the Mercurial repository as shown below:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>hg clone ssh://hg@bitbucket.org/erosa/grails-inheritance-example
</span></code></pre></td></tr></table></div></figure>
]]></content></entry><entry><title type="html"><![CDATA[GORM for SQLaddicts: WHERE Clause]]></title><link rel="alternative" href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-where-clause/"/><updated>2015-12-10T18:48:51-05:00</updated><id>3c50af512f1f96b65c4c96102a2696c1</id><content type="html"><![CDATA[<p>Learn how to implement the equivalent of a SQL WHERE clause using an HQL query, criteria query, where query, and dynamic finder. <!--more-->You'll save time by learning GORM using the SQL concepts you already know.</p>
<p><h1>GORM for SQLaddicts</h1>
<p>Welcome to the GORM for SQLaddicts series. A collection of articles dedicated to experienced SQL programmers who want to learn how to query GORM, the Grails object-relational mapper.</p>
<p>Throughout this series you will learn how to</p>
<ol>
<li><strong>WHERE - Add restrictions to a query</strong></li>
<li><a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/">FROM - Work with associations and joins</a></li>
<li><a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/">SELECT - Return multiple properties and/or domain classes</a></li>
</ol>
<h2>Getting started</h2>
<p>To follow along you'll need <a href="https://grails.org/">Grails</a> 3.0.5 and <a href="https://www.mercurial-scm.org/">Mercurial</a>. With Grails and Mercurial installed you can download the source code and run the Grails console.</p>
<h3>Setup</h3>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>hg clone ssh://hg@bitbucket.org/erosa/gormtut
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>gormtut 
</span><span class='line'><span class="nv">$ </span>grails console
</span></code></pre></td></tr></table></div></figure>
<p>Once the Grails console window appears, copy &amp; paste the following code into the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">com.emmanuelrosa.gormtut.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withNewSession</span> <span class="o">{</span> <span class="n">session</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1">// Run GORM queries within this Closure.</span>
</span><span class='line'>    
</span><span class='line'>    
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now you're set up to execute GORM queries. All you need to do is write the query within the <code>Closure</code> and run the code (Script->Run or Command-R).</p>
<h3>Domain classes</h3>
<p>The examples in this article reference the <code>Product</code>, <code>Vendor</code>, and <code>Address</code> domain classes. See the diagram below to see how the domain classes are related to each other.</p>
<p><img src="http://emmanuelrosa.com/images/sqladdicts-domains-dd608e6240ea469473399853225b6c94.svg" alt="Domain class diagram" /></p>
</p>
<p>You'll begin with HQL due to it's similarity to SQL. From there, you'll learn about criteria queries, where queries, and finally dynamic finders. Let's get started.</p>
<h1>HQL</h1>
<p>HQL is a natural way to begin learning GORM queries simply because it makes the most of the SQL you already know. The significant differences in HQL are noticeable in the <a href="/articles/gorm-for-sqladdicts-select-clause/">GORM for SQLaddicts: SELECT clause</a> and <a href="/articles/gorm-for-sqladdicts-from-clause/">GORM for SQLAddicts: FROM Clause</a> articles, but there are still some worth mentioning now.</p>
<h2>Anatomy</h2>
<p>The table below compares a SQL query to it's HQL equivalent. Take a look and see how many differences you can identify.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>SQL</th>
                    
                        <th>HQL</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td><span style="font-family: monospace">SELECT *</span></td>
                    
                        <td><span style="font-family: monospace"></span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">FROM product</span></td>
                    
                        <td><span style="font-family: monospace">FROM Product</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 in teddy bear'</span></td>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 in teddy bear'</span></td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>There are a whopping 2 differences: the <em>Product</em> in the <em>from</em> clause is case-sensitive and the <em>select</em> clause is missing.</p>
<h3>Case sensitivity</h3>
<p>An important difference between SQL and HQL is that in SQL you select from <em>tables</em> while in HQL you select from <em>domain classes</em>. Because you're dealing with classes names rather than tables names, the names are case-sensitive.</p>
<h3>Columns vs Objects</h3>
<p>

<blockquote>
    <p>So... how do I select properties?</p>
    <footer>
        
            <strong>You</strong>
        
        
    </footer>
</blockquote></p>
<p>The <em>select</em> clause, which is covered in the <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/"><em>select clause</em></a> article, can be used to return rows of domain class properties. The important thing to know for now is that while SQL queries return rows of columns as you're accustomed to, without a <em>select</em> clause HQL queries return domain class instances instead. Allow me to demonstrate.</p>
<h4>SQL</h4>
<p>Take the following SQL query.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="n">SELECT *
FROM product
WHERE name = '12 inch teddy bear' </span>
</span></code></pre></td></tr></table></div></figure>
<p>To run the query, create the following script in the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">com.emmanuelrosa.gormtut.*</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.hibernate.transform.AliasToEntityMapResultTransformer</span>
</span><span class='line'>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withNewSession</span> <span class="o">{</span> <span class="n">session</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1">// Run GORM queries within this Closure.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">session</span><span class="o">.</span><span class="na">createSQLQuery</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s2">        SELECT *</span>
</span><span class='line'><span class="s2">        FROM product</span>
</span><span class='line'><span class="s2">        WHERE name = &#39;12 inch teddy bear&#39;</span>
</span><span class='line'><span class="s2">        &quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">setResultTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">AliasToEntityMapResultTransformer</span><span class="o">())</span>
</span><span class='line'>        <span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>You're using Hibernate's <code>Session.createSQLQuery(String)</code> to create a SQL query wthich is represented by a <code>SQLQuery</code> instance. The <code>AliasToEntityMapResultTransformer</code> is used to convert each row from a <code>List</code> into a <code>Map</code>, making it possible to access each column by name. Execute the script to see the output, which when formatted for clarity looks like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span><span class="s1">&#39;ID&#39;</span><span class="o">:</span><span class="mi">2</span><span class="o">,</span> <span class="s1">&#39;PRICE&#39;</span><span class="o">:</span><span class="mf">8.99</span><span class="o">,</span> <span class="s1">&#39;NAME&#39;</span><span class="o">:</span><span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">,</span> <span class="s1">&#39;VERSION&#39;</span><span class="o">:</span><span class="mi">0</span><span class="o">,</span> <span class="s1">&#39;DESCRIPTION&#39;</span><span class="o">:</span><span class="s1">&#39;12 inch teddy bear, comes with cap and jacket&#39;</span><span class="o">,</span> <span class="s1">&#39;VENDOR_ID&#39;</span><span class="o">:</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p>The output is a <code>List</code> of <code>Map</code>s containing each of the selected columns. Without the <code>AliasToEntityMapResultTransformer</code> the output would have been a <code>List</code> of <code>List</code>s. Now lets do the equivalent with a HQL query lacking a <em>select</em> clause.</p>
<h4>HQL</h4>
<p>To see what HQL does without a <em>select</em> clause take the HQL query...</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="n">FROM Product
WHERE name = '12 inch teddy bear' </span>
</span></code></pre></td></tr></table></div></figure>
<p>...and place it in the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kn">import</span> <span class="nn">com.emmanuelrosa.gormtut.*</span>
</span><span class='line'>
</span><span class='line'><span class="n">Vendor</span><span class="o">.</span><span class="na">withNewSession</span> <span class="o">{</span> <span class="n">session</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="c1">// Run GORM queries within this Closure.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Product</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s2">    FROM Product</span>
</span><span class='line'><span class="s2">    WHERE name = &#39;12 inch teddy bear&#39; </span>
</span><span class='line'><span class="s2">    &quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Then execute the script. The output looks like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span><span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">2</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-warning" role="alert"><p>The output is a <code>List</code> of <code>Product</code>s not a <code>Map&lt;Class, Integer&gt;</code>.</p>
</div>
</p>
<h2>Executing an HQL query</h2>
<p>The <code>GormEntity</code> trait adds a number of methods to domain classes for executing HQL queries. To keep things simple, I'll stick to <code>executeQuery(String query)</code>, <code>executeQuery(String query, Map args)</code>, <code>find(String query)</code> and <code>find(String query, Map params)</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s2">&quot;FROM Product WHERE name = &#39;12 inch teddy bear&#39;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<h3>HQL parameters</h3>
<p>In the example above the HQL query is represented as a <code>String</code>. And within the query theres the <code>String</code> literal <code>'12 inch teddy bear'</code>. Such nested <code>Strings</code> can become difficult to read, so heres a way to execute the same query using parameters instead.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s1">&#39;FROM Product WHERE name = :name&#39;</span><span class="o">,</span> <span class="o">[</span><span class="nl">name:</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>
<h3>Get the first (or only) result</h3>
<p>If your query returns a single object as the result, or you only want to use the first result, you can use the <code>GormEntity.find(String)</code> method.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="s1">&#39;FROM Product WHERE name = :name&#39;</span><span class="o">,</span> <span class="o">[</span><span class="nl">name:</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Restrictions</h2>
<p>The example query shown earlier contains a simple equality restriction in the WHERE clause.</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='sql'><span class='line'><span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;12 inch teddy bear&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The following table lists various SQL and HQL restrictions. As youll see, they are identical.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>SQL & HQL</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>name = 12 inch teddy bear</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>name <> 12 inch teddy bear</td>
                    
                <tr>
            
                <tr>
                    
                        <td>like</td>
                    
                        <td>name like '%teddy bear%'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>case-insensitive like</td>
                    
                        <td>lower(name) like lower('%Teddy Bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>price between 4 and 8</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not between</td>
                    
                        <td>price not between 4 and 8</td>
                    
                <tr>
            
                <tr>
                    
                        <td>in</td>
                    
                        <td>price in (3.49, 9.49)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not in</td>
                    
                        <td>not in (3.49, 9.49)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>price < 4.99</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>price > 4.99</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>price <= 4.99</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>price >= 4.99</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is null</td>
                    
                        <td>state is null</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is not null</td>
                    
                        <td>state is not null</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><div class="alert alert-info" role="alert"><p>Neither SQL or HQL have a case-insensitive like operator, so it's simulated with the <code>lower()</code> function.</p>
</div>
</p>
<p><div class="alert alert-info" role="alert"><p>The <em>is null</em> and <em>is not null</em> restrictions above are from the <code>Address</code> domain class. I chose the <code>Address</code> domain class because the <code>Product</code> domain class doesnt have null-able properties.</p>
</div>
</p>
<h3>Collection associations</h3>
<p>HQL has a <code>size()</code> function which can be used to count the number of items in a GORM <em>hasMany</em> association, such as the <code>products</code> association in the <code>Vendor</code> class. For example, to query the <code>Vendor</code>s with more than two <code>Product</code>s, youd likely do something like this in SQL:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">v</span><span class="p">.</span><span class="n">id</span> 
</span><span class='line'><span class="k">FROM</span> <span class="n">vendor</span> <span class="k">as</span> <span class="n">v</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">product</span> <span class="k">as</span> <span class="n">p</span> <span class="k">ON</span> <span class="n">p</span><span class="p">.</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">v</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'><span class="k">HAVING</span> <span class="k">count</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>
<p>Lets try it. Run the query in the Grails console to get the <code>List</code> of <code>Vendor</code> IDs.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">session</span><span class="o">.</span><span class="na">createSQLQuery</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s2">    SELECT v.id </span>
</span><span class='line'><span class="s2">    FROM vendor as v INNER JOIN product as p ON p.vendor_id = v.id</span>
</span><span class='line'><span class="s2">    GROUP BY v.id</span>
</span><span class='line'><span class="s2">    HAVING count(p.id) &gt; 2</span>
</span><span class='line'><span class="s2">        &quot;&quot;&quot;</span><span class="o">).</span><span class="na">list</span><span class="o">()</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>
<p>The output is <code>[1, 3]</code>. With HQL you can accomplish the same thing using <code>size()</code>. Plus, you'll get <code>Vendor</code> instances instead of their IDs. Run the following HQL query and see for yourself.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">FROM</span> <span class="n">Vendor</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="k">size</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>
<p>The <code>size()</code> function does all the heavy lifting! Listed below are examples of restrictions using <code>size()</code>.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>HQL</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>size(products) = 0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>size(products) != 0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>size(products) < 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>size(products) > 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>size(products) >= 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>size(products) <= 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>size(products) between 3 and 5</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Isnt that cool! In fact, the <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/"><em>from clause</em></a> article in this series shows an example of using the <code>size(someProperty) = 0</code> restriction in place of a left outer join. It's certainly a handy function.</p>
<h2>Conjunctions</h2>
<p>When joining restrictions with <em>and</em> and <em>or</em>, HQL works exactly like the SQL youre used to. Enough with the trivial, lets move on to one of the most powerful GORM query methods: criteria queries.</p>
<h1>Criteria query</h1>
<p>Thus far the transition into GORM queries has been straight-forward. The minor differences between SQL and HQL make it so you can leverage what you already know about SQL. Criteria queries provide a more programmer-friendly approach to GORM queries. Instead of <em>declaring</em> queries as <code>String</code>s in your Groovy code, you can <em>build</em> them using Groovy. Take a look at the following comparison of a SQL query and its criteria query equivalent.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>SQL</th>
                    
                        <th>Criteria query</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td><span style="font-family: monospace">SELECT *                         </span></td>
                    
                        <td><span style="font-family: monospace"></span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">FROM product                     </span></td>
                    
                        <td><span style="font-family: monospace">Product.withCriteria {</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 inch teddy bear'</span></td>
                    
                        <td><span style="font-family: monospace">&nbsp;&nbsp;&nbsp;&nbsp;eq('name', '12 inch teddy bear')</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">&nbsp;</span></td>
                    
                        <td><span style="font-family: monospace">}</span></td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>In the listing above I aligned the lines of both queries so that each line's intent matches. Like with HQL, I'll skip over the equivalent of the <em>select</em> clause.</p>
<p>Criteria queries are created with a builder. The criteria query builder features methods used to assemble a query. The methods provide the means to specify restrictions, joins, sorting, etc. In the example above, <code>HibernateCriteriaBuilder.eq(String propertyName, Object value)</code> is used to add an equality restriction to the query.</p>
<h2>The builder</h2>
<p>The builder is actually a facade for a Hibernate <code>Criteria</code>. As such, it expects you to provide a <code>Closure</code> in which the builder methods are called.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">()</span>
</span><span class='line'><span class="kt">def</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">buildCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><code>GormEntity.createCriteria()</code> returns a <code>HibernateCriteriaBuilder</code>. Then, <code>HibernateCriteriaBuilder.buildCriteria(Closure)</code> executes the provided closure to assemble a Hibernate Criteria, which it then returns. To continue building the query after calling <code>buildCriteria(Closure)</code> you'd have to use the Hibernate Criteria methods.</p>
<p><div class="alert alert-info" role="alert"><p>The <code>buildCriteria(Closure)</code> <code>Closure</code>'s delegate is a <code>HibernateCriteriaBuilder</code>.</p>
</div>
</p>
<p>Unlike the traditional builder design pattern, a GORM criteria query does not allow you to call the builder methods directly. For example, the following code does not work:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">()</span>
</span><span class='line'>    
</span><span class='line'><span class="n">builder</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span> <span class="c1">// Throws IllegalArgumentException</span>
</span></code></pre></td></tr></table></div></figure>
<p><div class="alert alert-danger" role="alert">java.lang.IllegalArgumentException: Call to [eq] with propertyName [name] and value [12 inch teddy bear] not allowed here.</div>
</p>
<p><code>buildCriteria(Closure)</code> is seldom used because you're unlikely to use the Hibernate Criteria that it returns. Instead, criteria queries can be built <em>and</em> executed by the builder. Speaking of executing queries, lets do just that.</p>
<h2>Executing a criteria query</h2>
<p>Go ahead and run the following criteria query in the Grails console.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">products</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p><code>GormEntity.withCriteria(Closure)</code> does the following:</p>
<ol>
<li>Creates a <code>HibernateCriteriaBuilder</code>.</li>
<li>Uses the builder to assemble a Hibernate <code>Criteria</code>.</li>
<li>Executes the Criteria and returns the results.</li>
</ol>
<p>Lets do each step on its own so you can see what's happening.</p>
<h3>Create the builder</h3>
<p>First, create the <code>HibernateCriteriaBuilder</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>Now that you have a builder, use it to create a Hibernate <code>Criteria</code>.</p>
<h3>Build the query</h3>
<p>This is the point at which you actually create the query.</p>
<ol>
<li>First, call <code>buildCriteria(Closure)</code> on the builder.</li>
<li>Within the <code>Closure</code> call <code>eq(String propertyName, Object value)</code> to get the <code>Product</code> whose <code>name</code> (the property) is <code>'12 inch teddy bear'</code> (the value).</li>
</ol>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="kt">def</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">buildCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h3>Run the query</h3>
<p>Finally, run the query by calling <code>list()</code> on the <code>Criteria</code> instance.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="kt">def</span> <span class="n">products</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>Like the HQL query, the criteria query doesnt specify which domain properties to return. Instead it returns domain instances. The domain class on which the <code>withCriteria</code> method is executed determines which domain class instances to return.</p>
<p><div class="alert alert-info" role="alert"><p>A projection can be used to return other domain class instances and/or properties. The <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-select-clause/"><em>select clause</em></a> article is all about projections.</p>
</div>
</p>
<h3>Get first (or only) result</h3>
<p>Sometimes your query returns a single result. Or you want only the first result. Instead of retrieving the first element in the resulting list, you can...</p>
<ol>
<li>Create the builder with <code>createCriteria()</code>.</li>
<li>Call <code>HibernateCriteria.get(Closure)</code> to construct and execute the query.</li>
</ol>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">createCriteria</span><span class="o">().</span><span class="na">get</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">eq</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Restrictions</h2>
<p>Earlier, I listed various HQL restrictions. Here are their equivalents as criteria queries.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>SQL</th>
                    
                        <th>Criteria</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>name = 12 inch teddy bear</td>
                    
                        <td>eq('name', '12 inch teddy bear')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>name <> 12 inch teddy bear</td>
                    
                        <td>ne('name', '12 inch teddy bear')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>like</td>
                    
                        <td>name like '%teddy bear%'</td>
                    
                        <td>like('name', '%teddy bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>case-insensitive like</td>
                    
                        <td>lower(name) like lower('%Teddy Bear%')</td>
                    
                        <td>ilike('name', '%Teddy Bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>price between 4 and 8</td>
                    
                        <td>between('price', 4.0, 8.0)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not between</td>
                    
                        <td>price not between 4 and 8</td>
                    
                        <td>not { between('price', 4.0, 8.0) }</td>
                    
                <tr>
            
                <tr>
                    
                        <td>in</td>
                    
                        <td>price in (3.49, 9.49)</td>
                    
                        <td>inList('price', [3.49, 9.49])</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not in</td>
                    
                        <td>not in (3.49, 9.49)</td>
                    
                        <td>not { inList 'price', [3.49, 9.49] }</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>price < 4.99</td>
                    
                        <td>lt('price', 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>price > 4.99</td>
                    
                        <td>gt('price', 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>price <= 4.99</td>
                    
                        <td>le('price', 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>price >= 4.99</td>
                    
                        <td>ge('price', 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is null</td>
                    
                        <td>state is null</td>
                    
                        <td>isNull('state')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is not null</td>
                    
                        <td>state is not null</td>
                    
                        <td>isNotNull('state')</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Unlike HQL which uses expressions to create restrictions, criteria queries use method calls.</p>
<p>Like HQL, criteria queries provide a way to create restrictions based on the size of a collection. The table below compares some size-based HQL restrictions with their equivalents in a criteria query.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>HQL</th>
                    
                        <th>Criteria</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>size(products) = 0</td>
                    
                        <td>sizeEq('products', 0)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>size(products) != 0</td>
                    
                        <td>sizeNe('products', 0)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>size(products) < 3</td>
                    
                        <td>sizeLt('products', 3)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>size(products) > 3</td>
                    
                        <td>sizeGt('products', 3)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>size(products) >= 3</td>
                    
                        <td>sizeGe('products', 3)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>size(products) <= 3</td>
                    
                        <td>sizeLe('products', 3)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>size(products) between 3 and 5</td>
                    
                        <td>N/A</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Like the prior list of restrictions, criteria queries rely on method calls, not expressions. That's why there are multiple <em>size?(String propertyName, int value)</em> criteria methods and only one <code>size()</code> HQL function.</p>
<h3>What about between?</h3>
<p>You may have noticed that criteria queries do not have the equivalent of HQL's expression <code>size(products) between 3 and 5</code>. You can work around this by using <code>sizeGe()</code> along with <code>sizeLe()</code> for an inclusive <em>between</em>, and <code>sizeGt()</code> along with <code>sizeLt()</code> for exclusive <em>between</em>. Either approach requires an <em>and</em> conjunction. So lets look at some conjunctions.</p>
<h2>Conjunctions</h2>
<p>You may be wondering how criteria queries handle <em>and</em> and <em>or</em> conjunctions. For example, examine the where clause in the following SQL query.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span> <span class="k">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>
<p>The <em>like</em> and <em>greater than (>)</em> restrictions must both evaluate to <em>true</em> for a given record to be selected. Lets look at how you can express the same restrictions in a criteria query. Begin with a query with only a single restriction.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">like</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;%bear%&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Next, simply add the appropriate method call for the other restriction.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">like</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;%bear%&#39;</span><span class="o">)</span> <span class="c1">// This is the restriction you had already created. </span>
</span><span class='line'>    <span class="n">gt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">8.0</span><span class="o">)</span>       <span class="c1">// This is the new one. </span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>
<p>That's really all there is to it. By default, when a query contains more than one restriction they are joined by an <em>and</em> conjunction. An <em>and</em> conjunction is created with <code>HibernateCriteriaBuilder.and(Closure)</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">and</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">like</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;%bear%&#39;</span><span class="o">)</span>
</span><span class='line'>        <span class="n">gt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">8.0</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Similarly, an <em>or</em> conjunction is created with <code>HibernateCriteriaBuilder.or(Closure)</code>. Again, starting with SQL</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent criteria query is...</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">or</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">lt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">4.99</span><span class="o">)</span>
</span><span class='line'>        <span class="n">gt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">8.99</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>As you can see, restrictions built within the <code>or(Closure)</code> closure become the <em>or</em> conjunction. Finally, combining <em>and</em> with <em>or</em></p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">Product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="k">and</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent criteria query is</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">withCriteria</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">or</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">lt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">4.99</span><span class="o">)</span>
</span><span class='line'>        <span class="n">gt</span><span class="o">(</span><span class="s1">&#39;price&#39;</span><span class="o">,</span> <span class="mf">8.99</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    
</span><span class='line'>    <span class="n">like</span><span class="o">(</span><span class="s1">&#39;name&#39;</span><span class="o">,</span> <span class="s1">&#39;%bear%&#39;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Something that deluded me when I first learned about criteria queries is that they are not query definitions. They actually consist of Groovy code. In hindsight, I can't believe I overlooked this. But it means its possible to construct queries dynamically without resorting to the shenanigans you may be accustomed to with <code>String</code>s of SQL statements.  Up next is another builder approach to creating queries.</p>
<h1>Where query</h1>
<p>Like criteria queries, where queries use the builder design pattern. However, restrictions are created with Groovy expressions rather than builder method calls.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>SQL</th>
                    
                        <th>Where query</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td><span style="font-family: monospace">SELECT *</span></td>
                    
                        <td><span style="font-family: monospace"></span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">FROM product                         </span></td>
                    
                        <td><span style="font-family: monospace">Product.where {</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 inch teddy bear'    </span></td>
                    
                        <td><span style="font-family: monospace">&nbsp;&nbsp;&nbsp;&nbsp;name == '12 inch teddy bear'</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">&nbsp;</span></td>
                    
                        <td><span style="font-family: monospace">}.list()</span></td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p><code>GormEntity.where(Closure)</code> expects a closure in which Groovy expressions are used to create restrictions. <code>where(Closure)</code> returns a <code>DetachedCriteria</code>. Finally, <code>DetachedCriteria.list()</code> executes the query and returns the results.</p>
<p>In comparison to criteria queries, it's worth pointing out is that with criteria queries you specify the property name as a <code>String</code> (ex. 'name'), while in a where query the property is specified like any other Groovy property.</p>
<p>Now it's your turn to create a where query. In the Grails console, first prepare the <code>Closure</code> that will contain the query. Since you'll be querying the <code>Product</code> domain class, call <code>Product.where(Closure)</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Then, add the equality restriction comparing the <code>name</code> property to the <code>String</code> literal <code>'12 inch teddy bear'</code>. Its just a matter of using Groovy's equality (==) operator.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;12 inch teddy bear&#39;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Finally, execute the query by calling <code>DetachedCriteria.list()</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">builder</span><span class="o">.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Get first (or only) result</h2>
<p>Sometimes your query returns a single result. Or you want only the first result. Instead of retrieving the first element in the resulting list, you can call <code>DetachedCriteria.get()</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;12 inch teddy bear&#39;</span>
</span><span class='line'><span class="o">}.</span><span class="na">get</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<h2>Restrictions</h2>
<p>The following table lists various SQL restrictions and their equivalent where query restrictions.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>SQL</th>
                    
                        <th>Where query</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>name = 12 inch teddy bear</td>
                    
                        <td>name == '12 inch teddy bear'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>name <> 12 inch teddy bear</td>
                    
                        <td>name != '12 inch teddy bear'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>like</td>
                    
                        <td>name like '%teddy bear%'</td>
                    
                        <td>name ==~ '%teddy bear%'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>case-insensitive like</td>
                    
                        <td>lower(name) like lower('%Teddy Bear%')</td>
                    
                        <td>name =~ '%Teddy Bear%'</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>price between 4 and 8</td>
                    
                        <td>price in 4.0..8.0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not between</td>
                    
                        <td>price not between 4 and 8</td>
                    
                        <td>!(price in 4.0..8.0)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>in</td>
                    
                        <td>price in (3.49, 9.49)</td>
                    
                        <td>price in [3.49, 9.49]</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not in</td>
                    
                        <td>not in (3.49, 9.49)</td>
                    
                        <td>!(price in [3.49, 9.49])</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>price < 4.99</td>
                    
                        <td>price < 4.99 </td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>price > 4.99</td>
                    
                        <td>price > 4.99 </td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>price <= 4.99</td>
                    
                        <td>price <= 4.99 </td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>price >= 4.99</td>
                    
                        <td>price >= 4.99 </td>
                    
                <tr>
            
                <tr>
                    
                        <td>is null</td>
                    
                        <td>state is null</td>
                    
                        <td>state == null</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is not null</td>
                    
                        <td>state is not null</td>
                    
                        <td>state != null</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>Like HQL, and criteria queries, where queries can perform operations based on the size of a collection association. It's done with the <code>Collection.size()</code> method. The table below compares various size-based HQL restrictions with their where query equivalents.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>HQL</th>
                    
                        <th>Where</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>size(products) = 0</td>
                    
                        <td>products.size() == 0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>size(products) != 0</td>
                    
                        <td>products.size() != 0</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>size(products) < 3</td>
                    
                        <td>products.size() < 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>size(products) > 3</td>
                    
                        <td>products.size() > 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>size(products) >= 3</td>
                    
                        <td>products.size() >= 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>size(products) <= 3</td>
                    
                        <td>products.size() <= 3</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>size(products) between 3 and 5</td>
                    
                        <td>N/A</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<h3>Between is missing here too!</h3>
<p>Where queries also do not have the equivalent of HQL's expression <code>size(products) between 3 and 5</code>. You can work around this by using the <code>&gt;=</code> and <code>&lt;=</code> operators for an inclusive <em>between</em>, or <code>&gt;</code> and <code>&lt;</code> for exclusive <em>between</em>. An example of an inclusive <em>between</em> is: <code>products.size() &gt;= 3 &amp;&amp; products.size() &lt;= 5</code>. Either approach requires an <em>and</em> conjunction.</p>
<h2>Conjunctions</h2>
<p>Where queries handle <em>and</em> and <em>or</em> conjunctions using Groovy logical operators. When a query contains more than one restriction by default they are joined an <em>and</em> conjunction. For example, examine the where clause in the following SQL query.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span> <span class="k">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>
<p>Two conditions must be met to select a given product. The equivalent restriction can be expressed as a where query like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==~</span> <span class="s1">&#39;%bear%&#39;</span>
</span><span class='line'>    <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>Which can also be expressed using the <code>&amp;&amp;</code> operator like this:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==~</span> <span class="s1">&#39;%bear%&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>An <em>or</em> conjunction is created with the <code>||</code> operator. Again, starting with SQL</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent where query is as follows:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">price</span> <span class="o">&lt;</span> <span class="mf">4.99</span> <span class="o">||</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mf">8.99</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<p>As you can see, restrictions built within the <code>||</code> operator become the <em>or</em> conjunction. Finally, combining <em>and</em> with <em>or</em></p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">Product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="k">and</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent where query is</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">where</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">price</span> <span class="o">&lt;</span> <span class="mf">4.99</span> <span class="o">||</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mf">8.99</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">==~</span> <span class="s1">&#39;%bear%&#39;</span>
</span><span class='line'><span class="o">}.</span><span class="na">list</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>
<h1>Dynamic finder</h1>
<p>Dynamic finders provide a way to execute very simple queries.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>SQL</th>
                    
                        <th>Dynamic finder</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td><span style="font-family: monospace">SELECT *</span></td>
                    
                        <td><span style="font-family: monospace">&nbsp;</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">FROM product                         </span></td>
                    
                        <td><span style="font-family: monospace">Product.findAllByName('12 inch teddy bear')</span></td>
                    
                <tr>
            
                <tr>
                    
                        <td><span style="font-family: monospace">WHERE name = '12 inch teddy bear'    </span></td>
                    
                        <td><span style="font-family: monospace">&nbsp;</span></td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<p>A Dynamic finder is a domain class method following a specific naming convention. The term dynamic finder comes from the fact that the method doesnt actually exist. Thank you, Groovy MOP.</p>
<p>The method naming convention loosely defined is <em>domainClass.findAllByPropertyNameInCamelCaseWithAComparison(and, some, parameters)</em>.</p>
<p>Using the query above as an example...</p>
<ol>
<li><em>findAllBy</em> indicates that you want to execute a dynamic finder which returns one or more <code>Product</code>s.</li>
<li><em>Name</em> specifies the property.</li>
<li>The equals operator is used by default, so it's left unspecified.</li>
<li>'12 inch teddy bear' is the property value to compare against.</li>
</ol>
<p><div class="alert alert-info" role="alert"><p>The <code>findAllBy</code> dynamic finder is implemented by <code>FindAllByFinder</code>. A list of dynamic finders can be found in the property <code>GormEntity.gormDynamicFinders</code>.</p>
</div>
</p>
<p>Lets give a dynamic finder a go. Create a one to return <em>all</em> of the <code>Product</code>s with a <code>price</code> of <code>3.49</code>. In the Grails console, begin with the domain class and <code>findAllBy</code>.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllBy</span>
</span></code></pre></td></tr></table></div></figure>
<p>Next, append the property name in camel case.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllByPrice</span>
</span></code></pre></td></tr></table></div></figure>
<p>That completes the method name. Now you need to add the value <code>3.49</code> as a parameter.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllByPrice</span><span class="o">(</span><span class="mf">3.49</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>Finally, run it to see the three matching <code>Product</code>s.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">4</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">5</span><span class="o">,</span> 
</span><span class='line'>    <span class="n">com</span><span class="o">.</span><span class="na">emmanuelrosa</span><span class="o">.</span><span class="na">gormtut</span><span class="o">.</span><span class="na">Product</span> <span class="o">:</span> <span class="mi">6</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>
<h3>Get first (or only) result</h3>
<p>If your query returns a single result, or you only want to use the first result begin the dynamic finder method with <em>findBy</em> rather than <em>findAllBy</em>:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kt">def</span> <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="s1">&#39;12 inch teddy bear&#39;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>Like all the GORM queries discussed so far, the dynamic finder query does not specify the equivalent of a SELECT clause. In fact, dynamic finders do not support the notion. They always return a list of domain class instances.</p>
<h2>Restrictions</h2>
<p>The following table lists various SQL restrictions and the equivalent dynamic finder methods.</p>
<p><div class="panel panel-default">
    
    <div class="panel-body">
        <table class="table">
            <thead>
                <tr>
                    
                        <th>Description</th>
                    
                        <th>SQL</th>
                    
                        <th>Dynamic finder</th>
                    
                <tr>
            </thead>
            <tbody>
            
                <tr>
                    
                        <td>equality</td>
                    
                        <td>name = 12 inch teddy bear</td>
                    
                        <td>Product.findAllByName('12 inch teddy bear')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>inequality</td>
                    
                        <td>name <> 12 inch teddy bear</td>
                    
                        <td>Product.findAllByNameNotEqual('12 inch teddy bear')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>like</td>
                    
                        <td>name like '%teddy bear%'</td>
                    
                        <td>Product.findAllByNameLike('%teddy bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>case-insensitive like</td>
                    
                        <td>lower(name) like lower('%Teddy Bear%')</td>
                    
                        <td>Product.findAllByNameIlike('%Teddy Bear%')</td>
                    
                <tr>
            
                <tr>
                    
                        <td>between</td>
                    
                        <td>price between 4 and 8</td>
                    
                        <td>Product.findAllByPriceBetween(4, 8)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not between</td>
                    
                        <td>price not between 4 and 8</td>
                    
                        <td>N/A</td>
                    
                <tr>
            
                <tr>
                    
                        <td>in</td>
                    
                        <td>price in (3.49, 9.49)</td>
                    
                        <td>Product.findAllByPriceInList([3.49, 9.49])</td>
                    
                <tr>
            
                <tr>
                    
                        <td>not in</td>
                    
                        <td>not in (3.49, 9.49)</td>
                    
                        <td>N/A</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than</td>
                    
                        <td>price < 4.99</td>
                    
                        <td>Product.findAllByPriceLessThan( 4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than</td>
                    
                        <td>price > 4.99</td>
                    
                        <td>Product.findAllByPriceGreaterThan(4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>less than or equal to</td>
                    
                        <td>price <= 4.99</td>
                    
                        <td>Product.findAllByPriceLessThanEquals(4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>greater than or equal to</td>
                    
                        <td>price >= 4.99</td>
                    
                        <td>Product.findAllByPriceGreaterThanEquals(4.99)</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is null</td>
                    
                        <td>state is null</td>
                    
                        <td>Address.findAllByStateIsNull()</td>
                    
                <tr>
            
                <tr>
                    
                        <td>is not null</td>
                    
                        <td>state is not null</td>
                    
                        <td>Address.findAllByStateIsNotNull()</td>
                    
                <tr>
            
            </tbody>
        </table>
    </div>
</div>
</p>
<h2>Conjunctions</h2>
<p>Dynamic finders support <em>and</em> and <em>or</em> conjunctions, but without order of precedence. For example, examine the where clause in the following SQL query.</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span> 
</span><span class='line'><span class="k">WHERE</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span> <span class="k">and</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>
<p>The equivalent dynamic finder is</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllByNameLikeAndPriceGreaterThan</span><span class="o">(</span><span class="s1">&#39;%bear%&#39;</span><span class="o">,</span> <span class="mi">8</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>In the dynamic finder example above, the <em>NameLike</em> and <em>PriceGreaterThan</em> parts of the method are joined by an <em>And</em>. Then, the parameters are specified in the same order as the properties are declared in the method: <em>name</em>, then <em>price</em>.</p>
<p>An <em>or</em> conjunction works the same way:</p>
<figure class='code'><div class="highlight"><table><tr><td class='code'><pre><code class='groovy'><span class='line'><span class="n">Product</span><span class="o">.</span><span class="na">findAllByPriceLessThanOrPriceGreaterThan</span><span class="o">(</span><span class="mf">4.99</span><span class="o">,</span> <span class="mf">8.99</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
<p>Its possible to combine <em>and</em> and <em>or</em> as long as order of precedence is not important. For example, the following SQL query cannot be represented as a dynamic finder:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="o">*</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">product</span>
</span><span class='line'><span class="k">WHERE</span> <span class="p">(</span><span class="n">price</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">.</span><span class="mi">99</span> <span class="k">or</span> <span class="n">price</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="k">and</span> <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;%bear%&#39;</span>
</span></code></pre></td></tr></table></div></figure>
<h1>Conclusion</h1>
<p>That concludes this article in the GORM for SQLaddicts series. Now that you know how to construct the equivalent of a SQL <em>where</em> clause using a criteria query, where query, and dynamic finder, you're ready to tackle the equivalent of the <em>from</em> clause. <a href="http://emmanuelrosa.com/articles/gorm-for-sqladdicts-from-clause/">Ready?</a></p>
]]></content></entry></feed>